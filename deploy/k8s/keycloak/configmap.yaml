apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: auth9
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: auth-engine
    app.kubernetes.io/part-of: auth9
data:
  # Database configuration
  KC_DB: postgres
  KC_DB_URL_HOST: keycloak-postgres
  KC_DB_URL_PORT: "5432"
  KC_DB_URL_DATABASE: keycloak

  # Server configuration
  KC_HTTP_ENABLED: "true"
  # KC_HOSTNAME_URL sets the full base URL for Keycloak's issuer and frontend URLs.
  # This ensures the token issuer is always the public HTTPS URL, regardless of
  # whether requests arrive via cloudflared (browser) or internal K8s DNS (auth9-core).
  # Without this, internal requests get http://host:8080 as issuer, causing mismatch.
  KC_HOSTNAME_URL: "https://idp.auth9.example.com"
  KC_HOSTNAME_STRICT: "false"
  KC_HEALTH_ENABLED: "true"
  KC_METRICS_ENABLED: "true"
  KC_PROXY_HEADERS: xforwarded

  # Theme configuration - use auth9 for login, keycloak defaults for others
  KC_SPI_THEME_LOGIN_DEFAULT: auth9
  KC_SPI_THEME_EMAIL_DEFAULT: keycloak
  KC_SPI_THEME_ACCOUNT_DEFAULT: keycloak

  # Auth9 API URL for theme integration
  AUTH9_API_URL: http://auth9-core:8080

  # Keycloak event listener: ext-event-http (p2-inc/keycloak-events) pushes events to auth9-core webhook.
  KC_SPI_EVENTS_LISTENER_EXT_EVENT_HTTP_TARGET_URI: http://auth9-core:8080/api/v1/keycloak/events

  # Logging
  KC_LOG_LEVEL: INFO

  # Cluster configuration for Kubernetes
  # Use Infinispan with Kubernetes-based discovery
  KC_CACHE: ispn
  KC_CACHE_STACK: kubernetes
  # JGroups DNS_PING configuration for cluster discovery
  JAVA_OPTS_APPEND: "-Djgroups.dns.query=keycloak-headless.auth9.svc.cluster.local"
