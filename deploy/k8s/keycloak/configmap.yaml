apiVersion: v1
kind: ConfigMap
metadata:
  name: keycloak-config
  namespace: auth9
  labels:
    app.kubernetes.io/name: keycloak
    app.kubernetes.io/component: auth-engine
    app.kubernetes.io/part-of: auth9
data:
  # Database configuration
  KC_DB: postgres
  KC_DB_URL_HOST: keycloak-postgres
  KC_DB_URL_PORT: "5432"
  KC_DB_URL_DATABASE: keycloak

  # Server configuration
  KC_HTTP_ENABLED: "true"
  # KC_HOSTNAME ensures token issuer is always the public URL, allowing
  # auth9-core to use internal URL for API calls while tokens remain valid
  KC_HOSTNAME: idp-auth9.gitski.work
  KC_HOSTNAME_STRICT: "false"
  KC_HEALTH_ENABLED: "true"
  KC_METRICS_ENABLED: "true"
  KC_PROXY: edge

  # Theme configuration - use auth9 for login, keycloak defaults for others
  KC_SPI_THEME_LOGIN_DEFAULT: auth9
  KC_SPI_THEME_EMAIL_DEFAULT: keycloak
  KC_SPI_THEME_ACCOUNT_DEFAULT: keycloak

  # Auth9 API URL for theme integration
  AUTH9_API_URL: http://auth9-core:8080

  # Keycloak Events SPI configuration (p2-inc/keycloak-events v0.25+)
  # Events are sent to auth9-core for security monitoring and analytics
  KC_SPI_EVENTS_LISTENER_EXT_EVENT_HTTP_TARGET_URI: http://auth9-core:8080/api/v1/keycloak/events
  # Note: KC_SPI_EVENTS_LISTENER_EXT_EVENT_HTTP_HMAC_SECRET is set via keycloak-secrets

  # Logging
  KC_LOG_LEVEL: INFO

  # Cluster configuration for Kubernetes
  # Use Infinispan with Kubernetes-based discovery
  KC_CACHE: ispn
  KC_CACHE_STACK: kubernetes
  # JGroups DNS_PING configuration for cluster discovery
  JAVA_OPTS_APPEND: "-Djgroups.dns.query=keycloak-headless.auth9.svc.cluster.local"
