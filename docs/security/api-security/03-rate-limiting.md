# API å®‰å…¨ - é™æµä¸ DoS é˜²æŠ¤æµ‹è¯•

**æ¨¡å—**: API å®‰å…¨
**æµ‹è¯•èŒƒå›´**: é€Ÿç‡é™åˆ¶ã€èµ„æºè€—å°½é˜²æŠ¤
**åœºæ™¯æ•°**: 4
**é£é™©ç­‰çº§**: ğŸŸ  é«˜
**ASVS 5.0 çŸ©é˜µID**: M-API-03
**OWASP ASVS 5.0**: V4.4,V13.3,V2.5
**å›å½’ä»»åŠ¡æ˜ å°„**: Backlog #20

---

## èƒŒæ™¯çŸ¥è¯†

DoS æ”»å‡»å‘é‡ï¼š
- **è¯·æ±‚æ´ªæ°´**: å¤§é‡è¯·æ±‚è€—å°½æœåŠ¡å™¨èµ„æº
- **æ…¢é€Ÿæ”»å‡»**: Slowloris ç­‰é•¿è¿æ¥æ”»å‡»
- **èµ„æºè€—å°½**: CPUã€å†…å­˜ã€æ•°æ®åº“è¿æ¥
- **ä¸šåŠ¡é€»è¾‘æ»¥ç”¨**: æ˜‚è´µæ“ä½œçš„æ»¥ç”¨

Auth9 éœ€è¦ä¿æŠ¤çš„ç«¯ç‚¹ï¼š
- ç™»å½•ç«¯ç‚¹: é˜²æ­¢æš´åŠ›ç ´è§£
- Token Exchange: é˜²æ­¢æ»¥ç”¨
- æœç´¢/åˆ—è¡¨: é˜²æ­¢æ•°æ®æå–
- ç®¡ç†æ“ä½œ: é˜²æ­¢è‡ªåŠ¨åŒ–æ”»å‡»

---

## åœºæ™¯ 1ï¼šç™»å½•ç«¯ç‚¹é™æµ

### å‰ç½®æ¡ä»¶
- ç™»å½•ç«¯ç‚¹å¯è®¿é—®
- å‹åŠ›æµ‹è¯•å·¥å…·

### æ”»å‡»ç›®æ ‡
éªŒè¯ç™»å½•æ˜¯å¦æœ‰é€Ÿç‡é™åˆ¶

### æ”»å‡»æ­¥éª¤
1. å¿«é€Ÿå‘é€å¤šä¸ªç™»å½•è¯·æ±‚
2. æµ‹è¯•ä¸åŒç»´åº¦çš„é™åˆ¶ï¼š
   - å• IP é™åˆ¶
   - å•ç”¨æˆ·é™åˆ¶
   - å…¨å±€é™åˆ¶
3. æ£€æŸ¥é™æµå“åº”

### é¢„æœŸå®‰å…¨è¡Œä¸º
- IP çº§åˆ«: 10-20 æ¬¡/åˆ†é’Ÿ
- ç”¨æˆ·çº§åˆ«: 5 æ¬¡/åˆ†é’Ÿ (å¤±è´¥å)
- è¿”å› 429 Too Many Requests
- åŒ…å« Retry-After å¤´

### éªŒè¯æ–¹æ³•
```bash
# è¯´æ˜ï¼šAuth9 çš„ /api/v1/auth/token ä¸æ”¯æŒ grant_type=passwordã€‚
# è¿™é‡Œä»¥ OIDC æˆæƒå…¥å£ä½œä¸ºâ€œç™»å½•å‰å…¥å£â€è¿›è¡Œé™æµéªŒè¯ã€‚

# å¿«é€Ÿè¯·æ±‚æµ‹è¯•
for i in {1..50}; do
  curl -s -o /dev/null -w "%{http_code}\n" \
    "http://localhost:8080/api/v1/auth/authorize?client_id=auth9-portal&redirect_uri=http://localhost:3000/callback&response_type=code&scope=openid&state=rl-$i"
done
# é¢„æœŸ: å‰ N æ¬¡ 302/307, ä¹‹å 429

# æ£€æŸ¥å“åº”å¤´
curl -i \
  "http://localhost:8080/api/v1/auth/authorize?client_id=auth9-portal&redirect_uri=http://localhost:3000/callback&response_type=code&scope=openid&state=rl-head"
# æ£€æŸ¥ X-RateLimit-Limit, X-RateLimit-Remaining, Retry-After

# ä¸åŒ IP æµ‹è¯• (ä½¿ç”¨ä»£ç†)
# éªŒè¯ IP çº§åˆ«é™åˆ¶
```

### ä¿®å¤å»ºè®®
- å®ç°æ»‘åŠ¨çª—å£é™æµ
- IP + ç”¨æˆ·å ç»„åˆé™åˆ¶
- å¤±è´¥åå¢åŠ å»¶è¿Ÿ (æŒ‡æ•°é€€é¿)
- è¿”å›æ ‡å‡†é™æµå“åº”å¤´

---

## åœºæ™¯ 2ï¼šæ…¢é€Ÿæ”»å‡»é˜²æŠ¤

### å‰ç½®æ¡ä»¶
- èƒ½å¤Ÿå»ºç«‹ HTTP è¿æ¥
- slowloris æˆ–ç±»ä¼¼å·¥å…·

### æ”»å‡»ç›®æ ‡
éªŒè¯æœåŠ¡å™¨æ˜¯å¦é˜²æŠ¤æ…¢é€Ÿæ”»å‡»

### æ”»å‡»æ­¥éª¤
1. Slowloris æ”»å‡»ï¼š
   - å»ºç«‹å¤šä¸ªè¿æ¥
   - ç¼“æ…¢å‘é€è¯·æ±‚å¤´
   - ä¿æŒè¿æ¥ä¸å…³é—­
2. Slow POST æ”»å‡»ï¼š
   - å‘é€å¤§ Content-Length
   - ç¼“æ…¢å‘é€ body
3. æ£€æŸ¥æœåŠ¡å™¨å“åº”

### é¢„æœŸå®‰å…¨è¡Œä¸º
- è¯·æ±‚å¤„ç†è¶…æ—¶ (30 ç§’ï¼Œç”± `TimeoutLayer` å®ç°)
- è¯·æ±‚ä½“å¤§å°é™åˆ¶ (2MBï¼Œç”± `DefaultBodyLimit` å®ç°)
- å¹¶å‘è¯·æ±‚é™åˆ¶ (1024ï¼Œç”± `concurrency_limit` å®ç°)
- **Slowloris é˜²æŠ¤ï¼ˆè¯·æ±‚å¤´è¯»å–è¶…æ—¶ï¼‰ç”±åŸºç¡€è®¾æ–½å±‚æä¾›**ï¼ˆåå‘ä»£ç† / Ingress Controllerï¼‰

> **âš ï¸ æ¶æ„è¯´æ˜**: Slowloris é˜²æŠ¤ï¼ˆHTTP è¯·æ±‚å¤´è¯»å–è¶…æ—¶ï¼‰æ˜¯åŸºç¡€è®¾æ–½å±‚èŒè´£ã€‚
> `axum::serve()` çš„ `TimeoutLayer` ä»…é™åˆ¶ handler æ‰§è¡Œæ—¶é—´ï¼Œ**ä¸èƒ½**é™åˆ¶å®¢æˆ·ç«¯å‘é€è¯·æ±‚å¤´çš„æ—¶é—´ã€‚
>
> åœ¨ç”Ÿäº§éƒ¨ç½²ä¸­ï¼Œauth9-core è¿è¡Œåœ¨ Kubernetes Ingress Controller åæ–¹ï¼Œ
> Ingress Controller æä¾› `client_header_timeout`ã€`proxy_read_timeout` ç­‰ä¿æŠ¤ã€‚
>
> **åœ¨æœ¬åœ° Docker Compose å¼€å‘ç¯å¢ƒä¸­ç›´æ¥å¯¹ auth9-core ç«¯å£æµ‹è¯• Slowloris æ˜¯é¢„æœŸä¼š"é€šè¿‡"ï¼ˆä¸è¶…æ—¶ï¼‰çš„ï¼Œ
> å› ä¸ºå¼€å‘ç¯å¢ƒä¸éƒ¨ç½²åå‘ä»£ç†ã€‚è¿™ä¸ä»£è¡¨ç”Ÿäº§ç¯å¢ƒå­˜åœ¨æ¼æ´ã€‚**

### éªŒè¯æ–¹æ³•
```bash
# åº”ç”¨å±‚å·²æœ‰çš„é˜²æŠ¤éªŒè¯
# 1. è¯·æ±‚å¤„ç†è¶…æ—¶ (30s) - TimeoutLayer
# å¦‚æœ handler é˜»å¡è¶…è¿‡ 30sï¼Œè¿”å› 408

# 2. è¯·æ±‚ä½“å¤§å°é™åˆ¶ (2MB) - DefaultBodyLimit
dd if=/dev/zero bs=1M count=3 | curl -X POST -H "Content-Type: application/octet-stream" \
  --data-binary @- http://localhost:8080/api/v1/users
# é¢„æœŸ: 413 Payload Too Large

# 3. å¹¶å‘é™åˆ¶ (1024) - concurrency_limit
hey -n 2000 -c 1100 http://localhost:8080/api/v1/health
# é¢„æœŸ: éƒ¨åˆ†è¯·æ±‚è¿”å› 503

# Slowloris æµ‹è¯• (ä»…åœ¨æœ‰åå‘ä»£ç†çš„ç¯å¢ƒä¸­éªŒè¯)
# ç”Ÿäº§ç¯å¢ƒéœ€é€šè¿‡ Ingress Controller éªŒè¯:
# - client_header_timeout: 10-30s
# - proxy_read_timeout: 30-60s
# - limit_conn: å• IP è¿æ¥æ•°é™åˆ¶
```

### å¸¸è§è¯¯æŠ¥

| ç—‡çŠ¶ | åŸå›  | è§£å†³ |
|------|------|------|
| æ…¢é€Ÿå‘é€è¯·æ±‚å¤´åæœåŠ¡å™¨ä»æ­£å¸¸å“åº” | åœ¨æœ¬åœ° Docker ç¯å¢ƒç›´æ¥æµ‹è¯•ï¼Œæ— åå‘ä»£ç† | Slowloris é˜²æŠ¤ç”±ç”Ÿäº§ç¯å¢ƒ Ingress Controller æä¾›ï¼Œæœ¬åœ°ä¸é€‚ç”¨ |
| `TimeoutLayer` æœªé˜»æ­¢æ…¢é€Ÿè¯·æ±‚å¤´ | `TimeoutLayer` ä»…é™åˆ¶ handler å¤„ç†æ—¶é—´ | è®¾è®¡è¡Œä¸ºï¼Œå¤´éƒ¨è¯»å–è¶…æ—¶ç”±åŸºç¡€è®¾æ–½å±‚è´Ÿè´£ |

### ä¿®å¤å»ºè®®
- âœ… è¯·æ±‚å¤„ç†è¶…æ—¶: 30 ç§’ï¼ˆå·²å®ç°ï¼Œ`TimeoutLayer`ï¼‰
- âœ… è¯·æ±‚ä½“å¤§å°é™åˆ¶: 2MBï¼ˆå·²å®ç°ï¼Œ`DefaultBodyLimit`ï¼‰
- âœ… å¹¶å‘è¯·æ±‚é™åˆ¶: 1024ï¼ˆå·²å®ç°ï¼Œ`concurrency_limit`ï¼‰
- ç”Ÿäº§éƒ¨ç½²: ç¡®è®¤ Ingress Controller é…ç½®äº† `client_header_timeout` (10-30 ç§’)
- ç”Ÿäº§éƒ¨ç½²: ç¡®è®¤ Ingress Controller é…ç½®äº†å• IP è¿æ¥æ•°é™åˆ¶

---

## åœºæ™¯ 3ï¼šèµ„æºè€—å°½æ”»å‡»

### å‰ç½®æ¡ä»¶
- æœ‰æ•ˆçš„è®¤è¯ Token
- äº†è§£èµ„æºå¯†é›†å‹æ“ä½œ

### æ”»å‡»ç›®æ ‡
éªŒè¯èµ„æºå¯†é›†æ“ä½œçš„ä¿æŠ¤

### æ”»å‡»æ­¥éª¤
1. è¯†åˆ«è€—èµ„æºæ“ä½œï¼š
   - å¤æ‚æœç´¢æŸ¥è¯¢
   - å¤§é‡æ•°æ®å¯¼å‡º
   - æŠ¥è¡¨ç”Ÿæˆ
   - æ‰¹é‡æ“ä½œ
2. å¹¶å‘æ‰§è¡Œè¿™äº›æ“ä½œ
3. ç›‘æ§æœåŠ¡å™¨èµ„æº

### é¢„æœŸå®‰å…¨è¡Œä¸º
- æŸ¥è¯¢å¤æ‚åº¦é™åˆ¶
- å¯¼å‡ºæ•°é‡é™åˆ¶
- å¹¶å‘æ‰§è¡Œé™åˆ¶
- é˜Ÿåˆ—/å¼‚æ­¥å¤„ç†

### éªŒè¯æ–¹æ³•

> **âš ï¸ Token ç±»å‹è¯´æ˜**: ä»¥ä¸‹æµ‹è¯•ä¸­çš„ `$TOKEN` å¿…é¡»æ˜¯ **Tenant Access Token**ï¼ˆé€šè¿‡ token exchange è·å–ï¼‰ï¼Œä¸èƒ½æ˜¯ Identity Token æˆ– admin tokenã€‚ä½¿ç”¨é”™è¯¯çš„ token ç±»å‹ä¼šå¯¼è‡´ 403 æƒé™é”™è¯¯ï¼ˆè€Œéé™æµæµ‹è¯•ç›®æ ‡çš„ 429ï¼‰ã€‚
> è·å–æ–¹æ³•: å…ˆç”¨ Identity Token è°ƒç”¨ `POST /api/v1/auth/tenant-token` äº¤æ¢ Tenant Access Tokenã€‚

```bash
# å¤æ‚æœç´¢ï¼ˆéœ€ Tenant Access Tokenï¼‰
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?search=a*&include=roles,permissions,tenants"
# é¢„æœŸ: é™åˆ¶ include æ·±åº¦

# å¤§é‡å¯¼å‡ºï¼ˆlimit ä¼šè¢«è‡ªåŠ¨ cap åˆ° 100ï¼‰
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/audit-logs?limit=100000"
# é¢„æœŸ: per_page è¢« cap åˆ° 100ï¼Œè¿”å›æœ€å¤š 100 æ¡è®°å½•

# å¹¶å‘æ‰¹é‡æ“ä½œ
for i in {1..10}; do
  curl -X POST -H "Authorization: Bearer $TOKEN" \
    http://localhost:8080/api/v1/services/batch-create \
    -d '{"count":100}' &
done
# é¢„æœŸ: é™åˆ¶å¹¶å‘æˆ–æ’é˜Ÿ
```

### å¸¸è§è¯¯æŠ¥

| ç—‡çŠ¶ | åŸå›  | è§£å†³æ–¹æ³• |
|------|------|---------|
| è¿”å› 403 è€Œé 429 | ä½¿ç”¨äº† Identity Token æˆ– admin tokenï¼ˆæƒé™ä¸è¶³ï¼‰ | ä½¿ç”¨ Tenant Access Tokenï¼ˆé€šè¿‡ token exchange è·å–ï¼‰ |
| è¿”å› 401 | Token è¿‡æœŸæˆ–æ— æ•ˆ | é‡æ–°è·å–æœ‰æ•ˆ Token |

### ä¿®å¤å»ºè®®
- æŸ¥è¯¢è¶…æ—¶é™åˆ¶ (30ç§’)
- ç»“æœé›†å¤§å°é™åˆ¶
- åå°ä»»åŠ¡å¼‚æ­¥åŒ–
- èµ„æºé…é¢ç³»ç»Ÿ

---

## åœºæ™¯ 4ï¼šä¸šåŠ¡é€»è¾‘æ»¥ç”¨

### å‰ç½®æ¡ä»¶
- æœ‰æ•ˆè´¦æˆ·
- äº†è§£ä¸šåŠ¡æµç¨‹

### æ”»å‡»ç›®æ ‡
éªŒè¯ä¸šåŠ¡é€»è¾‘æ˜¯å¦å¯è¢«æ»¥ç”¨

### æ”»å‡»æ­¥éª¤
1. é‚®ä»¶å‘é€æ»¥ç”¨ï¼š
   - å¤§é‡å‘é€å¯†ç é‡ç½®é‚®ä»¶
   - å¤§é‡å‘é€é‚€è¯·é‚®ä»¶
2. çŸ­ä¿¡/é€šçŸ¥æ»¥ç”¨ï¼š
   - è§¦å‘å¤§é‡é€šçŸ¥
3. èµ„æºåˆ›å»ºæ»¥ç”¨ï¼š
   - åˆ›å»ºå¤§é‡ç§Ÿæˆ·/æœåŠ¡

### é¢„æœŸå®‰å…¨è¡Œä¸º
- é‚®ä»¶å‘é€é™åˆ¶
- é€šçŸ¥é¢‘ç‡é™åˆ¶
- èµ„æºåˆ›å»ºé…é¢
- CAPTCHA ä¿æŠ¤

### éªŒè¯æ–¹æ³•
```bash
# å¯†ç é‡ç½®æ»¥ç”¨
for i in {1..20}; do
  curl -X POST http://localhost:8080/api/v1/auth/forgot-password \
    -d '{"email":"victim@example.com"}'
  echo "Attempt: $i"
done
# é¢„æœŸ: 5 æ¬¡åé™æµæˆ– CAPTCHA

# é‚€è¯·å‘é€æ»¥ç”¨
for i in {1..50}; do
  curl -X POST -H "Authorization: Bearer $TOKEN" \
    http://localhost:8080/api/v1/tenants/{id}/invitations \
    -d "{\"email\":\"spam$i@example.com\"}"
done
# é¢„æœŸ: é™åˆ¶æ¯æ—¥é‚€è¯·æ•°é‡

# æ£€æŸ¥é‚®ä»¶æ—¥å¿—
# éªŒè¯æ˜¯å¦å‘é€äº†å¤§é‡é‚®ä»¶
```

### ä¿®å¤å»ºè®®
- é‚®ä»¶: æ¯ç”¨æˆ·æ¯å°æ—¶ 5 å°
- é‚€è¯·: æ¯ç§Ÿæˆ·æ¯æ—¥ 50 ä¸ª
- éœ€è¦ CAPTCHA éªŒè¯
- ç®¡ç†å‘˜å¯é…ç½®é™é¢

---

## æ£€æŸ¥æ¸…å•

| # | åœºæ™¯ | çŠ¶æ€ | æµ‹è¯•æ—¥æœŸ | æµ‹è¯•äººå‘˜ | å‘ç°é—®é¢˜ |
|---|------|------|----------|----------|----------|
| 1 | ç™»å½•ç«¯ç‚¹é™æµ | â˜ | | | |
| 2 | æ…¢é€Ÿæ”»å‡»é˜²æŠ¤ | â˜ | | | |
| 3 | èµ„æºè€—å°½æ”»å‡» | â˜ | | | |
| 4 | ä¸šåŠ¡é€»è¾‘æ»¥ç”¨ | â˜ | | | |

---

## æ¨èé™æµé…ç½®

| ç«¯ç‚¹ç±»å‹ | é™åˆ¶ | ç»´åº¦ |
|---------|------|------|
| ç™»å½• | 10/åˆ†é’Ÿ | IP + ç”¨æˆ·å |
| å¯†ç é‡ç½® | 3/å°æ—¶ | é‚®ç®± |
| Token Exchange | 100/åˆ†é’Ÿ | client_id |
| è¯»å– API | 100/åˆ†é’Ÿ | Token |
| å†™å…¥ API | 30/åˆ†é’Ÿ | Token |
| æœç´¢ API | 20/åˆ†é’Ÿ | Token |
| æ‰¹é‡æ“ä½œ | 5/åˆ†é’Ÿ | Token |
| æ–‡ä»¶ä¸Šä¼  | 10/åˆ†é’Ÿ | Token |

---

## æµ‹è¯•å·¥å…·

```bash
# hey - HTTP å‹åŠ›æµ‹è¯•
brew install hey
hey -n 1000 -c 50 http://localhost:8080/api/v1/users

# ab - Apache Bench
ab -n 1000 -c 50 http://localhost:8080/api/v1/users

# slowhttptest - æ…¢é€Ÿæ”»å‡»
brew install slowhttptest
slowhttptest -c 500 -H -u http://localhost:8080

# locust - Python è´Ÿè½½æµ‹è¯•
pip install locust
locust -f loadtest.py --host=http://localhost:8080
```

---

## å‚è€ƒèµ„æ–™

- [OWASP Rate Limiting](https://cheatsheetseries.owasp.org/cheatsheets/Denial_of_Service_Cheat_Sheet.html)
- [Cloudflare Rate Limiting](https://developers.cloudflare.com/waf/rate-limiting-rules/)
- [CWE-770: Resource Allocation Without Limits](https://cwe.mitre.org/data/definitions/770.html)
- [Slowloris Attack](https://en.wikipedia.org/wiki/Slowloris_(computer_security))

---


---

## æ ‡å‡†åŒ–å›å½’ Checklistï¼ˆASVS 5.0ï¼‰

**çŸ©é˜µID**: M-API-03  
**é€‚ç”¨æ§åˆ¶**: V4.4,V13.3,V2.5  
**å…³è”ä»»åŠ¡**: Backlog #20  
**å»ºè®®å›å½’é¢‘ç‡**: æ¯æ¬¡å‘å¸ƒå‰ + ç¼ºé™·ä¿®å¤åå¿…è·‘  
**åœºæ™¯æ€»æ•°**: 4

### æ‰§è¡Œæ¸…å•
- [ ] M-API-03-C01 | æ§åˆ¶: V4.4 | ä»»åŠ¡: #20 | åŠ¨ä½œ: æ‰§è¡Œæ–‡æ¡£å†…ç›¸å…³æ”»å‡»æ­¥éª¤å¹¶è®°å½•è¯æ®
- [ ] M-API-03-C02 | æ§åˆ¶: V13.3 | ä»»åŠ¡: #20 | åŠ¨ä½œ: æ‰§è¡Œæ–‡æ¡£å†…ç›¸å…³æ”»å‡»æ­¥éª¤å¹¶è®°å½•è¯æ®
- [ ] M-API-03-C03 | æ§åˆ¶: V2.5 | ä»»åŠ¡: #20 | åŠ¨ä½œ: æ‰§è¡Œæ–‡æ¡£å†…ç›¸å…³æ”»å‡»æ­¥éª¤å¹¶è®°å½•è¯æ®

### å›å½’è®°å½•è¡¨
| æ£€æŸ¥é¡¹ID | æ‰§è¡Œç»“æœ(pass/fail) | é£é™©ç­‰çº§ | è¯æ®ï¼ˆè¯·æ±‚/å“åº”/æ—¥å¿—/æˆªå›¾ï¼‰ | å¤‡æ³¨ |
|---|---|---|---|---|
|  |  |  |  |  |

### é€€å‡ºå‡†åˆ™
1. æ‰€æœ‰æ£€æŸ¥é¡¹æ‰§è¡Œå®Œæˆï¼Œä¸”é«˜é£é™©é¡¹æ—  `fail`ã€‚
2. å¦‚å­˜åœ¨ `fail`ï¼Œå¿…é¡»é™„å¸¦æ¼æ´å•å·ã€ä¿®å¤è®¡åˆ’å’Œå¤æµ‹ç»“è®ºã€‚
3. å›å½’æŠ¥å‘Šéœ€åŒæ—¶è®°å½•çŸ©é˜µIDä¸ Backlog ä»»åŠ¡å·ï¼Œä¾¿äºè·¨ç‰ˆæœ¬è¿½æº¯ã€‚
