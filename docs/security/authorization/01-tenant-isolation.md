# æˆæƒå®‰å…¨ - ç§Ÿæˆ·éš”ç¦»æµ‹è¯•

**æ¨¡å—**: æˆæƒå®‰å…¨
**æµ‹è¯•èŒƒå›´**: å¤šç§Ÿæˆ·æ•°æ®éš”ç¦»
**åœºæ™¯æ•°**: 4
**é£é™©ç­‰çº§**: ğŸ”´ æé«˜
**ASVS 5.0 çŸ©é˜µID**: M-AUTHZ-01
**OWASP ASVS 5.0**: V8.1,V8.2,V4.2
**å›å½’ä»»åŠ¡æ˜ å°„**: Backlog #2, #20


---

## èƒŒæ™¯çŸ¥è¯†

Auth9 æ˜¯å¤šç§Ÿæˆ·ç³»ç»Ÿï¼Œæ ¸å¿ƒéš”ç¦»è¦æ±‚ï¼š
- ç”¨æˆ·åªèƒ½è®¿é—®å…¶æ‰€å±ç§Ÿæˆ·çš„æ•°æ®
- ç§Ÿæˆ·ç®¡ç†å‘˜åªèƒ½ç®¡ç†æœ¬ç§Ÿæˆ·èµ„æº
- å¹³å°ç®¡ç†å‘˜å¯è·¨ç§Ÿæˆ·æ“ä½œ

å…³é”®æ•°æ®è¡¨ï¼š
- `tenants` - ç§Ÿæˆ·ä¿¡æ¯
- `tenant_users` - ç”¨æˆ·-ç§Ÿæˆ·å…³è”
- `services` - ç§Ÿæˆ·ä¸‹çš„æœåŠ¡
- `roles` / `permissions` - ç§Ÿæˆ·ä¸‹çš„ RBAC

> **âš ï¸ å…³é”®æµ‹è¯•è¦æ±‚ï¼šå¹³å°ç®¡ç†å‘˜ç»•è¿‡**
>
> `admin@auth9.local` æ˜¯é»˜è®¤å¹³å°ç®¡ç†å‘˜ï¼ˆç”± `PLATFORM_ADMIN_EMAILS` ç¯å¢ƒå˜é‡é…ç½®ï¼‰ã€‚
> **å¹³å°ç®¡ç†å‘˜åœ¨ç­–ç•¥å¼•æ“ä¸­æ‹¥æœ‰å…¨å±€ç»•è¿‡æƒé™**ï¼Œå¯ä»¥è·¨ç§Ÿæˆ·è®¿é—®æ‰€æœ‰æ•°æ®ã€åˆ›å»ºç§Ÿæˆ·ã€è®¿é—®ç³»ç»Ÿè®¾ç½®ç­‰ã€‚
> è¿™æ˜¯è®¾è®¡è¡Œä¸ºï¼Œä¸æ˜¯å®‰å…¨æ¼æ´ã€‚
>
> **æµ‹è¯•ç§Ÿæˆ·éš”ç¦»æ—¶ï¼Œå¿…é¡»ä½¿ç”¨éå¹³å°ç®¡ç†å‘˜è´¦å·ã€‚** ä½¿ç”¨ `admin@auth9.local` æµ‹è¯•ä¼šå¯¼è‡´æ‰€æœ‰éš”ç¦»æ£€æŸ¥è¢«ç»•è¿‡ï¼Œäº§ç”Ÿè¯¯æŠ¥ã€‚

---

## æ•…éšœæ’é™¤

| ç°è±¡ | åŸå›  | è§£å†³æ–¹æ³• |
|------|------|----------|
| æ‰€æœ‰è·¨ç§Ÿæˆ·è¯·æ±‚è¿”å› 200 è€Œé 403 | ä½¿ç”¨äº†å¹³å°ç®¡ç†å‘˜è´¦å·ï¼ˆå¦‚ `admin@auth9.local`ï¼‰ | åˆ›å»ºéå¹³å°ç®¡ç†å‘˜çš„æµ‹è¯•ç”¨æˆ·ï¼Œç”¨è¯¥ç”¨æˆ·çš„ token æµ‹è¯• |
| Token é‚®ç®±éç®¡ç†å‘˜ï¼Œä½†ä»ç»•è¿‡éš”ç¦» | Token çš„ `sub`ï¼ˆuser_idï¼‰å¤ç”¨äº†ç®¡ç†å‘˜ç”¨æˆ·çš„ IDï¼ŒDB æŸ¥è¯¢å‘ç°è¯¥ user_id åœ¨ auth9-platform ç§Ÿæˆ·ä¸­æœ‰ admin è§’è‰² | **Token çš„ user_id ä¹Ÿä¸èƒ½ä½¿ç”¨ç®¡ç†å‘˜ç”¨æˆ·çš„ ID**ã€‚ä½¿ç”¨éšæœº UUID æˆ–éç®¡ç†å‘˜ç”¨æˆ·çš„çœŸå® ID |
| Token æ—  tenant_id å´èƒ½è®¿é—®ç§Ÿæˆ·æ•°æ® | Identity Token è¢«å¹³å°ç®¡ç†å‘˜ç»•è¿‡è¯†åˆ« | ç¡®è®¤æµ‹è¯•è´¦å·ä¸åœ¨ `PLATFORM_ADMIN_EMAILS` åˆ—è¡¨ä¸­ |
| ç§Ÿæˆ·ç®¡ç†å‘˜èƒ½æ‰§è¡Œå¹³å°æ“ä½œ | è¯¥ç”¨æˆ·åŒæ—¶æ˜¯å¹³å°ç®¡ç†å‘˜ | æ£€æŸ¥ `PLATFORM_ADMIN_EMAILS` é…ç½®ï¼Œç¡®ä¿æµ‹è¯•ç”¨æˆ·ä¸åœ¨å…¶ä¸­ |

---

## åœºæ™¯ 1ï¼šè·¨ç§Ÿæˆ·æ•°æ®è®¿é—® (IDOR)

### å‰ç½®æ¡ä»¶
- **ç”¨æˆ· A å¿…é¡»æ˜¯éå¹³å°ç®¡ç†å‘˜**ï¼ˆé‚®ç®±ä¸åœ¨ `PLATFORM_ADMIN_EMAILS` ä¸­ï¼Œé»˜è®¤ä¸èƒ½æ˜¯ `admin@auth9.local`ï¼‰
- ç”¨æˆ· A å±äºç§Ÿæˆ· 1
- ç”¨æˆ· A ä¸å±äºç§Ÿæˆ· 2
- ç§Ÿæˆ· 2 å­˜åœ¨æ•°æ®

### æ”»å‡»ç›®æ ‡
éªŒè¯æ˜¯å¦å¯ä»¥è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„æ•°æ®

### æ”»å‡»æ­¥éª¤
1. ä»¥ç”¨æˆ· A èº«ä»½ç™»å½•
2. å°è¯•è®¿é—®ç§Ÿæˆ· 2 çš„èµ„æºï¼š
   - `GET /api/v1/tenants/{tenant_2_id}`
   - `GET /api/v1/tenants/{tenant_2_id}/users`
   - `GET /api/v1/services?tenant_id={tenant_2_id}`
3. å°è¯•æšä¸¾ç§Ÿæˆ· ID

### é¢„æœŸå®‰å…¨è¡Œä¸º
- è¿”å› 403 Forbidden
- ä¸æ³„éœ²ç§Ÿæˆ·æ˜¯å¦å­˜åœ¨
- å®¡è®¡æ—¥å¿—è®°å½•è®¿é—®å°è¯•

### éªŒè¯æ–¹æ³•
```bash
# è·å–ç”¨æˆ· A çš„ Token (å±äºç§Ÿæˆ· 1)
TOKEN_A="..."

# å°è¯•è®¿é—®ç§Ÿæˆ· 2
curl -H "Authorization: Bearer $TOKEN_A" \
  http://localhost:8080/api/v1/tenants/{tenant_2_id}
# é¢„æœŸ: 403 {"error": "Access denied"}

# å°è¯•åˆ—å‡ºç§Ÿæˆ· 2 çš„ç”¨æˆ·
curl -H "Authorization: Bearer $TOKEN_A" \
  http://localhost:8080/api/v1/tenants/{tenant_2_id}/users
# é¢„æœŸ: 403

# æ£€æŸ¥å®¡è®¡æ—¥å¿—
SELECT * FROM audit_logs
WHERE action = 'access_denied'
ORDER BY created_at DESC LIMIT 10;
```

### ä¿®å¤å»ºè®®
- æ‰€æœ‰ API æ£€æŸ¥ç§Ÿæˆ·å½’å±
- ä½¿ç”¨ JWT ä¸­çš„ tenant_id è€Œéè¯·æ±‚å‚æ•°
- å®ç°ç§Ÿæˆ·ä½œç”¨åŸŸä¸­é—´ä»¶
- è®°å½•æ‰€æœ‰è·¨ç§Ÿæˆ·è®¿é—®å°è¯•

---

## åœºæ™¯ 2ï¼šæ‰¹é‡æ“ä½œç§Ÿæˆ·æ³„éœ²

### å‰ç½®æ¡ä»¶
- **ç”¨æˆ·å¿…é¡»æ˜¯éå¹³å°ç®¡ç†å‘˜**ï¼ˆé‚®ç®±ä¸åœ¨ `PLATFORM_ADMIN_EMAILS` ä¸­ï¼Œé»˜è®¤ä¸èƒ½æ˜¯ `admin@auth9.local`ï¼‰
- ç”¨æˆ·æ‹¥æœ‰ demo ç§Ÿæˆ·çš„ Tenant Access Token
- **âš ï¸ ä¸¥ç¦ä½¿ç”¨ Platform Admin Token æµ‹è¯•æ­¤åœºæ™¯** â€” Platform Admin æ‹¥æœ‰å…¨å±€ç»•è¿‡æƒé™ï¼Œä¼šå¯¼è‡´æ‰€æœ‰åˆ—è¡¨ API è¿”å›å…¨é‡æ•°æ®ï¼Œäº§ç”Ÿè¯¯æŠ¥

### æ”»å‡»ç›®æ ‡
éªŒè¯åˆ—è¡¨ API æ˜¯å¦æ³„éœ²å…¶ä»–ç§Ÿæˆ·æ•°æ®

### æ”»å‡»æ­¥éª¤
1. è°ƒç”¨å„ç§åˆ—è¡¨ APIï¼š
   - `GET /api/v1/users`
   - `GET /api/v1/services`
   - `GET /api/v1/roles`
2. æ£€æŸ¥è¿”å›æ•°æ®æ˜¯å¦ä»…é™å½“å‰ç§Ÿæˆ·
3. å°è¯•é€šè¿‡åˆ†é¡µ/è¿‡æ»¤æšä¸¾å…¶ä»–ç§Ÿæˆ·æ•°æ®

> **æ³¨æ„**: `GET /api/v1/audit-logs` ä¸åœ¨æ­¤åœºæ™¯æµ‹è¯•èŒƒå›´å†…ã€‚å®¡è®¡æ—¥å¿— API åœ¨ç­–ç•¥å¼•æ“ä¸­è¦æ±‚ `PlatformAdmin` æƒé™ï¼ˆéå¹³å°ç®¡ç†å‘˜ä¼šæ”¶åˆ° 403ï¼‰ï¼Œä¸”å®¡è®¡æ—¥å¿—æŒ‰è®¾è®¡ä¸ºå…¨å±€å¯è§ï¼ˆæ—  tenant_id åˆ—ï¼‰ï¼Œä¸é€‚ç”¨ç§Ÿæˆ·éš”ç¦»æµ‹è¯•ã€‚

### é¢„æœŸå®‰å…¨è¡Œä¸º
- åˆ—è¡¨ API è‡ªåŠ¨è¿‡æ»¤ä¸ºå½“å‰ç§Ÿæˆ·
- ä¸è¿”å›å…¶ä»–ç§Ÿæˆ·çš„ä»»ä½•æ•°æ®
- åˆ†é¡µä¸æš´éœ²æ€»æ•°ä¿¡æ¯

### éªŒè¯æ–¹æ³•
```bash
# âš ï¸ å¿…é¡»ä½¿ç”¨é Platform Admin çš„æ™®é€šç§Ÿæˆ·ç”¨æˆ· Token
# å¯é€šè¿‡ gen-test-tokens.js ç”ŸæˆæŒ‡å®šç”¨æˆ·çš„ tenant-access token:
TENANT_ID="<demoç§Ÿæˆ·çš„ID>"
USER_ID="<éadminç”¨æˆ·çš„ID>"
TOKEN=$(.claude/skills/tools/gen-test-tokens.js tenant-access --tenant-id "$TENANT_ID" --user-id "$USER_ID")

# åˆ—å‡ºç”¨æˆ·
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/v1/users
# éªŒè¯: æ‰€æœ‰è¿”å›ç”¨æˆ·éƒ½å±äºå½“å‰ç§Ÿæˆ·

# åˆ—å‡ºæœåŠ¡
curl -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/v1/services
# éªŒè¯: æ‰€æœ‰è¿”å›æœåŠ¡éƒ½å±äºå½“å‰ç§Ÿæˆ·

# SQL éªŒè¯
SELECT COUNT(*) FROM (
  -- API è¿”å›çš„ç”¨æˆ· ID åˆ—è¡¨
) AS api_users
WHERE user_id NOT IN (
  SELECT user_id FROM tenant_users WHERE tenant_id = 'current_tenant'
);
# é¢„æœŸ: 0
```

### å¸¸è§è¯¯æŠ¥åŸå› 

| ç—‡çŠ¶ | åŸå›  | è§£å†³ |
|------|------|------|
| æ‰€æœ‰åˆ—è¡¨è¿”å›å…¨é‡æ•°æ® | ä½¿ç”¨äº† Platform Admin ç”¨æˆ·çš„ Token | æ¢ç”¨é Platform Admin çš„æ™®é€šç§Ÿæˆ·ç”¨æˆ·ï¼Œä½¿ç”¨ gen-test-tokens.js ç”Ÿæˆ |
| audit-logs è¿”å›æ‰€æœ‰æ—¥å¿— | å®¡è®¡æ—¥å¿—æ˜¯å¹³å°çº§èµ„æºï¼ŒæŒ‰è®¾è®¡å¯¹å¹³å°ç®¡ç†å‘˜å…¨å±€å¯è§ | æ­¤ API ä¸å±äºç§Ÿæˆ·éš”ç¦»æµ‹è¯•èŒƒå›´ |
| Token é‚®ç®±éç®¡ç†å‘˜ä½†ä»ç»•è¿‡éš”ç¦» | Token çš„ user_id å¤ç”¨äº†ç®¡ç†å‘˜ç”¨æˆ·çš„ ID | Token çš„ user_id ä¹Ÿä¸èƒ½ä½¿ç”¨ç®¡ç†å‘˜ç”¨æˆ·çš„ ID |

### ä¿®å¤å»ºè®®
- æ‰€æœ‰æŸ¥è¯¢é»˜è®¤æ·»åŠ ç§Ÿæˆ·è¿‡æ»¤
- Repository å±‚å¼ºåˆ¶ç§Ÿæˆ·éš”ç¦»
- ä½¿ç”¨ç§Ÿæˆ·ä½œç”¨åŸŸçš„æ•°æ®åº“è¿æ¥
- å•å…ƒæµ‹è¯•è¦†ç›–éš”ç¦»é€»è¾‘

---

## åœºæ™¯ 3ï¼šå…³è”èµ„æºè·¨ç§Ÿæˆ·è®¿é—®

### å‰ç½®æ¡ä»¶
- **ç”¨æˆ· A å¿…é¡»æ˜¯éå¹³å°ç®¡ç†å‘˜**ï¼ˆé‚®ç®±ä¸åœ¨ `PLATFORM_ADMIN_EMAILS` ä¸­ï¼‰
- ç”¨æˆ· A å±äºç§Ÿæˆ· 1
- ç§Ÿæˆ· 2 ä¸‹æœ‰æœåŠ¡ã€è§’è‰²ç­‰èµ„æº

### æ”»å‡»ç›®æ ‡
éªŒè¯å…³è”èµ„æºçš„è·¨ç§Ÿæˆ·è®¿é—®

### æ”»å‡»æ­¥éª¤
1. è·å–ç§Ÿæˆ· 2 çš„æœåŠ¡ ID
2. å°è¯•æ“ä½œè¯¥æœåŠ¡ï¼š
   - `GET /api/v1/services/{tenant_2_service_id}`
   - `PUT /api/v1/services/{tenant_2_service_id}`
   - `GET /api/v1/services/{tenant_2_service_id}/roles`
3. å°è¯•å°†è§’è‰²åˆ†é…ç»™ç§Ÿæˆ· 2 çš„ç”¨æˆ·

### é¢„æœŸå®‰å…¨è¡Œä¸º
- æ‰€æœ‰èµ„æºè®¿é—®æ£€æŸ¥ç§Ÿæˆ·å½’å±
- å…³è”æ“ä½œéªŒè¯åŒæ–¹ç§Ÿæˆ·ä¸€è‡´æ€§
- è¿”å› 403 æˆ– 404

### éªŒè¯æ–¹æ³•
```bash
# è®¿é—®å…¶ä»–ç§Ÿæˆ·çš„æœåŠ¡
curl -H "Authorization: Bearer $TOKEN_A" \
  http://localhost:8080/api/v1/services/{tenant_2_service_id}
# é¢„æœŸ: 403 æˆ– 404

# å°è¯•ä¸ºå…¶ä»–ç§Ÿæˆ·ç”¨æˆ·åˆ†é…è§’è‰²
curl -X POST -H "Authorization: Bearer $TOKEN_A" \
  http://localhost:8080/api/v1/rbac/assign \
  -d '{
    "user_id": "'$TENANT_2_USER_ID'",
    "tenant_id": "'$TENANT_1_ID'",
    "role_id": "'$ROLE_ID'"
  }'
# é¢„æœŸ: 400 "User not in tenant"
```

### ä¿®å¤å»ºè®®
- èµ„æºè®¿é—®å…ˆæŸ¥è¯¢å½’å±ç§Ÿæˆ·
- å…³è”æ“ä½œéªŒè¯æ‰€æœ‰å®ä½“ç§Ÿæˆ·ä¸€è‡´
- ä½¿ç”¨æ•°æ®åº“çº¦æŸæˆ–åº”ç”¨å±‚æ£€æŸ¥
- é˜²æ­¢ ID çŒœæµ‹ (ä½¿ç”¨ UUID)

---

## åœºæ™¯ 4ï¼šç®¡ç†å‘˜æƒé™è¾¹ç•Œæµ‹è¯•

### å‰ç½®æ¡ä»¶
- **ç§Ÿæˆ· 1 çš„ç®¡ç†å‘˜ï¼ˆéå¹³å°ç®¡ç†å‘˜ï¼‰**ï¼ˆé‚®ç®±ä¸åœ¨ `PLATFORM_ADMIN_EMAILS` ä¸­ï¼‰
- å¹³å°ç®¡ç†å‘˜ï¼ˆå¦‚ `admin@auth9.local`ï¼Œä»…ç”¨äºå¯¹æ¯”éªŒè¯ï¼‰

### æ”»å‡»ç›®æ ‡
éªŒè¯ä¸åŒç®¡ç†å‘˜çš„æƒé™è¾¹ç•Œ

### æ”»å‡»æ­¥éª¤
1. ç§Ÿæˆ·ç®¡ç†å‘˜å°è¯•ï¼š
   - è®¿é—®å…¶ä»–ç§Ÿæˆ·
   - åˆ›å»ºæ–°ç§Ÿæˆ·
   - è®¿é—®å¹³å°çº§è®¾ç½®
2. æ£€æŸ¥æƒé™è¾¹ç•Œæ˜¯å¦æ­£ç¡®

### é¢„æœŸå®‰å…¨è¡Œä¸º
- ç§Ÿæˆ·ç®¡ç†å‘˜ä»…èƒ½ç®¡ç†æœ¬ç§Ÿæˆ·
- å¹³å°ç®¡ç†å‘˜æ‰èƒ½åˆ›å»º/ç®¡ç†ç§Ÿæˆ·
- ç³»ç»Ÿè®¾ç½®ä»…å¹³å°ç®¡ç†å‘˜å¯è®¿é—®
- **é‚®ç®±é…ç½®å‹å¹³å°ç®¡ç†å‘˜ä½¿ç”¨ TenantAccess Tokenï¼ˆé€šè¿‡ token exchange è·å¾—ï¼‰ä¸èƒ½åˆ›å»º/åˆ é™¤ç§Ÿæˆ·**
  - ç§Ÿæˆ·åˆ›å»º/åˆ é™¤ä½¿ç”¨ `require_platform_admin_identity` ç­–ç•¥
  - é‚®ç®±å‹ç®¡ç†å‘˜ï¼ˆemail åœ¨ `PLATFORM_ADMIN_EMAILS` ä¸­ï¼‰ï¼šä»…æ¥å— Identity Token
  - **DB å‹ç®¡ç†å‘˜ï¼ˆauth9-platform ç§Ÿæˆ· admin è§’è‰²ï¼‰ï¼šå…è®¸ä»»ä½• Token ç±»å‹**ï¼ˆåŒ…æ‹¬ TenantAccess Tokenï¼‰ï¼Œè¿™æ˜¯è®¾è®¡è¡Œä¸º
  - æµ‹è¯•æ—¶éœ€åŒºåˆ†è¿™ä¸¤ç§ç®¡ç†å‘˜è·¯å¾„ï¼Œé¿å…è¯¯æŠ¥

### éªŒè¯æ–¹æ³•
```bash
# ç§Ÿæˆ·ç®¡ç†å‘˜å°è¯•åˆ›å»ºç§Ÿæˆ·ï¼ˆä½¿ç”¨ TenantAccess Tokenï¼‰
curl -s -o /dev/null -w "%{http_code}" \
  -X POST -H "Authorization: Bearer $TENANT_ADMIN_TOKEN" \
  -H "Content-Type: application/json" \
  http://localhost:8080/api/v1/tenants \
  -d '{"name":"New Tenant","slug":"new-tenant"}'
# é¢„æœŸ: 403 "Platform admin required"

# é‚®ç®±å‹å¹³å°ç®¡ç†å‘˜ä½¿ç”¨ TenantAccess Token å°è¯•åˆ›å»ºç§Ÿæˆ·
# ï¼ˆé‚®ç®±åœ¨ PLATFORM_ADMIN_EMAILS ä¸­ï¼Œä½†ä½¿ç”¨ TenantAccess Token æ—¶æ­¤è·¯å¾„è¢«æ‹’ç»ï¼‰
curl -s -o /dev/null -w "%{http_code}" \
  -X POST -H "Authorization: Bearer $PLATFORM_ADMIN_TENANT_TOKEN" \
  -H "Content-Type: application/json" \
  http://localhost:8080/api/v1/tenants \
  -d '{"name":"New Tenant","slug":"new-tenant"}'
# é¢„æœŸ: 403 "Platform admin required"
# âš ï¸ æ³¨æ„: å¦‚æœè¯¥ç”¨æˆ·åŒæ—¶æ˜¯ auth9-platform ç§Ÿæˆ·çš„ adminï¼ˆDB å‹ç®¡ç†å‘˜ï¼‰ï¼Œ
# åˆ™ DB è·¯å¾„å…è®¸ TenantAccess Token åˆ›å»ºç§Ÿæˆ·ï¼ˆè¿”å› 201ï¼‰ã€‚è¿™æ˜¯è®¾è®¡è¡Œä¸ºï¼Œä¸æ˜¯æ¼æ´ã€‚
# æµ‹è¯•æ­¤åœºæ™¯æ—¶ï¼Œ$PLATFORM_ADMIN_TENANT_TOKEN çš„ user_id ä¸èƒ½æ˜¯ auth9-platform adminã€‚

# å¹³å°ç®¡ç†å‘˜ä½¿ç”¨ Identity Token åˆ›å»ºç§Ÿæˆ·ï¼ˆæ­£ç¡®æ–¹å¼ï¼‰
curl -s -o /dev/null -w "%{http_code}" \
  -X POST -H "Authorization: Bearer $PLATFORM_ADMIN_IDENTITY_TOKEN" \
  -H "Content-Type: application/json" \
  http://localhost:8080/api/v1/tenants \
  -d '{"name":"New Tenant","slug":"new-tenant"}'
# é¢„æœŸ: 201 Created

# ç§Ÿæˆ·ç®¡ç†å‘˜å°è¯•è®¿é—®ç³»ç»Ÿè®¾ç½®
# âš ï¸ å¿…é¡»ä½¿ç”¨éå¹³å°ç®¡ç†å‘˜çš„ç§Ÿæˆ·ç®¡ç†å‘˜ Token
# DB å‹ç®¡ç†å‘˜ï¼ˆauth9-platform ç§Ÿæˆ· admin è§’è‰²ï¼‰å¯é€šè¿‡ä»»ä½• Token ç±»å‹è®¿é—®ç³»ç»Ÿè®¾ç½®ï¼Œè¿”å› 200ï¼ˆè®¾è®¡è¡Œä¸ºï¼‰
curl -s -o /dev/null -w "%{http_code}" \
  -H "Authorization: Bearer $TENANT_ADMIN_TOKEN" \
  http://localhost:8080/api/v1/system/email
# é¢„æœŸ: 403ï¼ˆä»…å½“ç”¨æˆ·ä¸æ˜¯ DB å‹ç®¡ç†å‘˜æ—¶ï¼‰
# âš ï¸ å¦‚æœè¿”å› 200: æ£€æŸ¥è¯¥ç”¨æˆ·æ˜¯å¦åœ¨ auth9-platform ç§Ÿæˆ·ä¸­æœ‰ admin è§’è‰²
```

### ä¿®å¤å»ºè®®
- æ˜ç¡®å®šä¹‰æƒé™å±‚çº§
- API å±‚æ£€æŸ¥è°ƒç”¨è€…è§’è‰²
- æ•æ„Ÿç«¯ç‚¹æ·»åŠ é¢å¤–æ ¡éªŒ
- å®Œå–„æƒé™çŸ©é˜µæ–‡æ¡£

---

## æ£€æŸ¥æ¸…å•

| # | åœºæ™¯ | çŠ¶æ€ | æµ‹è¯•æ—¥æœŸ | æµ‹è¯•äººå‘˜ | å‘ç°é—®é¢˜ |
|---|------|------|----------|----------|----------|
| 1 | è·¨ç§Ÿæˆ·æ•°æ®è®¿é—® (IDOR) | â˜ | | | |
| 2 | æ‰¹é‡æ“ä½œç§Ÿæˆ·æ³„éœ² | â˜ | | | |
| 3 | å…³è”èµ„æºè·¨ç§Ÿæˆ·è®¿é—® | â˜ | | | |
| 4 | ç®¡ç†å‘˜æƒé™è¾¹ç•Œæµ‹è¯• | â˜ | | | |

---

## å‚è€ƒèµ„æ–™

- [OWASP IDOR Prevention](https://cheatsheetseries.owasp.org/cheatsheets/Insecure_Direct_Object_Reference_Prevention_Cheat_Sheet.html)
- [CWE-639: Authorization Bypass Through User-Controlled Key](https://cwe.mitre.org/data/definitions/639.html)
- [Multi-tenancy Security Best Practices](https://docs.microsoft.com/en-us/azure/architecture/guide/multitenant/considerations/security)

---


---

## æ ‡å‡†åŒ–å›å½’ Checklistï¼ˆASVS 5.0ï¼‰

**çŸ©é˜µID**: M-AUTHZ-01  
**é€‚ç”¨æ§åˆ¶**: V8.1,V8.2,V4.2  
**å…³è”ä»»åŠ¡**: Backlog #2, #20  
**å»ºè®®å›å½’é¢‘ç‡**: æ¯æ¬¡å‘å¸ƒå‰ + ç¼ºé™·ä¿®å¤åå¿…è·‘  
**åœºæ™¯æ€»æ•°**: 4

### æ‰§è¡Œæ¸…å•
- [ ] M-AUTHZ-01-C01 | æ§åˆ¶: V8.1 | ä»»åŠ¡: #2, #20 | åŠ¨ä½œ: æ‰§è¡Œæ–‡æ¡£å†…ç›¸å…³æ”»å‡»æ­¥éª¤å¹¶è®°å½•è¯æ®
- [ ] M-AUTHZ-01-C02 | æ§åˆ¶: V8.2 | ä»»åŠ¡: #2, #20 | åŠ¨ä½œ: æ‰§è¡Œæ–‡æ¡£å†…ç›¸å…³æ”»å‡»æ­¥éª¤å¹¶è®°å½•è¯æ®
- [ ] M-AUTHZ-01-C03 | æ§åˆ¶: V4.2 | ä»»åŠ¡: #2, #20 | åŠ¨ä½œ: æ‰§è¡Œæ–‡æ¡£å†…ç›¸å…³æ”»å‡»æ­¥éª¤å¹¶è®°å½•è¯æ®

### å›å½’è®°å½•è¡¨
| æ£€æŸ¥é¡¹ID | æ‰§è¡Œç»“æœ(pass/fail) | é£é™©ç­‰çº§ | è¯æ®ï¼ˆè¯·æ±‚/å“åº”/æ—¥å¿—/æˆªå›¾ï¼‰ | å¤‡æ³¨ |
|---|---|---|---|---|
|  |  |  |  |  |

### é€€å‡ºå‡†åˆ™
1. æ‰€æœ‰æ£€æŸ¥é¡¹æ‰§è¡Œå®Œæˆï¼Œä¸”é«˜é£é™©é¡¹æ—  `fail`ã€‚
2. å¦‚å­˜åœ¨ `fail`ï¼Œå¿…é¡»é™„å¸¦æ¼æ´å•å·ã€ä¿®å¤è®¡åˆ’å’Œå¤æµ‹ç»“è®ºã€‚
3. å›å½’æŠ¥å‘Šéœ€åŒæ—¶è®°å½•çŸ©é˜µIDä¸ Backlog ä»»åŠ¡å·ï¼Œä¾¿äºè·¨ç‰ˆæœ¬è¿½æº¯ã€‚
