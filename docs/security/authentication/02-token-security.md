# è®¤è¯å®‰å…¨ - JWT Token å®‰å…¨æµ‹è¯•

**æ¨¡å—**: è®¤è¯å®‰å…¨
**æµ‹è¯•èŒƒå›´**: JWT Token ç­¾å‘ã€éªŒè¯å’Œå­˜å‚¨å®‰å…¨
**åœºæ™¯æ•°**: 3
**é£é™©ç­‰çº§**: ğŸ”´ æé«˜

---

## èƒŒæ™¯çŸ¥è¯†

Auth9 ä½¿ç”¨ä¸¤ç§ Tokenï¼š
- **Identity Token**: ç”¨æˆ·èº«ä»½å‡­è¯ï¼ŒåŒ…å«åŸºç¡€ç”¨æˆ·ä¿¡æ¯
- **Tenant Access Token**: Token Exchange åè·å¾—ï¼ŒåŒ…å«ç§Ÿæˆ·è§’è‰²å’Œæƒé™

Token ç»“æ„ç¤ºä¾‹ï¼š
```json
{
  "iss": "https://auth9.example.com",
  "sub": "user-uuid",
  "aud": "service-client-id",
  "exp": 1234567890,
  "tenant_id": "tenant-uuid",
  "roles": ["editor"],
  "permissions": ["user:read", "user:write"]
}
```

---

## åœºæ™¯ 1ï¼šJWT ç­¾åç®—æ³•æ··æ·†æ”»å‡»

### å‰ç½®æ¡ä»¶
- è·å–ä¸€ä¸ªæœ‰æ•ˆçš„ JWT Token

### æ”»å‡»ç›®æ ‡
éªŒè¯æ˜¯å¦å¯ä»¥é€šè¿‡ç®—æ³•æ··æ·†æ”»å‡»ä¼ªé€  Token

### æ”»å‡»æ­¥éª¤
1. è§£ç è·å–çš„ JWT Token
2. å°è¯•ä»¥ä¸‹æ”»å‡»ï¼š
   - å°† `alg` æ”¹ä¸º `none`
   - å°† RS256 æ”¹ä¸º HS256 (ç”¨å…¬é’¥ä½œä¸ºå¯†é’¥ç­¾å)
   - å°† `alg` æ”¹ä¸ºä¸æ”¯æŒçš„ç®—æ³•
3. ä½¿ç”¨ä¿®æ”¹åçš„ Token è®¿é—® API

### é¢„æœŸå®‰å…¨è¡Œä¸º
- æœåŠ¡ç«¯åº”éªŒè¯ç®—æ³•ç™½åå•
- `alg: none` åº”è¢«æ‹’ç»
- ç®—æ³•ä¸åŒ¹é…åº”è¿”å› 401

### éªŒè¯æ–¹æ³•
```bash
# åŸå§‹ Token
TOKEN="eyJhbGciOiJSUzI1NiIsInR5cCI6IkpXVCJ9..."

# æ„é€  alg:none çš„ Token
# Header: {"alg":"none","typ":"JWT"}
# Payload: {...åŸå§‹å†…å®¹...}
# Signature: (ç©º)

FORGED_TOKEN="eyJhbGciOiJub25lIiwidHlwIjoiSldUIn0.{payload}."

curl -H "Authorization: Bearer $FORGED_TOKEN" \
  http://localhost:8080/api/v1/users
# é¢„æœŸ: 401 Unauthorized
```

### ä¿®å¤å»ºè®®
- æ˜ç¡®é…ç½®å…è®¸çš„ç®—æ³•ç™½åå•
- ç¦ç”¨ `none` ç®—æ³•
- éªŒè¯æ—¶æŒ‡å®šæœŸæœ›çš„ç®—æ³•
- ä½¿ç”¨éå¯¹ç§°ç­¾å (RS256/ES256)

---

## åœºæ™¯ 2ï¼šJWT å¯†é’¥æ³„éœ²æµ‹è¯•

### å‰ç½®æ¡ä»¶
- ç³»ç»Ÿè¿è¡Œä¸­
- èƒ½å¤Ÿè®¿é—®å„ç§ç«¯ç‚¹

### æ”»å‡»ç›®æ ‡
æ£€æµ‹ JWT ç­¾åå¯†é’¥æ˜¯å¦å¯èƒ½æ³„éœ²

### æ”»å‡»æ­¥éª¤
1. æ£€æŸ¥ä»¥ä¸‹æ½œåœ¨æ³„éœ²ç‚¹ï¼š
   - é”™è¯¯å“åº”ä¸­æ˜¯å¦åŒ…å«å¯†é’¥ä¿¡æ¯
   - `/.well-known/jwks.json` æ˜¯å¦åŒ…å«ç§é’¥
   - é…ç½®ç«¯ç‚¹æ˜¯å¦æš´éœ²å¯†é’¥
   - æ—¥å¿—æ–‡ä»¶æ˜¯å¦è®°å½•å¯†é’¥
2. å°è¯•é€šè¿‡å¼±å¯†é’¥æš´åŠ›ç ´è§£ (HS256)
3. æ£€æŸ¥å¯†é’¥è½®æ¢æœºåˆ¶

### é¢„æœŸå®‰å…¨è¡Œä¸º
- JWKS ç«¯ç‚¹ä»…æš´éœ²å…¬é’¥
- é”™è¯¯ä¿¡æ¯ä¸æ³„éœ²å¯†é’¥
- ä½¿ç”¨è¶³å¤Ÿå¼ºåº¦çš„å¯†é’¥ (>= 256 bits)

### éªŒè¯æ–¹æ³•
```bash
# æ£€æŸ¥ JWKS ç«¯ç‚¹
curl http://localhost:8080/.well-known/jwks.json | jq .
# ç¡®è®¤ä»…åŒ…å« "kty", "n", "e" (å…¬é’¥éƒ¨åˆ†)
# ä¸åº”åŒ…å« "d", "p", "q" (ç§é’¥éƒ¨åˆ†)

# å¯¹äº HS256ï¼Œå°è¯•å¼±å¯†é’¥
# ä½¿ç”¨ jwt-cracker æˆ– hashcat
```

### ä¿®å¤å»ºè®®
- ä½¿ç”¨éå¯¹ç§°åŠ å¯† (RS256/ES256)
- JWKS ä»…æš´éœ²å…¬é’¥
- å¯†é’¥å­˜å‚¨åœ¨å®‰å…¨ä½ç½® (K8s Secrets, Vault)
- å®ç°å¯†é’¥è½®æ¢

---

## åœºæ™¯ 3ï¼šToken å£°æ˜ç¯¡æ”¹

### å‰ç½®æ¡ä»¶
- æœ‰æ•ˆçš„ JWT Token

### æ”»å‡»ç›®æ ‡
éªŒè¯æ˜¯å¦å¯ä»¥ç¯¡æ”¹ Token ä¸­çš„ claims

### æ”»å‡»æ­¥éª¤
1. è§£ç  JWT Token
2. å°è¯•ä¿®æ”¹ä»¥ä¸‹ claimsï¼š
   - `sub` - æ›´æ”¹ä¸ºå…¶ä»–ç”¨æˆ· ID
   - `tenant_id` - æ›´æ”¹ä¸ºå…¶ä»–ç§Ÿæˆ·
   - `roles` - æ·»åŠ  `admin` è§’è‰²
   - `permissions` - æ·»åŠ é¢å¤–æƒé™
   - `exp` - å»¶é•¿è¿‡æœŸæ—¶é—´
3. é‡æ–°ç­¾å (å¦‚æœæœ‰å¯†é’¥) æˆ–ç›´æ¥ä½¿ç”¨

### é¢„æœŸå®‰å…¨è¡Œä¸º
- ä»»ä½•ç¯¡æ”¹éƒ½åº”å¯¼è‡´ç­¾åéªŒè¯å¤±è´¥
- è¿”å› 401 é”™è¯¯

### éªŒè¯æ–¹æ³•
```bash
# ä½¿ç”¨ jwt.io æˆ–è„šæœ¬ä¿®æ”¹ payload
# ä¿®æ”¹ roles: ["admin"]
# é‡æ–°ç¼–ç ä½†ä¿æŒåŸç­¾å

TAMPERED_TOKEN="eyJ...tampered_payload...original_signature"

curl -H "Authorization: Bearer $TAMPERED_TOKEN" \
  http://localhost:8080/api/v1/tenants
# é¢„æœŸ: 401 {"error": "invalid_signature"}
```

### ä¿®å¤å»ºè®®
- å§‹ç»ˆéªŒè¯ç­¾å
- æœåŠ¡ç«¯éªŒè¯ claims åˆç†æ€§
- æ•æ„Ÿæ“ä½œä»æ•°æ®åº“é‡æ–°è·å–æƒé™

---

## æ£€æŸ¥æ¸…å•

| # | åœºæ™¯ | çŠ¶æ€ | æµ‹è¯•æ—¥æœŸ | æµ‹è¯•äººå‘˜ | å‘ç°é—®é¢˜ |
|---|------|------|----------|----------|----------|
| 1 | JWT ç­¾åç®—æ³•æ··æ·†æ”»å‡» | â˜ | | | |
| 2 | JWT å¯†é’¥æ³„éœ²æµ‹è¯• | â˜ | | | |
| 3 | Token å£°æ˜ç¯¡æ”¹ | â˜ | | | |

---

## å‚è€ƒèµ„æ–™

- [RFC 7519 - JWT](https://datatracker.ietf.org/doc/html/rfc7519)
- [JWT Security Best Practices](https://curity.io/resources/learn/jwt-best-practices/)
- [CWE-347: Improper Verification of Cryptographic Signature](https://cwe.mitre.org/data/definitions/347.html)
- [Auth0 JWT Handbook](https://auth0.com/resources/ebooks/jwt-handbook)
