# è®¤è¯å®‰å…¨ - å¯†ç å®‰å…¨æµ‹è¯•

**æ¨¡å—**: è®¤è¯å®‰å…¨
**æµ‹è¯•èŒƒå›´**: å¯†ç ç­–ç•¥ã€å­˜å‚¨å’Œé‡ç½®å®‰å…¨
**åœºæ™¯æ•°**: 4
**é£é™©ç­‰çº§**: ğŸŸ  é«˜

---

## èƒŒæ™¯çŸ¥è¯†

Auth9 å¯†ç ç®¡ç†ç”± Keycloak å¤„ç†ï¼š
- å¯†ç å“ˆå¸Œ: Argon2 æˆ– PBKDF2
- å¯†ç é‡ç½®: é€šè¿‡é‚®ä»¶é“¾æ¥
- å¯†ç ç­–ç•¥: å¯é…ç½®å¼ºåº¦è¦æ±‚

---

## åœºæ™¯ 1ï¼šå¯†ç æš´åŠ›ç ´è§£é˜²æŠ¤

### å‰ç½®æ¡ä»¶
- å·²çŸ¥ç”¨æˆ·å

### æ”»å‡»ç›®æ ‡
éªŒè¯ç™»å½•æ˜¯å¦å­˜åœ¨æš´åŠ›ç ´è§£é£é™©

### æ”»å‡»æ­¥éª¤
1. ä½¿ç”¨æœ‰æ•ˆç”¨æˆ·å
2. è‡ªåŠ¨åŒ–æäº¤é”™è¯¯å¯†ç  (å¦‚ 1000 æ¬¡)
3. æµ‹è¯•ä¸åŒ IP åœ°å€çš„è¡Œä¸º
4. æ£€æŸ¥è´¦æˆ·é”å®šå’Œè§£é”æœºåˆ¶

### é¢„æœŸå®‰å…¨è¡Œä¸º
- è¿ç»­å¤±è´¥åè´¦æˆ·ä¸´æ—¶é”å®š
- IP çº§åˆ«çš„é€Ÿç‡é™åˆ¶
- ä¸æ³„éœ²ç”¨æˆ·æ˜¯å¦å­˜åœ¨

### éªŒè¯æ–¹æ³•
```bash
# è‡ªåŠ¨åŒ–ç™»å½•æµ‹è¯•
for i in {1..50}; do
  curl -X POST http://localhost:8081/realms/auth9/protocol/openid-connect/token \
    -d "grant_type=password" \
    -d "client_id=auth9-portal" \
    -d "username=admin@test.com" \
    -d "password=wrong_$i"
  echo "Attempt: $i"
done

# æ£€æŸ¥å“åº”å˜åŒ–
# é¢„æœŸ: ç¬¬ N æ¬¡åè¿”å› "Account locked" æˆ–å¢åŠ å»¶è¿Ÿ
```

### ä¿®å¤å»ºè®®
- 5 æ¬¡å¤±è´¥åé”å®š 15 åˆ†é’Ÿ
- æ¸è¿›å¼å»¶è¿Ÿ (æŒ‡æ•°é€€é¿)
- IP çº§åˆ«é™åˆ¶: 100 æ¬¡/åˆ†é’Ÿ
- CAPTCHA åœ¨å¤šæ¬¡å¤±è´¥åå¯ç”¨
- è´¦æˆ·é”å®šé€šçŸ¥é‚®ä»¶

---

## åœºæ™¯ 2ï¼šå¯†ç é‡ç½®æµç¨‹å®‰å…¨

### å‰ç½®æ¡ä»¶
- æœ‰æ•ˆç”¨æˆ·è´¦æˆ·å’Œé‚®ç®±

### æ”»å‡»ç›®æ ‡
éªŒè¯å¯†ç é‡ç½®æµç¨‹æ˜¯å¦å®‰å…¨

### æ”»å‡»æ­¥éª¤
1. è¯·æ±‚å¯†ç é‡ç½®
2. æ£€æŸ¥é‡ç½®é“¾æ¥ï¼š
   - Token é•¿åº¦å’Œç†µ
   - Token æœ‰æ•ˆæœŸ
   - Token æ˜¯å¦ä¸€æ¬¡æ€§
   - æ˜¯å¦å¯é¢„æµ‹
3. æµ‹è¯•ï¼š
   - ä¸å­˜åœ¨é‚®ç®±çš„å“åº”
   - å¹¶å‘é‡ç½®è¯·æ±‚
   - é‡ç½®åæ—§ Token æ˜¯å¦å¤±æ•ˆ

### é¢„æœŸå®‰å…¨è¡Œä¸º
- Token è¶³å¤Ÿéšæœº (>= 128 bits)
- Token çŸ­æœŸæœ‰æ•ˆ (< 1 å°æ—¶)
- Token ä¸€æ¬¡æ€§ä½¿ç”¨
- ä¸æ³„éœ²é‚®ç®±æ˜¯å¦å­˜åœ¨

### éªŒè¯æ–¹æ³•
```bash
# è¯·æ±‚å¯†ç é‡ç½®
curl -X POST http://localhost:8080/api/v1/auth/forgot-password \
  -H "Content-Type: application/json" \
  -d '{"email":"user@test.com"}'

# æ£€æŸ¥è¿”å›å“åº” (åº”ä¸ä¸å­˜åœ¨é‚®ç®±ç›¸åŒ)
curl -X POST http://localhost:8080/api/v1/auth/forgot-password \
  -d '{"email":"nonexistent@test.com"}'
# é¢„æœŸ: ç›¸åŒçš„æˆåŠŸå“åº”

# æµ‹è¯• Token é‡ç”¨
curl -X POST http://localhost:8080/api/v1/auth/reset-password \
  -d '{"token":"used_token","new_password":"NewPass123!"}'
# é¢„æœŸ: 400 "Token invalid or expired"
```

### ä¿®å¤å»ºè®®
- ä½¿ç”¨ CSPRNG ç”Ÿæˆè‡³å°‘ 256 ä½ Token
- æœ‰æ•ˆæœŸä¸è¶…è¿‡ 1 å°æ—¶
- æˆåŠŸé‡ç½®åä½¿æ‰€æœ‰æ—§ Token å¤±æ•ˆ
- é™åˆ¶é‡ç½®è¯·æ±‚é¢‘ç‡
- è®°å½•å®¡è®¡æ—¥å¿—

---

## åœºæ™¯ 3ï¼šå¯†ç å­˜å‚¨å®‰å…¨

### å‰ç½®æ¡ä»¶
- æ•°æ®åº“è®¿é—®æƒé™ (æµ‹è¯•ç¯å¢ƒ)

### æ”»å‡»ç›®æ ‡
éªŒè¯å¯†ç æ˜¯å¦å®‰å…¨å­˜å‚¨

### æ”»å‡»æ­¥éª¤
1. æ£€æŸ¥æ•°æ®åº“ä¸­çš„å¯†ç å­˜å‚¨æ ¼å¼
2. éªŒè¯å“ˆå¸Œç®—æ³•
3. æ£€æŸ¥æ˜¯å¦æœ‰ç›å€¼
4. å°è¯•å½©è™¹è¡¨æ”»å‡» (å¦‚æœå¯èƒ½)

### é¢„æœŸå®‰å…¨è¡Œä¸º
- ä½¿ç”¨å¼ºå“ˆå¸Œç®—æ³• (Argon2id, bcrypt, PBKDF2)
- æ¯ä¸ªå¯†ç æœ‰å”¯ä¸€ç›å€¼
- å¯†ç ä¸ä»¥æ˜æ–‡å­˜å‚¨

### éªŒè¯æ–¹æ³•
```sql
-- åœ¨ Keycloak æ•°æ®åº“ä¸­æ£€æŸ¥
SELECT credential_data FROM credential WHERE user_id = 'xxx';

-- åº”è¿”å›ç±»ä¼¼:
-- {"hashIterations":210000,"algorithm":"pbkdf2-sha512",...}
-- æˆ– Argon2 æ ¼å¼
```

### ä¿®å¤å»ºè®®
- ä½¿ç”¨ Argon2id (æ¨è) æˆ– bcrypt
- PBKDF2 è‡³å°‘ 100,000 æ¬¡è¿­ä»£
- å®šæœŸå®¡è®¡å“ˆå¸Œå‚æ•°
- è€ƒè™‘å¯†ç è¿ç§»ç­–ç•¥

---

## åœºæ™¯ 4ï¼šå¯†ç æ›´æ”¹å®‰å…¨

### å‰ç½®æ¡ä»¶
- å·²ç™»å½•ç”¨æˆ·

### æ”»å‡»ç›®æ ‡
éªŒè¯å¯†ç æ›´æ”¹æµç¨‹å®‰å…¨æ€§

### æ”»å‡»æ­¥éª¤
1. å°è¯•æ›´æ”¹å¯†ç ï¼š
   - ä¸æä¾›å½“å‰å¯†ç 
   - æ–°å¯†ç ä¸æ—§å¯†ç ç›¸åŒ
   - é€šè¿‡ CSRF æ”»å‡»æ›´æ”¹
2. æ£€æŸ¥æ˜¯å¦å¼ºåˆ¶æ³¨é”€å…¶ä»–ä¼šè¯
3. æ£€æŸ¥å¯†ç å†å²æ£€æŸ¥

### é¢„æœŸå®‰å…¨è¡Œä¸º
- æ›´æ”¹å¯†ç éœ€è¦å½“å‰å¯†ç 
- ç¦æ­¢ä½¿ç”¨æœ€è¿‘ N ä¸ªå¯†ç 
- æ›´æ”¹åæ³¨é”€å…¶ä»–ä¼šè¯
- å‘é€é€šçŸ¥é‚®ä»¶

### éªŒè¯æ–¹æ³•
```bash
# ä¸æä¾›å½“å‰å¯†ç 
curl -X PUT http://localhost:8080/api/v1/users/me/password \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"new_password":"NewPass123!"}'
# é¢„æœŸ: 400 "Current password required"

# ä½¿ç”¨æ—§å¯†ç 
curl -X PUT http://localhost:8080/api/v1/users/me/password \
  -H "Authorization: Bearer $TOKEN" \
  -d '{"current_password":"OldPass123!","new_password":"OldPass123!"}'
# é¢„æœŸ: 400 "Cannot reuse recent passwords"

# æ£€æŸ¥å…¶ä»–ä¼šè¯æ˜¯å¦è¢«æ³¨é”€
# ç”¨æ—§ session è®¿é—®åº”å¤±è´¥
```

### ä¿®å¤å»ºè®®
- å¼ºåˆ¶éªŒè¯å½“å‰å¯†ç 
- ä¿ç•™æœ€è¿‘ 5-10 ä¸ªå¯†ç å“ˆå¸Œ
- æ›´æ”¹åæ³¨é”€æ‰€æœ‰å…¶ä»–ä¼šè¯
- å‘é€å¯†ç æ›´æ”¹é€šçŸ¥
- è®°å½•å®¡è®¡æ—¥å¿—

---

## æ£€æŸ¥æ¸…å•

| # | åœºæ™¯ | çŠ¶æ€ | æµ‹è¯•æ—¥æœŸ | æµ‹è¯•äººå‘˜ | å‘ç°é—®é¢˜ |
|---|------|------|----------|----------|----------|
| 1 | å¯†ç æš´åŠ›ç ´è§£é˜²æŠ¤ | â˜ | | | |
| 2 | å¯†ç é‡ç½®æµç¨‹å®‰å…¨ | â˜ | | | |
| 3 | å¯†ç å­˜å‚¨å®‰å…¨ | â˜ | | | |
| 4 | å¯†ç æ›´æ”¹å®‰å…¨ | â˜ | | | |

---

## å‚è€ƒèµ„æ–™

- [OWASP Password Storage Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Password_Storage_Cheat_Sheet.html)
- [OWASP Authentication Cheat Sheet](https://cheatsheetseries.owasp.org/cheatsheets/Authentication_Cheat_Sheet.html)
- [NIST Digital Identity Guidelines](https://pages.nist.gov/800-63-3/sp800-63b.html)
- [CWE-521: Weak Password Requirements](https://cwe.mitre.org/data/definitions/521.html)
