# Ticket: Create User with Duplicate Email

**Created**: 2026-02-03 14:30:52
**QA Document**: `docs/qa/user/01-crud.md`
**Scenario**: #2
**Status**: FAILED

---

## 测试内容

Testing user creation with duplicate email address to verify validation

**Test Location**: Portal → Users → Create User
**Test Type**: UI/Integration

---

## 预期结果

System should prevent duplicate email creation and show clear error message

**Expected UI State**:
- Error toast message: "Email already exists"
- Form remains on create page with error indication
- No new user record created

**Expected Database State**:
```sql
-- Should still have only 1 user with this email
SELECT COUNT(*) FROM users WHERE email = 'test@example.com';
-- Expected: 1
```

**Expected Results**:
- Email validation triggered before API call
- API returns 400 Bad Request
- No duplicate records in database
- User sees helpful error message

---

## 再现方法

### Prerequisites
1. Existing user with email `test@example.com` in the database
2. Logged in as admin user
3. Navigate to Users page

### Steps to Reproduce
1. Click "Create User" button
2. Fill in form:
   - Email: `test@example.com` (duplicate)
   - Display Name: `Test User 2`
   - Password: `Test123!`
3. Click "Create" button
4. Observe error behavior

### Environment
- **Portal**: http://localhost:3000
- **Auth9 Core**: http://localhost:8080
- **Keycloak**: http://localhost:8081
- **Test User**: admin / Admin123!

---

## 实际结果

### Test Execution Failed at Step 3

**UI Error**:
```
Internal Server Error
Please try again later
```

**Browser Snapshot**:
- Generic error toast displayed instead of specific validation message
- Form remains filled (good)
- Error does not indicate the actual problem

**Database State**:
```sql
-- Actual query results
SELECT COUNT(*) FROM users WHERE email = 'test@example.com';

-- Results:
2 (INCORRECT - duplicate was created!)
```

**Data Mismatch**:
- Expected: COUNT = 1 (no duplicate)
- Actual: COUNT = 2 (duplicate created)
- Difference: Database constraint not enforced, duplicate record created

### Service Logs

**auth9-core logs**:
```
[2026-02-03 14:30:45] INFO: POST /api/v1/users - Request received
[2026-02-03 14:30:45] ERROR: Database error: Duplicate entry 'test@example.com' for key 'users.email'
[2026-02-03 14:30:45] ERROR: Failed to rollback transaction
[2026-02-03 14:30:45] ERROR: Error executing query: Connection pool exhausted
[2026-02-03 14:30:45] ERROR: 500 Internal Server Error returned to client
```

**auth9-portal logs**:
```
[2026-02-03 14:30:46] WARN: API error response: 500 Internal Server Error
[2026-02-03 14:30:46] ERROR: Failed to create user: Network error
```

**Keycloak logs**:
```
[2026-02-03 14:30:44] INFO: User creation request for test@example.com
[2026-02-03 14:30:44] WARN: User already exists in realm
[2026-02-03 14:30:44] ERROR: Duplicate user error returned
```

---

## Analysis

**Root Cause**: 
- Database transaction rollback failed due to connection pool exhaustion
- Duplicate validation happens at Keycloak level, but Auth9 Core proceeds with database insert
- Error handling does not properly translate specific errors to user-friendly messages

**Severity**: High

**Impact**:
- User confusion: Generic error message doesn't help user fix the problem
- Data integrity: Duplicate records created despite validation
- System stability: Connection pool issues affecting other requests

**Related Components**:
- [x] Frontend (auth9-portal) - Error message display
- [x] Backend API (auth9-core) - Transaction handling, connection pool
- [x] Database (TiDB) - Unique constraint enforcement
- [x] Keycloak - Duplicate user validation

---

*Ticket generated by QA Testing Skill*
