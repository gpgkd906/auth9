# 服务管理模块 QA 测试报告

**测试日期**: 2026-02-02
**测试人员**: Claude (自动化测试)
**测试环境**: Docker (localhost:3000)

---

## 测试概览

| 文档 | 通过 | 警告 | 失败 | 总计 |
|------|------|------|------|------|
| 01-service-crud.md | 4 | 1 | 0 | 5 |
| 02-client.md | 2 | 1 | 0 | 3* |
| 03-oidc.md | 1 | 0 | 1 | 2* |

*注: 部分场景需要API测试或更复杂的OIDC流程测试，未在本次UI测试中覆盖

---

## 01-service-crud.md 详细结果

### 场景 1：创建服务 ✅ 通过

| 项目 | 结果 |
|------|------|
| 显示创建成功 | ✅ |
| 显示初始 Client Secret | ✅ `pzoTp1pZLSwCTtSu8qcgZ2VctUVjvDC2` |
| 服务出现在列表中 | ✅ |

### 场景 2：创建重复名称的服务 ⚠️ 警告

| 项目 | 结果 |
|------|------|
| 阻止创建重复名称 | ✅ |
| 错误信息友好 | ❌ 显示原始数据库错误 |

**问题详情**:
- 预期: 显示「服务名称已存在」
- 实际: 显示 `Database error: error returned from database: 1062 (23000): Duplicate entry '00000000-0000-0000-0000-000000000000-My Web App' for key 'services.idx_services_tenant_name_unique'`

**建议**: 在前端或后端添加错误消息映射，将数据库错误转换为用户友好的提示

### 场景 3：更新服务配置 ✅ 通过

| 项目 | 结果 |
|------|------|
| Base URL 更新 | ✅ `https://newdomain.example.com` |
| Redirect URIs 更新 | ✅ 支持多个 URI |
| 保存成功 | ✅ |

### 场景 4：删除服务（级联删除）✅ 通过

| 项目 | 结果 |
|------|------|
| 服务删除成功 | ✅ |
| 关联客户端删除 | ✅ (数据库验证: client_count = 0) |

### 场景 5：查看服务详情 ✅ 通过

| 项目 | 结果 |
|------|------|
| 显示服务基本信息 | ✅ |
| 显示 OIDC 配置 | ✅ |
| 显示关联客户端列表 | ✅ |

---

## 02-client.md 详细结果

### 场景 1：创建客户端 ⚠️ 警告

| 项目 | 结果 |
|------|------|
| 客户端创建成功 | ✅ |
| 显示 Client Secret | ❌ 未显示初始密钥 |
| 客户端出现在列表中 | ✅ |

**问题详情**: 创建新客户端时未弹出显示 Client Secret 的对话框

**建议**: 创建客户端后应显示初始 Client Secret，与创建服务时的行为一致

### 场景 2：重新生成客户端密钥 ✅ 通过

| 项目 | 结果 |
|------|------|
| 确认对话框 | ✅ "Regenerate secret? The old secret will stop working immediately." |
| 显示新密钥 | ✅ `LN6w9oHp5Jrvt59GZQR4rmDruUfS30v9` |
| 密钥已更新 | ✅ (与原密钥不同) |

### 场景 3：删除客户端 ✅ 通过

| 项目 | 结果 |
|------|------|
| 确认对话框 | ✅ "Delete this client? This action cannot be undone." |
| 客户端删除成功 | ✅ |
| 客户端从列表消失 | ✅ |

### 场景 4 & 5：验证客户端凭证
*需要 API 测试，未在本次 UI 测试中覆盖*

---

## 03-oidc.md 详细结果

### 场景 4：Client ID 唯一性验证 ✅ 通过

| 项目 | 结果 |
|------|------|
| 阻止重复 Client ID | ✅ |
| 错误信息 | ✅ "Client already exists in Keycloak" |

### 场景 5：Redirect URI 格式验证 ❌ 失败

| 测试 URI | 预期 | 实际 |
|----------|------|------|
| `https://app.example.com/callback` | ✅ 允许 | ✅ 允许 |
| `http://localhost:3000/callback` | ✅ 允许 | 未测试 |
| `http://app.example.com/callback` | ❌ 拒绝 | ✅ 允许 |

**问题详情**:
- 非 localhost 的 HTTP URI 应该被拒绝，但实际被接受
- 缺少 Redirect URI 格式验证

**建议**:
1. 在前端添加 URI 格式验证
2. 后端应拒绝非 HTTPS 的非本地 URI
3. 验证规则: HTTP 仅允许 localhost/127.0.0.1，其他必须 HTTPS

### 场景 1-3：Redirect URI 验证、多 URI 配置、Logout URI
*需要完整 OIDC 流程测试，未在本次 UI 测试中覆盖*

---

## 问题汇总

### 高优先级

| # | 问题 | 影响 | 建议修复 |
|---|------|------|----------|
| 1 | Redirect URI 格式未验证 | 安全风险 | 添加前端+后端验证 |

### 中优先级

| # | 问题 | 影响 | 建议修复 |
|---|------|------|----------|
| 2 | 创建客户端未显示初始密钥 | 用户体验 | 添加密钥显示对话框 |
| 3 | 错误信息显示原始数据库错误 | 用户体验 | 添加错误消息映射 |

---

## 测试检查清单

### 01-service-crud.md

| # | 场景 | 状态 | 备注 |
|---|------|------|------|
| 1 | 创建服务 | ✅ | |
| 2 | 创建重复名称服务 | ⚠️ | 错误信息需优化 |
| 3 | 更新服务配置 | ✅ | |
| 4 | 删除服务（级联） | ✅ | |
| 5 | 查看服务详情 | ✅ | |

### 02-client.md

| # | 场景 | 状态 | 备注 |
|---|------|------|------|
| 1 | 创建客户端 | ⚠️ | 未显示初始密钥 |
| 2 | 重新生成密钥 | ✅ | |
| 3 | 删除客户端 | ✅ | |
| 4 | 验证凭证（正确） | ☐ | 需API测试 |
| 5 | 验证凭证（错误） | ☐ | 需API测试 |

### 03-oidc.md

| # | 场景 | 状态 | 备注 |
|---|------|------|------|
| 1 | Redirect URI 验证 | ☐ | 需OIDC流程测试 |
| 2 | 多 Redirect URI | ☐ | 需OIDC流程测试 |
| 3 | Logout URI 配置 | ☐ | 需OIDC流程测试 |
| 4 | Client ID 唯一性 | ✅ | |
| 5 | URI 格式验证 | ❌ | HTTP非localhost被接受 |
