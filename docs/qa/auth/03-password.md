# 认证流程 - 密码管理测试

**模块**: 认证流程
**测试范围**: 密码重置、修改、强度验证
**场景数**: 5

---

## 场景 1：忘记密码 - 发送重置邮件

### 初始状态
- 用户已注册但忘记密码
- 邮件服务已配置

### 目的
验证忘记密码功能

### 测试操作流程
1. 点击「忘记密码」
2. 输入注册邮箱：`user@example.com`
3. 点击「发送重置链接」

### 预期结果
- 显示「如果该邮箱存在，我们已发送重置链接」
- 用户收到重置邮件

### 预期数据状态
```sql
-- 验证重置令牌已创建（如果有 password_reset_tokens 表）
SELECT id, user_id, expires_at FROM password_reset_tokens
WHERE user_id = (SELECT id FROM users WHERE email = 'user@example.com')
ORDER BY created_at DESC LIMIT 1;
-- 预期: 存在记录，expires_at 为未来时间
```

---

## 场景 2：重置密码

### 初始状态
- 用户有有效的密码重置令牌

### 目的
验证密码重置流程

### 测试操作流程
1. 点击邮件中的重置链接
2. 输入新密码：`NewSecurePass123!`
3. 确认新密码
4. 提交

### 预期结果
- 显示密码重置成功
- 可以使用新密码登录
- 重置令牌失效

### 预期数据状态
```sql
-- Keycloak 中密码已更新（通过尝试登录验证）

-- 重置令牌应被标记为已使用
SELECT used_at FROM password_reset_tokens WHERE id = '{token_id}';
-- 预期: used_at 有值
```

---

## 场景 3：使用过期重置令牌

### 初始状态
- 重置令牌已过期

### 目的
验证过期令牌处理

### 测试操作流程
1. 使用过期的重置链接

### 预期结果
- 显示错误：「链接已过期，请重新申请」

---

## 场景 4：修改密码（已登录用户）

### 初始状态
- 用户已登录
- 用户知道当前密码

### 目的
验证修改密码功能

### 测试操作流程
1. 进入「设置」→「安全」
2. 点击「修改密码」
3. 输入当前密码
4. 输入新密码
5. 确认新密码
6. 提交

### 预期结果
- 显示密码修改成功
- 可以使用新密码登录

### 预期数据状态
```sql
-- Keycloak 中密码已更新
```

---

## 场景 5：密码强度验证

### 初始状态
- 系统配置了密码策略

### 目的
验证密码强度验证

### 测试操作流程
测试以下弱密码：
1. 太短：`abc123`
2. 无大写：`password123!`
3. 无数字：`Password!`
4. 无特殊字符：`Password123`

### 预期结果
- 每种情况显示相应的密码强度错误
- 密码不被接受

---

## 检查清单

| # | 场景 | 状态 | 测试日期 | 测试人员 | 备注 |
|---|------|------|----------|----------|------|
| 1 | 忘记密码 | ☐ | | | |
| 2 | 重置密码 | ☐ | | | |
| 3 | 过期重置令牌 | ☐ | | | |
| 4 | 修改密码 | ☐ | | | |
| 5 | 密码强度验证 | ☐ | | | |
