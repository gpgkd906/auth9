# 密码管理

Auth9 提供完整的密码管理功能，包括密码重置、密码修改和密码策略配置。

## 核心功能

### 功能概览

| 功能 | 描述 | 用户角色 |
|------|------|---------|
| 忘记密码 | 通过邮件重置密码 | 所有用户 |
| 密码修改 | 已登录用户修改密码 | 所有用户 |
| 密码策略 | 配置密码复杂度要求 | 管理员 |
| 账户锁定 | 防止暴力破解 | 系统自动 |

## 密码重置流程

### 用户端流程

#### 1. 请求重置

```
用户 → 忘记密码页面 → 输入邮箱 → 发送重置邮件
```

**通过管理界面**：
1. 访问登录页面
2. 点击 "Forgot Password" 链接
3. 输入注册邮箱
4. 点击 "Send Reset Link"
5. 检查邮箱收件箱（包括垃圾邮件）

**通过 REST API**：

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/password/forgot \
  -H "Content-Type: application/json" \
  -d '{
    "email": "user@example.com"
  }'
```

响应（始终返回成功以保护隐私）：

```json
{
  "message": "If the email exists, a reset link has been sent."
}
```

#### 2. 验证令牌

用户点击邮件中的链接后，系统验证令牌：

```bash
curl https://api.auth9.yourdomain.com/api/v1/password/verify-token?token=<reset_token>
```

响应：

```json
{
  "data": {
    "valid": true,
    "email": "user@example.com",
    "expires_at": "2024-01-01T01:00:00Z"
  }
}
```

#### 3. 重置密码

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/password/reset \
  -H "Content-Type: application/json" \
  -d '{
    "token": "<reset_token>",
    "password": "NewSecurePassword123!",
    "password_confirmation": "NewSecurePassword123!"
  }'
```

响应：

```json
{
  "message": "Password has been reset successfully."
}
```

### 安全机制

- ✅ 令牌一次性使用，使用后立即失效
- ✅ 令牌有效期默认 1 小时
- ✅ 不泄露邮箱是否存在
- ✅ 重置成功后终止所有其他会话
- ✅ 记录审计日志

## 密码修改

已登录用户可以修改自己的密码。

### 通过管理界面

1. 点击右上角用户头像
2. 选择 Settings > Security
3. 在 "Change Password" 区域填写：
   - Current Password（当前密码）
   - New Password（新密码）
   - Confirm Password（确认密码）
4. 点击 "Change Password"

### 通过 REST API

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/password/change \
  -H "Authorization: Bearer <access_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "current_password": "OldPassword123!",
    "new_password": "NewPassword456!",
    "new_password_confirmation": "NewPassword456!"
  }'
```

响应：

```json
{
  "message": "Password changed successfully."
}
```

### 验证规则

- 当前密码必须正确
- 新密码必须符合密码策略
- 新密码不能与当前密码相同
- 新密码不能是最近使用过的密码（如果启用密码历史）

## 密码策略

### 策略属性

| 属性 | 类型 | 默认值 | 说明 |
|------|------|--------|------|
| `min_length` | integer | 8 | 最小长度 |
| `max_length` | integer | 128 | 最大长度 |
| `require_uppercase` | boolean | false | 要求大写字母 |
| `require_lowercase` | boolean | false | 要求小写字母 |
| `require_numbers` | boolean | false | 要求数字 |
| `require_symbols` | boolean | false | 要求特殊符号 |
| `password_expiry_days` | integer | 0 | 密码过期天数（0=永不过期） |
| `password_history_count` | integer | 0 | 记住的历史密码数量 |
| `lockout_threshold` | integer | 5 | 锁定前失败次数 |
| `lockout_duration_minutes` | integer | 30 | 锁定持续时间 |

### 获取当前策略

```bash
curl https://api.auth9.yourdomain.com/api/v1/password/policy \
  -H "Authorization: Bearer <access_token>"
```

响应：

```json
{
  "data": {
    "tenant_id": "tenant-uuid",
    "min_length": 12,
    "max_length": 128,
    "require_uppercase": true,
    "require_lowercase": true,
    "require_numbers": true,
    "require_symbols": true,
    "password_expiry_days": 90,
    "password_history_count": 5,
    "lockout_threshold": 5,
    "lockout_duration_minutes": 30
  }
}
```

### 更新策略（管理员）

```bash
curl -X PUT https://api.auth9.yourdomain.com/api/v1/password/policy \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "tenant-uuid",
    "min_length": 12,
    "require_uppercase": true,
    "require_lowercase": true,
    "require_numbers": true,
    "require_symbols": true,
    "password_expiry_days": 90,
    "password_history_count": 5,
    "lockout_threshold": 5,
    "lockout_duration_minutes": 30
  }'
```

### 预设策略级别

#### 宽松 (loose)
```json
{
  "min_length": 6,
  "require_uppercase": false,
  "require_lowercase": false,
  "require_numbers": false,
  "require_symbols": false
}
```

#### 中等 (medium)
```json
{
  "min_length": 8,
  "require_uppercase": true,
  "require_lowercase": true,
  "require_numbers": true,
  "require_symbols": false
}
```

#### 严格 (strong)
```json
{
  "min_length": 12,
  "require_uppercase": true,
  "require_lowercase": true,
  "require_numbers": true,
  "require_symbols": true,
  "password_expiry_days": 90,
  "password_history_count": 5
}
```

## 账户锁定

### 锁定机制

当用户连续输错密码达到阈值时，账户会被临时锁定：

1. 记录失败登录次数
2. 达到 `lockout_threshold` 后锁定账户
3. 锁定 `lockout_duration_minutes` 分钟
4. 锁定期间拒绝登录尝试
5. 锁定时间过后自动解锁

### 检查锁定状态

```bash
curl https://api.auth9.yourdomain.com/api/v1/users/{user_id}/lockout-status \
  -H "Authorization: Bearer <admin_token>"
```

响应：

```json
{
  "data": {
    "locked": true,
    "failed_attempts": 5,
    "locked_until": "2024-01-01T01:30:00Z",
    "remaining_seconds": 1200
  }
}
```

### 管理员解锁

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/users/{user_id}/unlock \
  -H "Authorization: Bearer <admin_token>"
```

## 数据库结构

### 密码重置令牌表

```sql
CREATE TABLE password_reset_tokens (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  token VARCHAR(255) NOT NULL UNIQUE,
  expires_at TIMESTAMP NOT NULL,
  used_at TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_token (token),
  INDEX idx_user_id (user_id),
  INDEX idx_expires_at (expires_at)
);
```

### 密码历史表

```sql
CREATE TABLE password_history (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  password_hash VARCHAR(255) NOT NULL,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

  INDEX idx_user_id_created (user_id, created_at DESC)
);
```

## 邮件模板

### 密码重置邮件

```html
Subject: Reset your Auth9 password

Hello {{user_name}},

We received a request to reset your password. Click the link below to set a new password:

{{reset_link}}

This link will expire in 1 hour.

If you didn't request this, you can safely ignore this email.

Thanks,
The Auth9 Team
```

### 密码修改通知

```html
Subject: Your Auth9 password was changed

Hello {{user_name}},

Your password was recently changed. If you made this change, no action is needed.

If you didn't change your password, please contact your administrator immediately.

Changed at: {{changed_at}}
IP Address: {{ip_address}}

Thanks,
The Auth9 Team
```

## 审计日志

所有密码相关操作都会记录审计日志：

| 事件类型 | 描述 |
|---------|------|
| `password.reset_requested` | 请求密码重置 |
| `password.reset_completed` | 完成密码重置 |
| `password.changed` | 密码修改成功 |
| `password.change_failed` | 密码修改失败 |
| `account.locked` | 账户被锁定 |
| `account.unlocked` | 账户被解锁 |

## 最佳实践

### 1. 密码策略建议

- 生产环境建议使用 "严格" 策略
- 设置密码过期（90天）
- 启用密码历史（至少5个）
- 配置合理的锁定阈值（5次）

### 2. 安全建议

- ✅ 使用 HTTPS 传输密码
- ✅ 密码在传输和存储时都要加密
- ✅ 不在日志中记录密码
- ✅ 密码重置链接使用一次性令牌
- ✅ 重置成功后终止所有会话

### 3. 用户体验

- 提供清晰的密码要求提示
- 实时验证密码强度
- 密码重置邮件包含有效期提示
- 修改密码后发送通知邮件

## 常见问题

### Q: 密码重置邮件没收到？

A: 检查以下几点：
1. 确认邮箱地址正确
2. 检查垃圾邮件文件夹
3. 确认邮件服务配置正确
4. 查看系统日志排查发送错误

### Q: 如何禁用密码策略？

A: 将所有复杂度要求设为 false，最小长度设为 1。但不建议在生产环境这样做。

### Q: 账户被锁定如何解锁？

A: 两种方式：
1. 等待锁定时间过期
2. 联系管理员手动解锁

### Q: 密码历史如何工作？

A: 系统会保存最近 N 个密码的哈希值（由 `password_history_count` 配置），新密码不能与这些历史密码相同。

## 相关文档

- [认证流程](认证流程.md)
- [会话管理](会话管理.md)
- [安全最佳实践](最佳实践.md)
- [故障排查](故障排查.md)
