# 会话管理

Auth9 提供完整的会话管理功能，支持用户查看、撤销会话，以及管理员强制登出等操作。

## 核心概念

### 什么是会话

会话（Session）代表用户的一次登录状态，包含：

- 用户身份信息
- 登录设备和浏览器信息
- IP 地址和地理位置
- 创建时间和最后活跃时间
- 关联的访问令牌

### 会话生命周期

```
用户登录 → 创建会话 → 活跃使用 → 会话过期/撤销 → 会话终止
```

## 会话属性

| 属性 | 类型 | 说明 |
|------|------|------|
| `id` | UUID | 会话唯一标识 |
| `user_id` | UUID | 所属用户 |
| `device_type` | string | 设备类型 (desktop/mobile/tablet) |
| `device_name` | string | 设备名称 |
| `browser` | string | 浏览器信息 |
| `os` | string | 操作系统 |
| `ip_address` | string | IP 地址 |
| `location` | string | 地理位置 |
| `last_active_at` | timestamp | 最后活跃时间 |
| `created_at` | timestamp | 创建时间 |
| `expires_at` | timestamp | 过期时间 |

## 用户会话管理

### 查看我的会话

**通过管理界面**：
1. 点击右上角用户头像
2. 选择 Settings > Sessions
3. 查看当前会话和其他活跃会话

**通过 REST API**：

```bash
curl https://api.auth9.yourdomain.com/api/v1/sessions/me \
  -H "Authorization: Bearer <access_token>"
```

响应：

```json
{
  "data": {
    "current": {
      "id": "session-uuid-1",
      "device_type": "desktop",
      "device_name": "MacBook Pro",
      "browser": "Chrome 120",
      "os": "macOS 14.0",
      "ip_address": "192.168.1.100",
      "location": "Tokyo, Japan",
      "last_active_at": "2024-01-01T12:00:00Z",
      "created_at": "2024-01-01T10:00:00Z"
    },
    "others": [
      {
        "id": "session-uuid-2",
        "device_type": "mobile",
        "device_name": "iPhone 15",
        "browser": "Safari",
        "os": "iOS 17.0",
        "ip_address": "203.0.113.50",
        "location": "Osaka, Japan",
        "last_active_at": "2024-01-01T11:30:00Z",
        "created_at": "2023-12-28T09:00:00Z"
      }
    ]
  }
}
```

### 撤销单个会话

**通过管理界面**：
1. 在 Sessions 页面找到目标会话
2. 点击 "Revoke" 按钮
3. 确认撤销

**通过 REST API**：

```bash
curl -X DELETE https://api.auth9.yourdomain.com/api/v1/sessions/{session_id} \
  -H "Authorization: Bearer <access_token>"
```

响应：

```json
{
  "message": "Session revoked successfully."
}
```

### 撤销所有其他会话

**通过管理界面**：
1. 在 Sessions 页面点击 "Sign out all other sessions"
2. 确认操作

**通过 REST API**：

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/sessions/revoke-others \
  -H "Authorization: Bearer <access_token>"
```

响应：

```json
{
  "data": {
    "revoked_count": 3
  },
  "message": "All other sessions have been revoked."
}
```

## 管理员会话管理

### 查看用户会话

```bash
curl https://api.auth9.yourdomain.com/api/v1/admin/users/{user_id}/sessions \
  -H "Authorization: Bearer <admin_token>"
```

响应：

```json
{
  "data": [
    {
      "id": "session-uuid",
      "device_type": "desktop",
      "device_name": "Windows PC",
      "browser": "Firefox 120",
      "os": "Windows 11",
      "ip_address": "10.0.0.50",
      "location": "New York, US",
      "last_active_at": "2024-01-01T12:00:00Z",
      "created_at": "2024-01-01T08:00:00Z"
    }
  ],
  "pagination": {
    "total": 1,
    "page": 1,
    "per_page": 20
  }
}
```

### 强制登出用户

终止指定用户的所有会话：

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/admin/users/{user_id}/force-logout \
  -H "Authorization: Bearer <admin_token>"
```

响应：

```json
{
  "data": {
    "revoked_count": 5
  },
  "message": "User has been logged out from all sessions."
}
```

### 撤销特定会话

```bash
curl -X DELETE https://api.auth9.yourdomain.com/api/v1/admin/sessions/{session_id} \
  -H "Authorization: Bearer <admin_token>"
```

## 设备识别

### User-Agent 解析

Auth9 自动解析 User-Agent 识别设备信息：

| 设备类型 | 识别规则 |
|---------|---------|
| `desktop` | Windows, macOS, Linux 桌面浏览器 |
| `mobile` | iPhone, Android 手机浏览器 |
| `tablet` | iPad, Android 平板浏览器 |

### 设备图标映射

```typescript
const deviceIcons = {
  desktop: MonitorIcon,
  mobile: SmartphoneIcon,
  tablet: TabletIcon,
};

const osIcons = {
  macOS: AppleIcon,
  Windows: WindowsIcon,
  Linux: LinuxIcon,
  iOS: AppleIcon,
  Android: AndroidIcon,
};
```

## 会话配置

### 租户级配置

在租户设置中配置会话参数：

```json
{
  "settings": {
    "session_timeout": 3600,
    "idle_timeout": 1800,
    "max_concurrent_sessions": 5,
    "remember_me_enabled": true,
    "remember_me_duration": 2592000
  }
}
```

| 参数 | 说明 | 默认值 |
|------|------|--------|
| `session_timeout` | 会话最大时长（秒） | 3600 (1小时) |
| `idle_timeout` | 空闲超时（秒） | 1800 (30分钟) |
| `max_concurrent_sessions` | 最大并发会话数 | 无限制 |
| `remember_me_enabled` | 启用"记住我"功能 | true |
| `remember_me_duration` | "记住我"时长（秒） | 2592000 (30天) |

### 更新会话配置

```bash
curl -X PUT https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id} \
  -H "Authorization: Bearer <admin_token>" \
  -H "Content-Type: application/json" \
  -d '{
    "settings": {
      "session_timeout": 7200,
      "idle_timeout": 3600,
      "max_concurrent_sessions": 3
    }
  }'
```

## 并发会话控制

### 启用限制

设置 `max_concurrent_sessions` 限制同时登录的设备数量：

```json
{
  "settings": {
    "max_concurrent_sessions": 3
  }
}
```

### 处理策略

当达到最大会话数时，有两种处理方式：

1. **拒绝新登录**：返回错误，要求用户先登出其他设备
2. **踢出最旧会话**：自动终止最早的会话

默认使用第一种策略。

### 获取并发会话数

```bash
curl https://api.auth9.yourdomain.com/api/v1/sessions/count \
  -H "Authorization: Bearer <access_token>"
```

响应：

```json
{
  "data": {
    "current": 2,
    "max": 3
  }
}
```

## 数据库结构

### 会话表

```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  keycloak_session_id VARCHAR(255),
  device_type VARCHAR(50),
  device_name VARCHAR(255),
  browser VARCHAR(255),
  os VARCHAR(255),
  ip_address VARCHAR(45),
  location VARCHAR(255),
  user_agent TEXT,
  last_active_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
  expires_at TIMESTAMP,
  revoked_at TIMESTAMP,

  INDEX idx_user_id (user_id),
  INDEX idx_keycloak_session_id (keycloak_session_id),
  INDEX idx_last_active (last_active_at),
  INDEX idx_expires (expires_at)
);
```

## Keycloak 集成

### 会话同步

Auth9 与 Keycloak 的会话保持同步：

1. 用户登录时，Keycloak 创建会话
2. Auth9 接收登录事件，创建对应的会话记录
3. 撤销会话时，同时调用 Keycloak API 终止会话
4. 定期同步确保一致性

### Keycloak Admin API

获取用户会话：

```bash
curl https://keycloak.yourdomain.com/admin/realms/auth9/users/{user_id}/sessions \
  -H "Authorization: Bearer <admin_token>"
```

删除用户会话：

```bash
curl -X DELETE \
  https://keycloak.yourdomain.com/admin/realms/auth9/sessions/{session_id} \
  -H "Authorization: Bearer <admin_token>"
```

## 审计日志

所有会话操作都会记录审计日志：

| 事件类型 | 描述 |
|---------|------|
| `session.created` | 会话创建（用户登录） |
| `session.revoked` | 会话撤销 |
| `session.expired` | 会话过期 |
| `session.force_logout` | 管理员强制登出 |
| `session.revoke_others` | 撤销其他会话 |

## 安全建议

### 1. 会话安全

- ✅ 使用 HTTPS 传输会话令牌
- ✅ 会话 ID 使用安全随机数生成
- ✅ 敏感操作后刷新会话
- ✅ 密码修改后终止所有其他会话

### 2. 超时配置

- 生产环境建议会话超时不超过 8 小时
- 空闲超时建议 30 分钟
- 高安全场景建议 15 分钟空闲超时

### 3. 并发控制

- 企业用户建议限制 3-5 个并发会话
- 敏感系统建议限制单一会话

### 4. 监控告警

- 监控异常登录（新设备、新位置）
- 设置并发会话告警
- 监控会话创建失败率

## 最佳实践

### 用户端

1. 定期检查活跃会话
2. 在共享设备上及时登出
3. 发现可疑会话立即撤销
4. 修改密码后检查会话列表

### 管理员端

1. 配置合理的会话超时
2. 启用并发会话限制
3. 监控异常会话活动
4. 为敏感账户启用更严格的限制

## 常见问题

### Q: 会话突然失效？

A: 可能的原因：
1. 会话超时
2. 管理员强制登出
3. 密码被修改
4. 账户被禁用
5. 达到最大会话数被踢出

### Q: 如何延长会话时长？

A: 在租户设置中调整 `session_timeout` 和 `idle_timeout` 参数。

### Q: 地理位置不准确？

A: 位置基于 IP 地址解析，可能存在偏差，特别是使用 VPN 或代理时。

### Q: 如何查看历史会话？

A: 历史会话记录在审计日志中，可以通过审计日志 API 查询。

## 相关文档

- [认证流程](认证流程.md)
- [密码管理](密码管理.md)
- [分析与安全告警](分析与安全告警.md)
- [REST API](REST-API.md)
