# 故障排查

本文档提供 Auth9 常见问题的诊断和解决方案。

## 快速诊断

### 健康检查

```bash
# 检查服务健康状态
curl http://localhost:8080/health

# 检查就绪状态
curl http://localhost:8080/ready
```

预期响应：

```json
{
  "status": "healthy",
  "version": "0.1.0",
  "checks": {
    "database": "ok",
    "redis": "ok",
    "keycloak": "ok"
  }
}
```

### 查看日志

```bash
# Docker Compose
docker-compose logs -f auth9-core
docker-compose logs -f auth9-portal

# Kubernetes
kubectl logs -f deployment/auth9-core -n auth9
kubectl logs -f deployment/auth9-portal -n auth9
```

## 常见问题

### 1. 服务启动失败

#### 问题：auth9-core 无法启动

**症状**：
```
Error: Failed to connect to database
```

**诊断步骤**：

1. 检查数据库连接：
```bash
# 测试数据库连接
mysql -h localhost -P 4000 -u root -p -e "SELECT 1"
```

2. 检查环境变量：
```bash
echo $DATABASE_URL
# 应该输出类似：mysql://root:password@tidb:4000/auth9
```

3. 检查网络连接：
```bash
# Docker Compose
docker-compose exec auth9-core ping tidb

# Kubernetes
kubectl exec -it deployment/auth9-core -n auth9 -- ping tidb
```

**解决方案**：

- 确保 DATABASE_URL 正确
- 检查数据库服务是否运行
- 检查网络连接和防火墙规则
- 运行数据库迁移：
  ```bash
  cd auth9-core
  sqlx migrate run
  ```

#### 问题：Redis 连接失败

**症状**：
```
Error: Failed to connect to Redis: Connection refused
```

**解决方案**：

```bash
# 检查 Redis 是否运行
redis-cli -h localhost ping

# 检查 REDIS_URL 配置
echo $REDIS_URL

# 重启 Redis
docker-compose restart redis  # Docker Compose
kubectl rollout restart deployment/redis -n auth9  # Kubernetes
```

#### 问题：Keycloak 连接超时

**症状**：
```
Error: Keycloak connection timeout
```

**解决方案**：

1. 检查 Keycloak 状态：
```bash
curl http://keycloak:8080/health
```

2. 检查配置：
```bash
echo $KEYCLOAK_URL
echo $KEYCLOAK_REALM
```

3. 等待 Keycloak 完全启动（可能需要 1-2 分钟）

### 2. 认证问题

#### 问题：登录失败 - 401 Unauthorized

**症状**：
```json
{
  "error": {
    "code": "UNAUTHORIZED",
    "message": "Invalid credentials"
  }
}
```

**诊断步骤**：

1. 检查用户是否存在：
```bash
curl -X GET "http://localhost:8080/api/v1/users?email=user@example.com" \
  -H "Authorization: Bearer <admin-token>"
```

2. 检查 Keycloak 用户：
```bash
# 访问 Keycloak Admin Console
http://localhost:8081/admin
```

3. 查看审计日志：
```bash
curl "http://localhost:8080/api/v1/audit-logs?action=login.failed" \
  -H "Authorization: Bearer <admin-token>"
```

**解决方案**：

- 验证用户名和密码
- 重置密码
- 检查用户状态（是否被禁用）
- 检查租户状态

#### 问题：Token 验证失败

**症状**：
```json
{
  "error": {
    "code": "TOKEN_INVALID",
    "message": "Invalid token signature"
  }
}
```

**诊断步骤**：

1. 检查 JWT_SECRET 配置：
```bash
# 确保 auth9-core 和验证服务使用相同的 secret
echo $JWT_SECRET
```

2. 解码 Token 查看内容：
```bash
# 使用 jwt.io 或命令行工具
echo "<token>" | cut -d'.' -f2 | base64 -d | jq .
```

3. 检查 Token 过期时间：
```bash
# 查看 exp 字段
date -d @<exp-timestamp>
```

**解决方案**：

- 确保 JWT_SECRET 一致
- 检查系统时间是否同步
- 刷新过期的 Token
- 检查 Token Issuer 和 Audience

### 3. 权限问题

#### 问题：403 Forbidden

**症状**：
```json
{
  "error": {
    "code": "FORBIDDEN",
    "message": "Insufficient permissions"
  }
}
```

**诊断步骤**：

1. 检查用户角色：
```bash
curl "http://localhost:8080/api/v1/rbac/user-roles?user_id=xxx&tenant_id=xxx" \
  -H "Authorization: Bearer <token>"
```

2. 检查所需权限：
```bash
# 查看 API 文档了解所需权限
```

3. 验证租户归属：
```bash
curl "http://localhost:8080/api/v1/users/{user_id}" \
  -H "Authorization: Bearer <token>"
```

**解决方案**：

- 为用户分配适当的角色
- 检查角色的权限配置
- 验证用户属于目标租户
- 使用正确的租户 Access Token

### 4. 性能问题

#### 问题：API 响应缓慢

**症状**：
- API 延迟 > 1 秒
- 超时错误

**诊断步骤**：

1. 检查资源使用：
```bash
# Docker
docker stats

# Kubernetes
kubectl top pods -n auth9
```

2. 检查数据库性能：
```sql
-- 查看慢查询
SHOW PROCESSLIST;

-- 检查查询计划
EXPLAIN SELECT * FROM users WHERE email = 'xxx';
```

3. 检查 Redis 性能：
```bash
redis-cli INFO stats
redis-cli SLOWLOG GET 10
```

4. 查看日志中的慢请求：
```bash
grep "took more than" /var/log/auth9/access.log
```

**解决方案**：

- 增加服务副本数
- 优化数据库查询（添加索引）
- 检查缓存命中率
- 增加资源限制（CPU/内存）
- 启用查询缓存

#### 问题：内存泄漏

**症状**：
- 内存使用持续增长
- OOMKilled 错误

**诊断步骤**：

```bash
# 查看内存使用趋势
kubectl top pod auth9-core-xxx -n auth9 --containers

# 检查堆使用
curl http://localhost:8080/debug/pprof/heap
```

**解决方案**：

- 检查是否有未关闭的连接
- 检查缓存配置（是否有 TTL）
- 增加内存限制
- 重启服务释放内存
- 升级到最新版本（可能已修复）

### 5. 网络问题

#### 问题：gRPC 连接失败

**症状**：
```
Error: gRPC unavailable: failed to connect
```

**诊断步骤**：

1. 检查 gRPC 端口：
```bash
# 测试连接
grpcurl -plaintext localhost:50051 list

# 检查端口监听
netstat -tlnp | grep 50051
```

2. 检查防火墙：
```bash
# 测试端口连通性
telnet auth9-core 50051
```

**解决方案**：

- 检查 GRPC_PORT 配置
- 确保端口映射正确
- 检查网络策略和防火墙规则
- 使用正确的 TLS 配置

#### 问题：CORS 错误

**症状**：
```
Access to fetch at 'http://api.auth9.com' from origin 'http://localhost:3000'
has been blocked by CORS policy
```

**解决方案**：

1. 添加允许的源到配置：
```bash
CORS_ALLOWED_ORIGINS=http://localhost:3000,https://portal.example.com
```

2. 重启服务：
```bash
docker-compose restart auth9-core
```

### 6. 邮件问题

#### 问题：邮件发送失败

**症状**：
```
Error: Failed to send email: Connection refused
```

**诊断步骤**：

1. 检查邮件配置：
```bash
curl "http://localhost:8080/api/v1/system/email-settings" \
  -H "Authorization: Bearer <admin-token>"
```

2. 测试邮件连接：
```bash
# 测试 SMTP 连接
telnet smtp.gmail.com 587

# 或使用 openssl
openssl s_client -connect smtp.gmail.com:587 -starttls smtp
```

3. 查看邮件发送日志：
```bash
docker-compose logs -f auth9-core | grep "email"
```

**解决方案**：

- **SMTP 认证失败**：
  - 检查 SMTP 用户名和密码
  - Gmail 需要使用应用专用密码
  - 确认 SMTP 服务器地址和端口正确

- **连接超时**：
  - 检查防火墙设置
  - 确认 SMTP 端口未被阻止（25/587/465）

- **邮件被拒绝**：
  - 检查发件人邮箱配置
  - 确认 SPF、DKIM 记录正确

**测试邮件发送**：
```bash
curl -X POST "http://localhost:8080/api/v1/system/email-settings/test" \
  -H "Authorization: Bearer <admin-token>" \
  -d '{"to_email": "test@example.com"}'
```

#### 问题：邀请邮件未收到

**症状**：创建邀请成功但用户未收到邮件

**解决方案**：

- 检查邮件配置是否正确
- 查看垃圾邮件箱
- 检查邮件模板渲染：
```bash
curl -X POST "http://localhost:8080/api/v1/email-templates/preview" \
  -H "Authorization: Bearer <admin-token>" \
  -d '{"subject": "邀请", "html_body": "<html>...</html>"}'
```

### 7. 邀请系统问题

#### 问题：邀请链接无效

**症状**：
```
Error: Invalid or expired invitation token
```

**解决方案**：

- 检查邀请是否过期或被撤销
- 如已过期，创建新邀请
- 确认链接完整，未被截断

#### 问题：接受邀请失败

**症状**：用户邮箱与邀请不匹配

**解决方案**：

- 确认使用邀请邮箱注册/登录
- 检查租户域名白名单设置

### 8. 品牌定制问题

#### 问题：Logo 不显示

**解决方案**：

- 确认 Logo URL 公开可访问
- 检查 CORS 设置
- 使用 HTTPS URL
- 清除浏览器缓存

### 9. 数据问题

#### 问题：数据不同步

**症状**：
- Auth9 和 Keycloak 用户数据不一致
- 角色变更未生效

**诊断步骤**：

1. 检查同步状态：
```bash
curl "http://localhost:8080/api/v1/sync/status" \
  -H "Authorization: Bearer <admin-token>"
```

2. 查看同步日志：
```bash
kubectl logs -f deployment/auth9-core -n auth9 | grep "sync"
```

**解决方案**：

- 手动触发同步：
```bash
curl -X POST "http://localhost:8080/api/v1/sync/trigger" \
  -H "Authorization: Bearer <admin-token>"
```

- 清除缓存：
```bash
redis-cli FLUSHDB
```

- 重启服务

#### 问题：迁移失败

**症状**：
```
Error: Migration failed: duplicate key
```

**解决方案**：

1. 回滚迁移：
```bash
sqlx migrate revert
```

2. 检查数据库状态：
```sql
SELECT * FROM _sqlx_migrations;
```

3. 手动修复数据冲突

4. 重新运行迁移：
```bash
sqlx migrate run
```

## 日志分析

### 日志级别

| 级别 | 用途 |
|------|------|
| ERROR | 错误信息 |
| WARN | 警告信息 |
| INFO | 常规信息 |
| DEBUG | 调试信息 |
| TRACE | 详细追踪 |

### 常见错误日志

#### 1. 数据库连接错误

```
ERROR auth9_core::repository: Database connection pool exhausted
```

**解决方案**：增加 `DB_MAX_CONNECTIONS`

#### 2. Token 验证错误

```
WARN auth9_core::jwt: Token validation failed: expired
```

**解决方案**：客户端应刷新 Token

#### 3. 权限错误

```
INFO auth9_core::api: Access denied for user xxx to resource yyy
```

**解决方案**：检查用户权限配置

### 调试模式

启用调试日志：

```bash
LOG_LEVEL=debug cargo run  # 开发环境

# 生产环境（Docker）
docker-compose up -d
docker-compose exec auth9-core \
  env LOG_LEVEL=debug /app/auth9-core
```

## 性能分析

### 使用 Prometheus

```bash
# 查看指标
curl http://localhost:8080/metrics
```

关键指标：

- `http_requests_total` - 请求总数
- `http_request_duration_seconds` - 请求延迟
- `db_connections_active` - 活跃数据库连接
- `cache_hit_ratio` - 缓存命中率

### 使用 Tracing

```bash
# 启用分布式追踪
RUST_LOG=debug,auth9_core=trace cargo run
```

查看追踪：
- Jaeger: http://localhost:16686
- Zipkin: http://localhost:9411

## 备份和恢复

### 数据库备份

```bash
# 备份
mysqldump -h tidb -u root -p auth9 > backup_$(date +%Y%m%d).sql

# 恢复
mysql -h tidb -u root -p auth9 < backup_20240101.sql
```

### Redis 备份

```bash
# 创建快照
redis-cli BGSAVE

# 复制 RDB 文件
cp /var/lib/redis/dump.rdb /backup/
```

详见：[备份恢复](备份恢复.md)

## 获取帮助

### 收集诊断信息

运行诊断脚本：

```bash
#!/bin/bash
echo "=== System Info ==="
uname -a
docker --version
kubectl version --client

echo "=== Service Status ==="
docker-compose ps
kubectl get pods -n auth9

echo "=== Recent Logs ==="
docker-compose logs --tail=100 auth9-core
kubectl logs --tail=100 deployment/auth9-core -n auth9

echo "=== Health Checks ==="
curl -s http://localhost:8080/health | jq .

echo "=== Resource Usage ==="
docker stats --no-stream
kubectl top pods -n auth9
```

### 提交 Issue

提交问题时请包含：

1. Auth9 版本
2. 部署方式（Docker Compose / Kubernetes）
3. 环境信息（OS、Docker版本等）
4. 错误日志
5. 复现步骤
6. 预期行为 vs 实际行为

GitHub Issues: https://github.com/gpgkd906/auth9/issues

## 相关文档

- [快速开始](快速开始.md)
- [安装部署](安装部署.md)
- [配置说明](配置说明.md)
- [监控告警](监控告警.md)
- [备份恢复](备份恢复.md)
