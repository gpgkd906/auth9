# 多租户管理

Auth9 的多租户架构允许在单个部署中隔离和管理多个组织或团队。

## 核心概念

### 什么是租户

租户（Tenant）是 Auth9 中的顶级组织单位，代表一个独立的组织、公司或团队。每个租户拥有：

- 独立的用户集合
- 独立的服务和应用
- 独立的角色和权限配置
- 独立的设置和策略

### 租户隔离

Auth9 提供完整的数据隔离：

- ✅ 用户数据隔离
- ✅ 角色权限隔离
- ✅ 审计日志隔离
- ✅ 配置设置隔离

## 租户属性

每个租户包含以下属性：

| 属性 | 类型 | 说明 |
|------|------|------|
| `id` | UUID | 租户唯一标识 |
| `name` | string | 租户名称 |
| `slug` | string | URL 友好的唯一标识 |
| `logo_url` | string | 租户 Logo 地址 |
| `status` | enum | 状态：active, disabled |
| `settings` | JSON | 租户配置 |
| `created_at` | timestamp | 创建时间 |
| `updated_at` | timestamp | 更新时间 |

### 租户配置（Settings）

```json
{
  "require_mfa": false,
  "password_policy": "strong",
  "session_timeout": 3600,
  "allowed_domains": ["example.com"],
  "custom_branding": {
    "primary_color": "#007AFF",
    "logo_url": "https://...",
    "favicon_url": "https://..."
  },
  "sso_providers": ["google", "github"],
  "audit_retention_days": 90
}
```

## 创建租户

### 通过管理界面

1. 登录 Auth9 管理界面
2. 导航到 **租户管理** 页面
3. 点击 **创建租户** 按钮
4. 填写租户信息：
   - 租户名称（必填）
   - Slug（必填，自动生成可编辑）
   - Logo URL（可选）
5. 配置租户设置
6. 点击 **创建** 完成

### 通过 REST API

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/tenants \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "我的公司",
    "slug": "my-company",
    "logo_url": "https://example.com/logo.png",
    "settings": {
      "require_mfa": false,
      "password_policy": "strong"
    }
  }'
```

响应：

```json
{
  "data": {
    "id": "550e8400-e29b-41d4-a716-446655440000",
    "name": "我的公司",
    "slug": "my-company",
    "status": "active",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

## 租户管理

### 查看租户列表

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants \
  -H "Authorization: Bearer <token>"
```

### 获取租户详情

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id} \
  -H "Authorization: Bearer <token>"
```

### 更新租户

```bash
curl -X PUT https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id} \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "新的公司名称",
    "settings": {
      "require_mfa": true
    }
  }'
```

### 禁用租户

```bash
curl -X DELETE https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id} \
  -H "Authorization: Bearer <token>"
```

注意：禁用租户不会删除数据，只是标记为 `disabled` 状态。

## 租户设置

### 密码策略

支持三种密码策略级别：

#### 1. 宽松（loose）
- 最小长度：6 字符
- 无特殊字符要求

#### 2. 中等（medium）
- 最小长度：8 字符
- 需要大小写字母
- 需要数字

#### 3. 严格（strong）
- 最小长度：12 字符
- 需要大小写字母
- 需要数字
- 需要特殊字符

设置示例：

```json
{
  "settings": {
    "password_policy": "strong",
    "password_min_length": 12,
    "password_require_uppercase": true,
    "password_require_lowercase": true,
    "password_require_number": true,
    "password_require_special": true
  }
}
```

### MFA 设置

启用多因素认证：

```json
{
  "settings": {
    "require_mfa": true,
    "mfa_methods": ["totp", "sms", "email"],
    "mfa_grace_period_days": 7
  }
}
```

### Session 设置

```json
{
  "settings": {
    "session_timeout": 3600,
    "idle_timeout": 1800,
    "max_concurrent_sessions": 3,
    "remember_me_enabled": true,
    "remember_me_duration": 2592000
  }
}
```

### 域名白名单

限制只有特定域名的邮箱才能加入租户：

```json
{
  "settings": {
    "allowed_domains": [
      "example.com",
      "subdomain.example.com"
    ],
    "domain_verification_required": true
  }
}
```

### 自定义品牌

```json
{
  "settings": {
    "custom_branding": {
      "primary_color": "#007AFF",
      "secondary_color": "#5856D6",
      "logo_url": "https://example.com/logo.png",
      "favicon_url": "https://example.com/favicon.ico",
      "background_url": "https://example.com/bg.jpg",
      "custom_css": "/* 自定义样式 */"
    }
  }
}
```

## 租户用户管理

### 添加用户到租户

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/users/{user_id}/tenants \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "tenant_id": "tenant-uuid"
  }'
```

### 查看租户用户列表

```bash
curl "https://api.auth9.yourdomain.com/api/v1/users?tenant_id=tenant-uuid" \
  -H "Authorization: Bearer <token>"
```

### 移除租户用户

```bash
curl -X DELETE \
  https://api.auth9.yourdomain.com/api/v1/users/{user_id}/tenants/{tenant_id} \
  -H "Authorization: Bearer <token>"
```

## 租户角色管理

每个租户可以定义自己的角色体系。详见 [RBAC 权限系统](RBAC权限系统.md)。

## 租户数据隔离

### 数据库级隔离

所有租户相关的数据表都包含 `tenant_id` 字段：

```sql
-- 用户-租户关系
CREATE TABLE tenant_users (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  user_id UUID NOT NULL,
  joined_at TIMESTAMP NOT NULL,
  FOREIGN KEY (tenant_id) REFERENCES tenants(id),
  FOREIGN KEY (user_id) REFERENCES users(id),
  UNIQUE (tenant_id, user_id)
);

-- 服务注册
CREATE TABLE services (
  id UUID PRIMARY KEY,
  tenant_id UUID NOT NULL,
  name VARCHAR(255) NOT NULL,
  -- ...
  FOREIGN KEY (tenant_id) REFERENCES tenants(id)
);
```

### API 级隔离

所有 API 请求都会验证租户归属：

```rust
// 示例：获取服务列表时自动过滤租户
async fn list_services(
    tenant_id: Uuid,
    user: AuthenticatedUser,
) -> Result<Vec<Service>> {
    // 验证用户是否属于该租户
    verify_tenant_membership(&user, &tenant_id)?;
    
    // 只返回该租户的服务
    let services = service_repo
        .find_by_tenant(tenant_id)
        .await?;
    
    Ok(services)
}
```

## 租户切换

用户可以属于多个租户，通过租户切换访问不同的资源。

### 通过 UI 切换

1. 点击顶部的租户选择器
2. 选择目标租户
3. 页面自动刷新，显示新租户的数据

### 通过 API 切换

```bash
# 在请求中指定租户 ID
curl https://api.auth9.yourdomain.com/api/v1/services \
  -H "Authorization: Bearer <token>" \
  -H "X-Tenant-ID: tenant-uuid"
```

### Token Exchange

使用 gRPC Token Exchange 获取特定租户的访问令牌：

```rust
let response = client.exchange_token(ExchangeTokenRequest {
    identity_token: user_token,
    tenant_id: "target-tenant-uuid",
    service_client_id: "my-service",
    scopes: vec!["read", "write"],
}).await?;

// 使用返回的 access_token 访问租户资源
```

## 租户配额管理

### 设置配额

```json
{
  "settings": {
    "quotas": {
      "max_users": 100,
      "max_services": 10,
      "max_roles": 50,
      "max_api_calls_per_day": 100000,
      "max_storage_gb": 10
    }
  }
}
```

### 监控配额使用

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/usage \
  -H "Authorization: Bearer <token>"
```

响应：

```json
{
  "data": {
    "users": {
      "current": 45,
      "limit": 100,
      "percentage": 45
    },
    "services": {
      "current": 5,
      "limit": 10,
      "percentage": 50
    },
    "api_calls_today": {
      "current": 12450,
      "limit": 100000,
      "percentage": 12.45
    }
  }
}
```

## 租户审计

所有租户相关的操作都会记录审计日志。

### 查询租户审计日志

```bash
curl "https://api.auth9.yourdomain.com/api/v1/audit-logs?tenant_id=tenant-uuid" \
  -H "Authorization: Bearer <token>"
```

### 审计事件类型

- `tenant.created` - 租户创建
- `tenant.updated` - 租户更新
- `tenant.disabled` - 租户禁用
- `tenant.settings_changed` - 配置变更
- `tenant.user_added` - 用户加入
- `tenant.user_removed` - 用户移除
- `tenant.service_registered` - 服务注册

## 最佳实践

### 1. 租户命名

- 使用清晰的名称
- Slug 使用小写字母和连字符
- 避免使用特殊字符

### 2. 配置管理

- 定期审查租户配置
- 根据安全需求调整密码策略
- 为敏感租户启用 MFA

### 3. 用户管理

- 使用域名白名单控制用户加入
- 定期清理不活跃用户
- 为用户分配合适的角色

### 4. 监控和告警

- 监控租户配额使用
- 设置配额告警
- 定期审查审计日志

### 5. 安全建议

- 启用 MFA
- 使用严格的密码策略
- 限制 session 超时时间
- 定期轮换密钥

## 常见问题

### Q: 一个用户可以属于多个租户吗？

A: 可以。Auth9 支持用户跨租户，一个用户可以同时属于多个租户，并在不同租户中拥有不同的角色。

### Q: 如何删除租户？

A: 目前只支持禁用租户，不支持物理删除。禁用后租户数据会保留，但无法访问。

### Q: 租户 slug 可以修改吗？

A: 不建议修改。Slug 可能被用在 URL 或其他集成中，修改会导致链接失效。

### Q: 如何迁移租户数据？

A: 请参考 [备份恢复](备份恢复.md) 文档。

### Q: 租户之间的数据会相互影响吗？

A: 不会。Auth9 在数据库、API 和缓存层都实现了完整的租户隔离。

## 相关文档

- [用户管理](用户管理.md)
- [RBAC 权限系统](RBAC权限系统.md)
- [REST API](REST-API.md)
- [最佳实践](最佳实践.md)
