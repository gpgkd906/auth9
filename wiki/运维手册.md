# Auth9 运维手册

本手册涵盖了 Auth9 平台的日常运维、备份恢复、升级维护和故障排查等操作指南。

## 目录

1. [服务管理](#1-服务管理)
2. [数据库维护](#2-数据库维护-tidb)
3. [缓存维护](#3-缓存维护-redis)
4. [Keycloak 维护](#4-keycloak-维护)
5. [备份与恢复](#5-备份与恢复)
6. [系统升级](#6-系统升级)
7. [日志与监控](#7-日志与监控)
8. [故障排查](#8-故障排查)
9. [灾难恢复](#9-灾难恢复)

---

## 1. 服务管理

Auth9 的核心服务运行在 Kubernetes 集群中。

### 检查服务状态

```bash
# 查看所有 Pod 状态
kubectl get pods -n auth9

# 查看 Deployment 状态
kubectl get deployments -n auth9

# 查看 Service 状态
kubectl get services -n auth9
```

### 重启服务

```bash
# 重启 auth9-core
kubectl rollout restart deployment/auth9-core -n auth9

# 重启 auth9-portal
kubectl rollout restart deployment/auth9-portal -n auth9
```

### 扩缩容

```bash
# 扩展 auth9-core 到 5 个副本
kubectl scale deployment/auth9-core --replicas=5 -n auth9
```

### 查看资源使用情况

```bash
kubectl top pods -n auth9
kubectl top nodes
```

---

## 2. 数据库维护 (TiDB)

Auth9 使用 TiDB 作为主数据库。

### 连接数据库

```bash
# 通过 MySQL 客户端连接
mysql -h <tidb-host> -P 4000 -u root -p
```

### 检查集群状态

如果使用 TiUP 部署：
```bash
tiup cluster display <cluster-name>
```

如果使用 TiDB Operator (K8s)：
```bash
kubectl get tidbcluster -n tidb-cluster
```

### 常用维护命令

```sql
-- 查看当前连接
SHOW PROCESSLIST;

-- 查看慢查询
SELECT * FROM INFORMATION_SCHEMA.SLOW_QUERY LIMIT 10;

-- 查看表大小
SELECT TABLE_NAME, table_rows, data_length, index_length, 
round(((data_length + index_length) / 1024 / 1024),2) "Size in MB" 
FROM information_schema.TABLES WHERE table_schema = "auth9";
```

---

## 3. 缓存维护 (Redis)

Redis 用于存储会话、Token 缓存和配置缓存。

### 连接 Redis

```bash
# 进入 Redis Pod
kubectl exec -it <redis-pod-name> -n auth9 -- redis-cli

# 如果有密码
auth <password>
```

### 常用操作

```bash
# 查看内存使用
info memory

# 查看键数量
dbsize

# 监控实时请求
monitor

# 清理所有缓存 (谨慎使用!)
flushall
```

### 缓存失效策略

- **用户角色**: 5分钟自动过期，RBAC 变更时主动失效
- **系统配置**: 10分钟自动过期，配置变更时主动失效
- **Session**: 随会话过期时间自动删除

---

## 4. Keycloak 维护

Keycloak 是 Auth9 的认证引擎。

### 访问管理控制台

通常不对外暴露，可通过端口转发访问：

```bash
kubectl port-forward svc/keycloak 8081:8080 -n auth9
```
访问 `http://localhost:8081`

### 常见操作

- **Realm 配置**: 检查 `auth9` realm 的配置
- **Client 管理**: 查看生成的 OIDC client
- **User Federation**: 检查 LDAP/AD 连接状态

### 升级 Keycloak

1. 备份 Keycloak 数据库
2. 更新 Deployment 镜像版本
3. 观察启动日志，确保存储迁移成功

---

## 5. 备份与恢复

### 数据库备份

#### 逻辑备份 (mydumper/dumpling)

```bash
# 备份 auth9 数据库
tiup dumpling -u root -P 4000 -h <host> -p <password> -B auth9 -o /backup/auth9-$(date +%Y%m%d)
```

#### 物理备份 (BR)

```bash
# 备份到 S3
tiup br backup full --pd <pd-addr> --storage "s3://backup-bucket/auth9"
```

### 配置文件备份

Kubernetes 中的 ConfigMap 和 Secret 应通过 GitOps (如 ArgoCD) 管理，代码库即备份。

### 恢复流程

#### 数据库恢复 (lightning/loader)

```bash
# 恢复数据
tiup lightning -tidb-host <host> -tidb-port 4000 -tidb-user root -tidb-password <pwd> -d /backup/auth9-20231027
```

---

## 6. 系统升级

Auth9 采用滚动更新策略，支持零停机升级。

### 升级步骤

1. **发布新镜像**: CI/CD 流水线构建并推送新镜像到 Registry。
2. **更新 Manifest**: 修改 K8s deployment yaml 中的 image tag。
3. **应用变更**:
   ```bash
   kubectl apply -f deploy/k8s/auth9-core-deployment.yaml
   kubectl apply -f deploy/k8s/auth9-portal-deployment.yaml
   ```
4. **监控状态**:
   ```bash
   kubectl rollout status deployment/auth9-core -n auth9
   ```

### 数据库迁移

Auth9 Core 启动时会自动运行 SQL 迁移。
- **向后兼容**: 确保所有数据库变更都是向后兼容的（如新增列、新增表）。
- **回滚**: 如果迁移失败，Pod 启动失败，K8s 会保留旧版本 Pod。

---

## 7. 日志与监控

### 查看日志

```bash
# 实时查看日志
kubectl logs -f deployment/auth9-core -n auth9

# 查看过去 1 小时的日志
kubectl logs --since=1h deployment/auth9-core -n auth9

# 筛选错误日志
kubectl logs deployment/auth9-core -n auth9 | grep "ERROR"
```

### 关键监控指标

- **HTTP 请求延迟**: P95, P99
- **HTTP 错误率**: 5xx 比例
- **gRPC Token 交换延迟**: 核心性能指标
- **数据库连接池**: 活跃连接数
- **Redis 命中率**: 缓存效率

---

## 8. 故障排查

### 场景一：Portal 无法访问

1. **检查 Pod 状态**:
   ```bash
   kubectl get pods -l app=auth9-portal -n auth9
   ```
2. **检查 Service**:
   ```bash
   kubectl get svc auth9-portal -n auth9
   ```
3. **检查 Cloudflare Tunnel**:
   ```bash
   kubectl logs deployment/cloudflared -n auth9
   ```

### 场景二：无法登录 (500 Error)

1. **查看 Auth9 Core 日志**:
   ```bash
   kubectl logs -l app=auth9-core -n auth9 --tail=100
   ```
2. **检查数据库连接**: 确认 TiDB 是否正常。
3. **检查 Keycloak**: 确认 Keycloak 服务是否响应。

### 场景三：gRPC Token 交换失败

1. **检查 gRPC 端口**: 确认 Service 是否正确暴露 50051 端口。
2. **检查网络策略**: 确认业务 Namespace 允许访问 Auth9 Namespace。
3. **验证 mTLS**: 如果启用了 mTLS，检查证书是否过期。

### 场景四：邮件发送失败

1. **检查系统设置**: 确认 SMTP 配置正确。
2. **测试连接**: 使用 `Send Test Email` 功能。
3. **查看日志**: 搜索 "mail" 或 "smtp" 相关的错误日志。

---

## 9. 灾难恢复

### 数据中心故障

如果整个 Kubernetes 集群不可用：

1. **切换 DNS**: 将 Cloudflare DNS 指向备用数据中心。
2. **恢复数据**: 在备用集群恢复数据库备份。
3. **启动服务**: 部署所有微服务。

### 关键凭证丢失

如果 `admin_auth9.token` 或 Keycloak 密码丢失：

1. **进入 Keycloak 容器**:
   ```bash
   kubectl exec -it keycloak-0 -n auth9 -- /bin/bash
   ```
2. **使用 add-user-keycloak 脚本**:
   ```bash
   /opt/keycloak/bin/add-user-keycloak.sh -u admin -p newpassword
   ```
3. **重启 Keycloak**。

---

**文档版本**: 1.0.0
**最后更新**: 2026-02-10
