# 邀请系统

Auth9 提供完整的用户邀请系统，支持通过邮件邀请用户加入租户，简化用户入职流程。

## 功能概述

- ✅ 邮件邀请用户加入租户
- ✅ 自定义邀请角色
- ✅ 邀请链接过期管理
- ✅ 邀请状态追踪
- ✅ 批量邀请支持
- ✅ 自定义邮件模板

## 邀请流程

### 1. 管理员发送邀请

```
管理员 → 填写邮箱和角色 → 系统生成邀请链接 → 发送邮件
```

### 2. 用户接受邀请

```
用户 → 收到邮件 → 点击链接 → 注册账号 → 自动加入租户
```

### 3. 邀请状态

| 状态 | 说明 | 后续操作 |
|------|------|---------|
| **Pending** | 已发送，等待接受 | 用户可点击链接注册 |
| **Accepted** | 已接受 | 用户已成功加入租户 |
| **Expired** | 已过期 | 需要重新发送邀请 |
| **Revoked** | 已撤销 | 邀请链接失效 |

## 使用指南

### 通过管理界面发送邀请

1. 登录 Auth9 Portal
2. 导航到 **Users** > **Invitations**
3. 点击 **Send Invitation** 按钮
4. 填写邀请信息：
   - **Email**: 受邀用户的邮箱地址
   - **Tenant**: 目标租户
   - **Role**: 分配的初始角色
   - **Expiry**: 邀请过期时间（默认 7 天）
   - **Message**: 可选的欢迎消息
5. 点击 **Send** 发送邀请

### 通过 REST API 发送邀请

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/invitations \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "email": "newuser@example.com",
    "role_id": "role-uuid",
    "expires_in_days": 7,
    "custom_message": "欢迎加入我们的团队！"
  }'
```

响应：

```json
{
  "data": {
    "id": "invitation-uuid",
    "email": "newuser@example.com",
    "tenant_id": "tenant-uuid",
    "role_id": "role-uuid",
    "status": "pending",
    "invitation_url": "https://auth9.yourdomain.com/invitations/accept?token=...",
    "expires_at": "2024-01-08T00:00:00Z",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 查看邀请列表

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/invitations \
  -H "Authorization: Bearer <token>"
```

支持的查询参数：
- `status`: 按状态筛选（pending/accepted/expired/revoked）
- `email`: 按邮箱搜索
- `page`: 页码
- `per_page`: 每页数量

### 撤销邀请

管理员可以撤销未接受的邀请：

```bash
curl -X DELETE https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/invitations/{invitation_id} \
  -H "Authorization: Bearer <token>"
```

撤销后，邀请链接将立即失效。

### 重新发送邀请

对于已过期或未收到的邀请，可以重新发送：

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/invitations/{invitation_id}/resend \
  -H "Authorization: Bearer <token>"
```

系统会生成新的邀请链接并发送邮件。

## 用户接受邀请

### 1. 点击邀请链接

用户收到邮件后，点击邮件中的邀请链接：

```
https://auth9.yourdomain.com/invitations/accept?token=invitation_token
```

### 2. 注册账号

- 如果用户已有账号，直接登录即可加入租户
- 如果是新用户，需要完成注册流程：
  - 设置密码
  - 填写个人信息
  - 确认邮箱

### 3. 自动加入租户

注册完成后，用户自动加入目标租户，并获得邀请时指定的角色。

## 邀请邮件模板

邀请邮件支持自定义模板，包括以下变量：

| 变量 | 说明 |
|------|------|
| `{{tenant_name}}` | 租户名称 |
| `{{sender_name}}` | 发送者姓名 |
| `{{recipient_email}}` | 受邀者邮箱 |
| `{{role_name}}` | 分配的角色名称 |
| `{{invitation_url}}` | 邀请链接 |
| `{{expires_at}}` | 过期时间 |
| `{{custom_message}}` | 自定义消息 |

默认邮件模板示例：

```html
<h2>欢迎加入 {{tenant_name}}！</h2>

<p>您好，</p>

<p>{{sender_name}} 邀请您加入 {{tenant_name}} 团队，担任 <strong>{{role_name}}</strong> 角色。</p>

{{#if custom_message}}
<p>{{custom_message}}</p>
{{/if}}

<p>
  <a href="{{invitation_url}}" style="padding: 12px 24px; background: #007AFF; color: white; text-decoration: none; border-radius: 8px;">
    接受邀请
  </a>
</p>

<p>
  <small>此邀请链接将在 {{expires_at}} 过期。</small>
</p>

<p>如果您无法点击按钮，请复制以下链接到浏览器：<br>
{{invitation_url}}</p>
```

可以在 **Settings** > **Email Templates** 中自定义邀请邮件模板。

## 批量邀请

对于需要邀请多个用户的场景，支持批量邀请：

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/invitations/batch \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "invitations": [
      {
        "email": "user1@example.com",
        "role_id": "role-uuid-1"
      },
      {
        "email": "user2@example.com",
        "role_id": "role-uuid-2"
      },
      {
        "email": "user3@example.com",
        "role_id": "role-uuid-1"
      }
    ],
    "expires_in_days": 7,
    "custom_message": "欢迎加入我们的团队！"
  }'
```

响应：

```json
{
  "data": {
    "total": 3,
    "successful": 2,
    "failed": 1,
    "results": [
      {
        "email": "user1@example.com",
        "status": "sent",
        "invitation_id": "inv-uuid-1"
      },
      {
        "email": "user2@example.com",
        "status": "sent",
        "invitation_id": "inv-uuid-2"
      },
      {
        "email": "user3@example.com",
        "status": "failed",
        "error": "用户已存在于该租户"
      }
    ]
  }
}
```

## 安全考虑

### 邀请令牌安全

- ✅ 使用加密签名的 JWT Token
- ✅ Token 仅能使用一次
- ✅ Token 包含过期时间
- ✅ Token 绑定邮箱地址

### 防止滥用

- ✅ 限制单个租户的邀请发送频率
- ✅ 验证邮箱格式和域名
- ✅ 记录所有邀请操作的审计日志
- ✅ 管理员权限验证

### 邮件发送

- ✅ 使用 SMTP TLS 加密传输
- ✅ SPF/DKIM 签名防止伪造
- ✅ 重试机制确保送达
- ✅ 发送失败通知管理员

## 配置选项

在租户设置中可以配置邀请相关选项：

```json
{
  "invitation_settings": {
    "default_expiry_days": 7,
    "max_pending_invitations": 100,
    "allow_domain_restriction": true,
    "allowed_email_domains": ["example.com"],
    "require_admin_approval": false,
    "send_welcome_email": true
  }
}
```

| 选项 | 说明 | 默认值 |
|------|------|-------|
| `default_expiry_days` | 默认过期天数 | 7 |
| `max_pending_invitations` | 最大待处理邀请数 | 100 |
| `allow_domain_restriction` | 是否限制邮箱域名 | false |
| `allowed_email_domains` | 允许的邮箱域名列表 | [] |
| `require_admin_approval` | 接受邀请是否需要管理员批准 | false |
| `send_welcome_email` | 接受后发送欢迎邮件 | true |

## 常见问题

### 用户收不到邀请邮件？

1. 检查邮箱地址是否正确
2. 查看垃圾邮件文件夹
3. 验证 SMTP 配置是否正确
4. 查看审计日志确认邮件发送状态
5. 使用"重新发送"功能

### 邀请链接已过期？

1. 管理员可以撤销旧邀请
2. 发送新的邀请
3. 或者在租户设置中延长默认过期时间

### 可以修改已发送的邀请吗？

不能直接修改。需要：
1. 撤销原邀请
2. 发送新邀请，使用新的角色或设置

### 用户已有账号但收到邀请？

用户可以直接登录现有账号，点击邀请链接后会自动将其添加到新租户。

## 审计追踪

所有邀请相关操作都会记录到审计日志：

- 邀请创建
- 邀请发送
- 邀请接受
- 邀请撤销
- 邀请过期

可以在 **Audit Logs** 中查询和分析。

## 相关文档

- [用户管理](多租户管理.md#用户管理)
- [RBAC 权限系统](RBAC权限系统.md)
- [邮件模板](邮件模板.md)
- [REST API](REST-API.md#邀请-api)
- [审计日志](最佳实践.md#审计日志)

---

**最后更新**: 2026-02-04
