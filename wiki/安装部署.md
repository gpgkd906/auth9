# 安装部署

本文档介绍 Auth9 的各种安装部署方式。

## 部署方式概览

| 方式 | 适用场景 | 难度 |
|-----|---------|-----|
| Docker Compose | 开发测试 | ⭐ |
| Kubernetes | 生产环境 | ⭐⭐⭐ |
| 源码构建 | 定制开发 | ⭐⭐⭐⭐ |

## 1. Docker Compose 部署

### 1.1 系统要求

- Docker 20.10+
- Docker Compose 2.0+
- 4GB+ 内存
- 20GB+ 磁盘空间

### 1.2 快速部署

```bash
# 克隆仓库
git clone https://github.com/gpgkd906/auth9.git
cd auth9

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 1.3 服务端口

| 服务 | 端口 | 用途 |
|------|------|------|
| auth9-portal | 3000 | 管理界面 |
| auth9-core | 8080 | REST API |
| auth9-core | 50051 | gRPC API |
| TiDB | 4000 | 数据库 |
| Redis | 6379 | 缓存 |
| Keycloak | 8081 | 认证引擎 |

### 1.4 配置自定义

创建 `docker-compose.override.yml`:

```yaml
version: '3.8'

services:
  auth9-core:
    environment:
      - JWT_SECRET=your-custom-secret
      - JWT_ISSUER=https://auth9.yourdomain.com
    ports:
      - "18080:8080"  # 自定义端口映射

  auth9-portal:
    ports:
      - "13000:3000"
```

### 1.5 数据持久化

默认配置已包含数据卷：

```yaml
volumes:
  tidb_data:      # TiDB 数据
  redis_data:     # Redis 数据
  keycloak_data:  # Keycloak 数据
```

## 2. Kubernetes 部署

### 2.1 前置要求

- Kubernetes 1.20+
- kubectl 已配置
- Helm 3.0+ (可选)
- 存储类 (StorageClass)
- cloudflared（推荐）或其他隧道方案用于安全暴露服务

### 2.2 创建命名空间

```bash
kubectl create namespace auth9
```

### 2.3 配置 Secrets

```bash
# 创建数据库密钥
kubectl create secret generic auth9-db-secret \
  --from-literal=DATABASE_URL='mysql://root:password@tidb:4000/auth9' \
  -n auth9

# 创建 JWT 密钥
kubectl create secret generic auth9-jwt-secret \
  --from-literal=JWT_SECRET='your-strong-secret-key' \
  -n auth9

# 创建 Keycloak 密钥
kubectl create secret generic auth9-keycloak-secret \
  --from-literal=ADMIN_USERNAME='admin' \
  --from-literal=ADMIN_PASSWORD='admin-password' \
  -n auth9
```

### 2.4 部署数据库 (TiDB)

```bash
# 使用 TiDB Operator (推荐)
kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/crd.yaml
kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/tidb-operator.yaml

# 或使用简化版 MySQL
kubectl apply -f deploy/k8s/mysql.yaml
```

### 2.5 部署 Redis

```bash
# 部署 Redis
kubectl apply -f deploy/k8s/redis.yaml

# 或使用 Helm
helm install redis bitnami/redis \
  --namespace auth9 \
  --set auth.enabled=false \
  --set master.persistence.enabled=true \
  --set master.persistence.size=5Gi
```

### 2.6 部署 Keycloak

```bash
kubectl apply -f deploy/k8s/keycloak.yaml
```

### 2.7 部署 Auth9 Core

```yaml
# deploy/k8s/auth9-core.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth9-core
  namespace: auth9
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth9-core
  template:
    metadata:
      labels:
        app: auth9-core
    spec:
      containers:
      - name: auth9-core
        image: ghcr.io/gpgkd906/auth9-core:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 50051
          name: grpc
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: auth9-db-secret
              key: DATABASE_URL
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: auth9-jwt-secret
              key: JWT_SECRET
        - name: REDIS_URL
          value: "redis://redis:6379"
        - name: KEYCLOAK_URL
          value: "http://keycloak:8080"
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: auth9-core
  namespace: auth9
spec:
  selector:
    app: auth9-core
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  - name: grpc
    port: 50051
    targetPort: 50051
```

```bash
kubectl apply -f deploy/k8s/auth9-core.yaml
```

### 2.8 部署 Auth9 Portal

```yaml
# deploy/k8s/auth9-portal.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth9-portal
  namespace: auth9
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth9-portal
  template:
    metadata:
      labels:
        app: auth9-portal
    spec:
      containers:
      - name: auth9-portal
        image: ghcr.io/gpgkd906/auth9-portal:latest
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: API_URL
          value: "http://auth9-core:8080"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: auth9-portal
  namespace: auth9
spec:
  selector:
    app: auth9-portal
  ports:
  - port: 3000
    targetPort: 3000
```

```bash
kubectl apply -f deploy/k8s/auth9-portal.yaml
```

### 2.9 配置外部访问（Cloudflared）

Auth9 推荐使用 **cloudflared** 通过 Cloudflare Tunnel 安全暴露服务，而非传统的 Ingress Controller。这种方式的优势：

- **无需公网 IP** - 集群可以部署在 NAT 后面
- **自动 TLS** - Cloudflare 边缘自动处理证书
- **DDoS 防护** - 受益于 Cloudflare 的安全防护
- **简化架构** - 无需维护 Ingress Controller

#### 2.9.1 部署 cloudflared

```yaml
# deploy/k8s/cloudflared.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: cloudflared
  namespace: auth9
  labels:
    app: cloudflared
spec:
  replicas: 2
  selector:
    matchLabels:
      app: cloudflared
  template:
    metadata:
      labels:
        app: cloudflared
    spec:
      containers:
      - name: cloudflared
        image: cloudflare/cloudflared:latest
        args:
        - tunnel
        - --config
        - /etc/cloudflared/config.yaml
        - run
        volumeMounts:
        - name: config
          mountPath: /etc/cloudflared
          readOnly: true
        - name: credentials
          mountPath: /etc/cloudflared/creds
          readOnly: true
        resources:
          requests:
            cpu: 100m
            memory: 128Mi
          limits:
            cpu: 500m
            memory: 256Mi
        livenessProbe:
          httpGet:
            path: /ready
            port: 2000
          initialDelaySeconds: 10
          periodSeconds: 10
      volumes:
      - name: config
        configMap:
          name: cloudflared-config
      - name: credentials
        secret:
          secretName: cloudflared-credentials
```

#### 2.9.2 配置 Tunnel

1. **在 Cloudflare Dashboard 创建 Tunnel**

```bash
# 安装 cloudflared CLI（本地）
brew install cloudflare/cloudflare/cloudflared  # macOS
# 或 apt install cloudflared                    # Debian/Ubuntu

# 登录 Cloudflare
cloudflared tunnel login

# 创建 Tunnel
cloudflared tunnel create auth9-tunnel

# 记录 Tunnel ID（输出中的 UUID）
```

2. **创建 Kubernetes Secret**

```bash
# 复制凭证文件到集群
kubectl create secret generic cloudflared-credentials \
  --from-file=credentials.json=/Users/you/.cloudflared/<TUNNEL_ID>.json \
  -n auth9
```

3. **创建 ConfigMap**

```yaml
# cloudflared-configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflared-config
  namespace: auth9
data:
  config.yaml: |
    tunnel: <TUNNEL_ID>
    credentials-file: /etc/cloudflared/creds/credentials.json
    metrics: 0.0.0.0:2000
    no-autoupdate: true

    ingress:
      # Auth9 Portal (管理界面)
      - hostname: auth9.yourdomain.com
        service: http://auth9-portal:3000
        originRequest:
          noTLSVerify: true

      # Auth9 API
      - hostname: api.auth9.yourdomain.com
        service: http://auth9-core:8080
        originRequest:
          noTLSVerify: true

      # Keycloak (登录页面)
      - hostname: login.auth9.yourdomain.com
        service: http://keycloak:8080
        originRequest:
          noTLSVerify: true

      # gRPC API (可选)
      - hostname: grpc.auth9.yourdomain.com
        service: grpc://auth9-core:50051

      # Catch-all (必须)
      - service: http_status:404
```

4. **配置 DNS**

```bash
# 添加 CNAME 记录指向 Tunnel
cloudflared tunnel route dns auth9-tunnel auth9.yourdomain.com
cloudflared tunnel route dns auth9-tunnel api.auth9.yourdomain.com
cloudflared tunnel route dns auth9-tunnel login.auth9.yourdomain.com
```

5. **部署**

```bash
kubectl apply -f cloudflared-configmap.yaml
kubectl apply -f deploy/k8s/cloudflared.yaml
```

#### 2.9.3 验证 Tunnel

```bash
# 检查 cloudflared Pod 状态
kubectl get pods -l app=cloudflared -n auth9

# 查看日志
kubectl logs -l app=cloudflared -n auth9

# 在 Cloudflare Dashboard 查看 Tunnel 状态
# https://dash.cloudflare.com -> Zero Trust -> Access -> Tunnels
```

#### 2.9.4 流量路由拓扑

```
Internet
    ↓
Cloudflare Edge (TLS 终止, DDoS 防护)
    ↓
Cloudflare Tunnel (加密连接)
    ↓
cloudflared Pod (K8s 集群内)
    ├─ auth9.yourdomain.com → auth9-portal:3000
    ├─ api.auth9.yourdomain.com → auth9-core:8080
    ├─ login.auth9.yourdomain.com → keycloak:8080
    └─ grpc.auth9.yourdomain.com → auth9-core:50051 (gRPC)

### 2.10 验证部署

```bash
# 检查所有 Pod 状态
kubectl get pods -n auth9

# 检查服务
kubectl get svc -n auth9

# 查看日志
kubectl logs -f deployment/auth9-core -n auth9
kubectl logs -f deployment/auth9-portal -n auth9
```

## 3. 源码构建部署

### 3.1 构建 auth9-core

#### 前置要求

- Rust 1.70+
- Cargo
- Protocol Buffers compiler (protoc)

#### 构建步骤

```bash
cd auth9-core

# 安装依赖
cargo build --release

# 运行数据库迁移
sqlx migrate run

# 启动服务
./target/release/auth9-core
```

### 3.2 构建 auth9-portal

#### 前置要求

- Node.js 18+
- npm 或 yarn

#### 构建步骤

```bash
cd auth9-portal

# 安装依赖
npm install

# 构建
npm run build

# 启动
npm run start
```

### 3.3 Docker 镜像构建

```bash
# 构建 auth9-core
docker build -t auth9-core:local -f auth9-core/Dockerfile auth9-core/

# 构建 auth9-portal
docker build -t auth9-portal:local -f auth9-portal/Dockerfile auth9-portal/
```

## 4. 生产环境配置

### 4.1 环境变量

详见 [配置说明](配置说明.md)

### 4.2 性能调优

```yaml
# auth9-core 资源配置
resources:
  requests:
    cpu: 1000m
    memory: 1Gi
  limits:
    cpu: 4000m
    memory: 4Gi

# HPA 自动伸缩
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: auth9-core-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auth9-core
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### 4.3 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_tenant_users_tenant_id ON tenant_users(tenant_id);
CREATE INDEX idx_tenant_users_user_id ON tenant_users(user_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_user_tenant_roles_tenant_user_id ON user_tenant_roles(tenant_user_id);
```

### 4.4 Redis 配置

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
tcp-backlog 511
timeout 300
```

## 5. 升级指南

### 5.1 滚动升级

```bash
# 更新镜像
kubectl set image deployment/auth9-core \
  auth9-core=ghcr.io/gpgkd906/auth9-core:v1.1.0 \
  -n auth9

# 检查升级状态
kubectl rollout status deployment/auth9-core -n auth9

# 如需回滚
kubectl rollout undo deployment/auth9-core -n auth9
```

### 5.2 数据库迁移

```bash
# 备份数据库
mysqldump -h tidb -u root -p auth9 > backup.sql

# 运行迁移
kubectl exec -it deployment/auth9-core -n auth9 -- \
  /app/auth9-core migrate
```

## 6. 卸载

### 6.1 Docker Compose

```bash
# 停止并删除容器
docker-compose down

# 删除数据卷
docker-compose down -v
```

### 6.2 Kubernetes

```bash
# 删除所有资源
kubectl delete namespace auth9

# 或分别删除
kubectl delete -f deploy/k8s/ -n auth9
```

## 相关文档

- [快速开始](快速开始.md)
- [配置说明](配置说明.md)
- [生产部署](生产部署.md)
- [备份恢复](备份恢复.md)
