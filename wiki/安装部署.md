# 安装部署

本文档介绍 Auth9 的各种安装部署方式。

## 部署方式概览

| 方式 | 适用场景 | 难度 |
|-----|---------|-----|
| Docker Compose | 开发测试 | ⭐ |
| Kubernetes | 生产环境 | ⭐⭐⭐ |
| 源码构建 | 定制开发 | ⭐⭐⭐⭐ |

## 1. Docker Compose 部署

### 1.1 系统要求

- Docker 20.10+
- Docker Compose 2.0+
- 4GB+ 内存
- 20GB+ 磁盘空间

### 1.2 快速部署

```bash
# 克隆仓库
git clone https://github.com/gpgkd906/auth9.git
cd auth9

# 启动所有服务
docker-compose up -d

# 查看服务状态
docker-compose ps

# 查看日志
docker-compose logs -f
```

### 1.3 服务端口

| 服务 | 端口 | 用途 |
|------|------|------|
| auth9-portal | 3000 | 管理界面 |
| auth9-core | 8080 | REST API |
| auth9-core | 50051 | gRPC API |
| TiDB | 4000 | 数据库 |
| Redis | 6379 | 缓存 |
| Keycloak | 8081 | 认证引擎 |

### 1.4 配置自定义

创建 `docker-compose.override.yml`:

```yaml
version: '3.8'

services:
  auth9-core:
    environment:
      - JWT_SECRET=your-custom-secret
      - JWT_ISSUER=https://auth9.yourdomain.com
    ports:
      - "18080:8080"  # 自定义端口映射

  auth9-portal:
    ports:
      - "13000:3000"
```

### 1.5 数据持久化

默认配置已包含数据卷：

```yaml
volumes:
  tidb_data:      # TiDB 数据
  redis_data:     # Redis 数据
  keycloak_data:  # Keycloak 数据
```

## 2. Kubernetes 部署

### 2.1 前置要求

- Kubernetes 1.20+
- kubectl 已配置
- Helm 3.0+ (可选)
- 存储类 (StorageClass)
- 负载均衡器 (LoadBalancer) 或 Ingress Controller

### 2.2 创建命名空间

```bash
kubectl create namespace auth9
```

### 2.3 配置 Secrets

```bash
# 创建数据库密钥
kubectl create secret generic auth9-db-secret \
  --from-literal=DATABASE_URL='mysql://root:password@tidb:4000/auth9' \
  -n auth9

# 创建 JWT 密钥
kubectl create secret generic auth9-jwt-secret \
  --from-literal=JWT_SECRET='your-strong-secret-key' \
  -n auth9

# 创建 Keycloak 密钥
kubectl create secret generic auth9-keycloak-secret \
  --from-literal=ADMIN_USERNAME='admin' \
  --from-literal=ADMIN_PASSWORD='admin-password' \
  -n auth9
```

### 2.4 部署数据库 (TiDB)

```bash
# 使用 TiDB Operator (推荐)
kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/crd.yaml
kubectl apply -f https://raw.githubusercontent.com/pingcap/tidb-operator/master/manifests/tidb-operator.yaml

# 或使用简化版 MySQL
kubectl apply -f deploy/k8s/mysql.yaml
```

### 2.5 部署 Redis

```bash
# 部署 Redis
kubectl apply -f deploy/k8s/redis.yaml

# 或使用 Helm
helm install redis bitnami/redis \
  --namespace auth9 \
  --set auth.enabled=false \
  --set master.persistence.enabled=true \
  --set master.persistence.size=5Gi
```

### 2.6 部署 Keycloak

```bash
kubectl apply -f deploy/k8s/keycloak.yaml
```

### 2.7 部署 Auth9 Core

```yaml
# deploy/k8s/auth9-core.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth9-core
  namespace: auth9
spec:
  replicas: 3
  selector:
    matchLabels:
      app: auth9-core
  template:
    metadata:
      labels:
        app: auth9-core
    spec:
      containers:
      - name: auth9-core
        image: ghcr.io/gpgkd906/auth9-core:latest
        ports:
        - containerPort: 8080
          name: http
        - containerPort: 50051
          name: grpc
        env:
        - name: DATABASE_URL
          valueFrom:
            secretKeyRef:
              name: auth9-db-secret
              key: DATABASE_URL
        - name: JWT_SECRET
          valueFrom:
            secretKeyRef:
              name: auth9-jwt-secret
              key: JWT_SECRET
        - name: REDIS_URL
          value: "redis://redis:6379"
        - name: KEYCLOAK_URL
          value: "http://keycloak:8080"
        resources:
          requests:
            cpu: 500m
            memory: 512Mi
          limits:
            cpu: 2000m
            memory: 2Gi
        livenessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 30
          periodSeconds: 10
        readinessProbe:
          httpGet:
            path: /health
            port: 8080
          initialDelaySeconds: 10
          periodSeconds: 5
---
apiVersion: v1
kind: Service
metadata:
  name: auth9-core
  namespace: auth9
spec:
  selector:
    app: auth9-core
  ports:
  - name: http
    port: 8080
    targetPort: 8080
  - name: grpc
    port: 50051
    targetPort: 50051
```

```bash
kubectl apply -f deploy/k8s/auth9-core.yaml
```

### 2.8 部署 Auth9 Portal

```yaml
# deploy/k8s/auth9-portal.yaml
apiVersion: apps/v1
kind: Deployment
metadata:
  name: auth9-portal
  namespace: auth9
spec:
  replicas: 2
  selector:
    matchLabels:
      app: auth9-portal
  template:
    metadata:
      labels:
        app: auth9-portal
    spec:
      containers:
      - name: auth9-portal
        image: ghcr.io/gpgkd906/auth9-portal:latest
        ports:
        - containerPort: 3000
          name: http
        env:
        - name: API_URL
          value: "http://auth9-core:8080"
        resources:
          requests:
            cpu: 200m
            memory: 256Mi
          limits:
            cpu: 1000m
            memory: 1Gi
---
apiVersion: v1
kind: Service
metadata:
  name: auth9-portal
  namespace: auth9
spec:
  selector:
    app: auth9-portal
  ports:
  - port: 3000
    targetPort: 3000
```

```bash
kubectl apply -f deploy/k8s/auth9-portal.yaml
```

### 2.9 配置 Ingress

```yaml
# deploy/k8s/ingress.yaml
apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: auth9-ingress
  namespace: auth9
  annotations:
    kubernetes.io/ingress.class: nginx
    cert-manager.io/cluster-issuer: letsencrypt-prod
spec:
  tls:
  - hosts:
    - auth9.yourdomain.com
    - api.auth9.yourdomain.com
    secretName: auth9-tls
  rules:
  - host: auth9.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: auth9-portal
            port:
              number: 3000
  - host: api.auth9.yourdomain.com
    http:
      paths:
      - path: /
        pathType: Prefix
        backend:
          service:
            name: auth9-core
            port:
              number: 8080
```

```bash
kubectl apply -f deploy/k8s/ingress.yaml
```

### 2.10 验证部署

```bash
# 检查所有 Pod 状态
kubectl get pods -n auth9

# 检查服务
kubectl get svc -n auth9

# 查看日志
kubectl logs -f deployment/auth9-core -n auth9
kubectl logs -f deployment/auth9-portal -n auth9
```

## 3. 源码构建部署

### 3.1 构建 auth9-core

#### 前置要求

- Rust 1.70+
- Cargo
- Protocol Buffers compiler (protoc)

#### 构建步骤

```bash
cd auth9-core

# 安装依赖
cargo build --release

# 运行数据库迁移
sqlx migrate run

# 启动服务
./target/release/auth9-core
```

### 3.2 构建 auth9-portal

#### 前置要求

- Node.js 18+
- npm 或 yarn

#### 构建步骤

```bash
cd auth9-portal

# 安装依赖
npm install

# 构建
npm run build

# 启动
npm run start
```

### 3.3 Docker 镜像构建

```bash
# 构建 auth9-core
docker build -t auth9-core:local -f auth9-core/Dockerfile auth9-core/

# 构建 auth9-portal
docker build -t auth9-portal:local -f auth9-portal/Dockerfile auth9-portal/
```

## 4. 生产环境配置

### 4.1 环境变量

详见 [配置说明](配置说明.md)

### 4.2 性能调优

```yaml
# auth9-core 资源配置
resources:
  requests:
    cpu: 1000m
    memory: 1Gi
  limits:
    cpu: 4000m
    memory: 4Gi

# HPA 自动伸缩
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: auth9-core-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auth9-core
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
```

### 4.3 数据库优化

```sql
-- 创建索引
CREATE INDEX idx_tenant_users_tenant_id ON tenant_users(tenant_id);
CREATE INDEX idx_tenant_users_user_id ON tenant_users(user_id);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_user_tenant_roles_tenant_user_id ON user_tenant_roles(tenant_user_id);
```

### 4.4 Redis 配置

```conf
# redis.conf
maxmemory 2gb
maxmemory-policy allkeys-lru
tcp-backlog 511
timeout 300
```

## 5. 升级指南

### 5.1 滚动升级

```bash
# 更新镜像
kubectl set image deployment/auth9-core \
  auth9-core=ghcr.io/gpgkd906/auth9-core:v1.1.0 \
  -n auth9

# 检查升级状态
kubectl rollout status deployment/auth9-core -n auth9

# 如需回滚
kubectl rollout undo deployment/auth9-core -n auth9
```

### 5.2 数据库迁移

```bash
# 备份数据库
mysqldump -h tidb -u root -p auth9 > backup.sql

# 运行迁移
kubectl exec -it deployment/auth9-core -n auth9 -- \
  /app/auth9-core migrate
```

## 6. 卸载

### 6.1 Docker Compose

```bash
# 停止并删除容器
docker-compose down

# 删除数据卷
docker-compose down -v
```

### 6.2 Kubernetes

```bash
# 删除所有资源
kubectl delete namespace auth9

# 或分别删除
kubectl delete -f deploy/k8s/ -n auth9
```

## 相关文档

- [快速开始](快速开始.md)
- [配置说明](配置说明.md)
- [生产部署](生产部署.md)
- [备份恢复](备份恢复.md)
