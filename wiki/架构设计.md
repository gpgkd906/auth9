# 架构设计

## 1. 系统概述

Auth9 是一个现代化的身份认证和访问管理平台，采用微服务架构设计，基于 Rust 和 TypeScript 构建。

### 1.1 设计理念

- **Headless Keycloak**: Keycloak 仅负责核心 OIDC 协议、MFA 和基础账号存储
- **管理面与数据面合一**: Auth9 提供统一的管理界面和 API 服务
- **Token 瘦身策略**: 通过 Token Exchange 机制，按需获取租户和角色信息

### 1.2 核心优势

- ✅ **高性能**: Rust 后端，Token 交换延迟 < 20ms
- ✅ **可扩展**: 无状态设计，支持水平扩展
- ✅ **易维护**: 清晰的模块划分和代码组织
- ✅ **安全性**: 企业级安全设计和审计能力

## 2. 架构总览

```
┌─────────────────────────────────────────────────────────────────┐
│                        客户端层                                  │
├─────────────────┬─────────────────────┬─────────────────────────┤
│  auth9-portal   │  业务服务            │      auth9-sdk          │
│  (Remix SSR)    │                     │      (可选)             │
└────────┬────────┴──────────┬──────────┴────────────┬────────────┘
         │ REST API          │ gRPC                   │ gRPC
         ▼                   ▼                        ▼
┌─────────────────────────────────────────────────────────────────┐
│                       auth9-core (Rust)                          │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐           │
│  │  REST API    │  │ gRPC Server  │  │  JWT Engine  │           │
│  └──────────────┘  └──────────────┘  └──────────────┘           │
└────────┬────────────────────┬────────────────────────────────────┘
         │                    │
    ┌────┴────┐          ┌────┴────┐
    │  TiDB   │          │  Redis  │
    │ (MySQL) │          │ (Cache) │
    └─────────┘          └─────────┘
```

## 3. 组件详解

### 3.1 auth9-core (核心后端)

**技术栈**: Rust + axum + tonic + sqlx

**职责**:
- REST API 服务 (端口 8080)
- gRPC 服务 (端口 50051)
- Token 签发和验证
- 与 Keycloak 集成
- 业务逻辑处理

**模块结构**:

```
auth9-core/
├── src/
│   ├── api/              # REST API 路由和处理器
│   │   ├── tenant.rs     # 租户管理 API
│   │   ├── user.rs       # 用户管理 API
│   │   ├── service.rs    # 服务注册 API
│   │   ├── role.rs       # 角色管理 API
│   │   ├── auth.rs       # 认证相关 API
│   │   ├── invitation.rs # 邀请管理 API
│   │   ├── branding.rs   # 品牌定制 API
│   │   ├── email_template.rs # 邮件模板 API
│   │   ├── system_settings.rs # 系统设置 API
│   │   └── audit.rs      # 审计日志 API
│   ├── grpc/             # gRPC 服务实现
│   │   └── token_exchange.rs  # Token 交换服务
│   ├── domain/           # 领域模型
│   ├── repository/       # 数据访问层
│   ├── service/          # 业务逻辑层
│   ├── keycloak/         # Keycloak 客户端
│   ├── jwt/              # JWT 处理
│   ├── cache/            # Redis 缓存
│   ├── email/            # 邮件发送服务
│   ├── crypto/           # 加密工具
│   └── error/            # 错误处理
```

### 3.2 auth9-portal (管理界面)

**技术栈**: Remix + TypeScript + Tailwind CSS

**职责**:
- 提供管理界面
- 租户、用户、服务管理
- 角色和权限配置
- 审计日志查询

**技术特点**:
- 服务端渲染 (SSR)
- 苹果风格设计
- 响应式布局
- 实时更新

### 3.3 auth9-keycloak-theme (认证界面主题)

**技术栈**: TypeScript + Vite + Keycloak Theme

**职责**:
- 自定义 Keycloak 登录界面
- 统一的品牌视觉设计
- 响应式布局
- 多语言支持

**构建流程**:
- 使用 Vite 构建前端资源
- 打包为 Keycloak JAR 主题包
- 支持热更新开发

### 3.4 数据存储

#### TiDB (主数据库)

- MySQL 兼容
- 分布式事务
- 水平扩展
- 高可用

**核心表**:
- `tenants` - 租户信息
- `users` - 用户账号
- `tenant_users` - 用户-租户关系
- `services` - 服务注册表
- `roles` - 角色定义
- `permissions` - 权限点
- `role_permissions` - 角色-权限映射
- `user_tenant_roles` - 用户角色分配
- `audit_logs` - 审计日志
- `invitations` - 邀请记录
- `branding_configs` - 品牌配置
- `email_templates` - 邮件模板
- `system_settings` - 系统设置

#### Redis (缓存层)

**缓存内容**:
- 用户-租户-角色映射 (TTL: 5分钟)
- 服务配置 (TTL: 10分钟)
- JWKS 公钥 (TTL: 1小时)
- Session 数据

### 3.5 Keycloak (认证引擎)

**用途**:
- OIDC 协议实现
- 用户认证
- MFA 管理
- 密码策略

**集成方式**:
- Auth9 通过 Admin REST API 管理 Keycloak
- Keycloak 不直接暴露给最终用户
- Auth9 作为 Keycloak 的门面
- 支持自定义主题（auth9-keycloak-theme）

## 4. 数据流设计

### 4.1 用户认证流程

```
1. 用户访问业务服务
   ↓
2. 业务服务发现用户未登录
   ↓
3. 重定向到 Auth9 登录页面
   ↓
4. Auth9 重定向到 Keycloak 认证
   ↓
5. 用户输入凭证
   ↓
6. Keycloak 验证成功，返回 Authorization Code
   ↓
7. Auth9 用 Code 换取 Identity Token
   ↓
8. Auth9 将 Identity Token 返回给业务服务
   ↓
9. 业务服务持有 Identity Token
```

### 4.2 Token 交换流程

```
1. 业务服务收到请求，需要验证用户在特定租户的权限
   ↓
2. 业务服务通过 gRPC 调用 Auth9 的 ExchangeToken
   ↓
3. Auth9 验证 Identity Token
   ↓
4. Auth9 查询用户在指定租户的角色（优先从缓存）
   ↓
5. Auth9 生成包含租户和角色信息的 Tenant Access Token
   ↓
6. 返回 Tenant Access Token 给业务服务
   ↓
7. 业务服务使用该 Token 进行权限判断
```

## 5. 安全设计

### 5.1 认证安全

- ✅ 基于标准 OIDC 协议
- ✅ 支持 MFA 多因素认证
- ✅ JWT Token 带签名
- ✅ Token 过期时间控制
- ✅ Refresh Token 轮转

### 5.2 授权安全

- ✅ 租户级别隔离
- ✅ 细粒度的 RBAC
- ✅ Token Audience 验证
- ✅ 最小权限原则

### 5.3 传输安全

- ✅ 生产环境强制 HTTPS
- ✅ gRPC 使用 TLS
- ✅ 敏感数据加密存储
- ✅ Secrets 使用 K8s Secrets 管理

### 5.4 审计安全

- ✅ 完整的操作日志
- ✅ 用户行为追踪
- ✅ 管理操作记录
- ✅ 异常活动检测

## 6. 性能设计

### 6.1 缓存策略

```
Redis 缓存层
├── 用户角色缓存 (TTL: 5min)
├── 服务配置缓存 (TTL: 10min)
├── JWKS 公钥缓存 (TTL: 1hour)
└── Session 缓存
```

**缓存命中率目标**: > 95%

### 6.2 性能指标

| 操作 | 目标延迟 | 并发能力 |
|------|---------|---------|
| REST API 调用 | < 50ms | 1000+ QPS |
| Token Exchange | < 20ms | 5000+ QPS |
| gRPC 调用 | < 10ms | 10000+ QPS |
| 数据库查询 | < 30ms | - |

### 6.3 扩展性

- **水平扩展**: auth9-core 无状态，可自由扩展副本数
- **数据库扩展**: TiDB 原生支持分布式扩展
- **缓存扩展**: Redis 集群模式

## 7. 高可用设计

### 7.1 服务冗余

```yaml
auth9-core:
  replicas: 3+
  strategy: RollingUpdate
  
auth9-portal:
  replicas: 2+
  strategy: RollingUpdate
```

### 7.2 健康检查

- **Liveness Probe**: 检查进程是否存活
- **Readiness Probe**: 检查服务是否就绪
- **Startup Probe**: 检查服务启动状态

### 7.3 故障恢复

- 自动重启失败的 Pod
- 滚动更新零停机
- 数据库主从切换
- Redis Sentinel 高可用

## 8. 监控与可观测性

### 8.1 指标采集

- Prometheus metrics 导出
- 业务指标统计
- 性能指标监控

### 8.2 日志收集

- 结构化日志 (JSON)
- 分布式追踪 (Tracing)
- 日志聚合和查询

### 8.3 告警通知

- 服务异常告警
- 性能降级告警
- 安全事件告警

## 9. 部署架构

### 9.1 Kubernetes 部署

```
┌─────────────────────────────────────┐
│         Ingress Controller          │
│         (NGINX/Traefik)             │
└────────────┬────────────────────────┘
             │
    ┌────────┴────────┐
    │                 │
┌───▼────┐      ┌────▼─────┐
│ Portal │      │   Core   │
│ Service│      │ Service  │
│ (3000) │      │ (8080)   │
└────────┘      │ (50051)  │
                └──┬───┬───┘
                   │   │
         ┌─────────┘   └─────────┐
         │                       │
    ┌────▼────┐             ┌───▼────┐
    │  TiDB   │             │ Redis  │
    │ Service │             │ Service│
    └─────────┘             └────────┘
```

### 9.2 网络策略

- 公网访问: Portal + API
- 内网访问: gRPC + Keycloak
- 数据库: 仅内部访问

## 10. 技术选型理由

### 10.1 为什么选择 Rust

- ✅ 内存安全
- ✅ 高性能
- ✅ 并发友好
- ✅ 类型安全
- ✅ 优秀的生态系统

### 10.2 为什么选择 Remix

- ✅ 服务端渲染
- ✅ 优秀的开发体验
- ✅ 文件系统路由
- ✅ 数据加载优化
- ✅ 现代化技术栈

### 10.3 为什么选择 TiDB

- ✅ MySQL 兼容
- ✅ 水平扩展
- ✅ 分布式事务
- ✅ HTAP 能力
- ✅ 高可用

## 相关文档

- [快速开始](快速开始.md)
- [安装部署](安装部署.md)
- [REST API](REST-API.md)
- [gRPC API](gRPC-API.md)
- [性能优化](性能优化.md)
