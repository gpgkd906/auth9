# Auth9 请求流向说明

本文档详细说明 Auth9 系统中的请求流向和网络架构，帮助理解性能特点和配置要点。

## 核心架构

Auth9 采用 **服务端渲染（SSR）架构**，95% 的请求在 Kubernetes 集群内完成，仅 5% 的浏览器端 OAuth 重定向需要通过公网。

### 请求流向图

```
┌─────────────────────────────────────────────────────────────────┐
│                        Kubernetes Cluster                        │
│                                                                   │
│  ┌──────────────────┐                    ┌──────────────────┐   │
│  │  auth9-portal    │                    │   auth9-core     │   │
│  │(React Router 7)  │                    │   (Rust/axum)    │   │
│  │                  │                    │                  │   │
│  │  - loader/action │───────────────────▶│  REST API        │   │
│  │    (服务端代码)   │  集群内 DNS         │  gRPC API        │   │
│  │                  │  < 1ms 延迟         │                  │   │
│  │                  │  http://auth9-core │                  │   │
│  │                  │       :8080         │                  │   │
│  └──────────────────┘                    └──────────────────┘   │
│          │                                                        │
│          │ 95% 流量                                              │
│          │ (数据加载)                                             │
│          │                                                        │
└─────────────────────────────────────────────────────────────────┘
           │
           │ 5% 流量 (OAuth 重定向)
           │
           ▼
    ┌──────────────┐
    │   浏览器      │
    │              │
    │ 访问:         │
    │ https://     │
    │ api.auth9... │
    │              │
    └──────────────┘
           │
           │ 经过 cloudflared tunnel
           │ 50-200ms 延迟
           │
           ▼
    ┌──────────────┐
    │ auth9-core   │
    │ OAuth2 端点  │
    └──────────────┘
```

## 环境变量配置

### 关键环境变量

| 环境变量 | 用途 | 示例值 | 使用场景 |
|---------|------|--------|---------|
| `AUTH9_CORE_URL` | 集群内 DNS 地址 | `http://auth9-core:8080` | Portal SSR (React Router 7) 调用 Core API (95% 流量) |
| `AUTH9_CORE_PUBLIC_URL` | 公网 cloudflared 地址 | `https://api.auth9.yourdomain.com` | 浏览器 OAuth 重定向 (5% 流量) |
| `AUTH9_PORTAL_URL` | Portal 公网地址 | `https://auth9.yourdomain.com` | OAuth 回调地址 |

### 为什么需要两个 Core URL？

1. **AUTH9_CORE_URL（集群内地址）**
   - React Router 7 loader/action 在服务端执行
   - 可以使用 Kubernetes Service DNS
   - 延迟 < 1ms，无需经过公网
   - **这是性能的关键！**

2. **AUTH9_CORE_PUBLIC_URL（公网地址）**
   - 浏览器端的 OAuth 登录流程需要重定向到 Core
   - 浏览器无法解析 Kubernetes 内部 DNS
   - 必须使用公网可访问的 cloudflared tunnel 地址
   - 仅占 5% 的流量

## 性能对比

### 当前架构（最优）

```
浏览器 → Portal → Core (集群内)
         ↓
      < 1ms 延迟
      95% 流量
```

**特点**:
- SSR 在 Pod 内执行
- 使用 Kubernetes Service 网络
- 延迟极低（< 1ms）
- 无需经过公网

### 错误配置（如果 AUTH9_CORE_URL 使用公网地址）

```
浏览器 → Portal → cloudflared → Core
         ↓
     50-200ms 延迟
     100% 流量（错误！）
```

**问题**:
- 所有请求都经过公网
- 延迟增加 100-200 倍
- 浪费 cloudflared 带宽
- 完全没必要

## 详细流程示例

### 场景 1: 用户访问租户列表（95% 流量）

```typescript
// auth9-portal/app/routes/tenants.tsx

export async function loader({ request }: LoaderFunctionArgs) {
  // 这段代码在 Portal Pod 中执行（服务端，React Router 7 SSR）
  const response = await fetch(
    `${process.env.AUTH9_CORE_URL}/api/v1/tenants`,  // http://auth9-core:8080
    { headers: { Authorization: `Bearer ${token}` } }
  );
  return response.json();
}
```

**网络路径**:
```
auth9-portal Pod
    ↓ Kubernetes Service DNS (集群内)
    ↓ < 1ms
auth9-core Service
    ↓
auth9-core Pod
```

### 场景 2: 用户点击登录按钮（5% 流量）

```typescript
// auth9-portal/app/routes/login.tsx

export default function Login() {
  const handleLogin = () => {
    // 这段代码在浏览器中执行（客户端）
    window.location.href =
      `${window.ENV.AUTH9_CORE_PUBLIC_URL}/api/v1/auth/authorize?...`;
      // https://api.auth9.yourdomain.com
  };
}
```

**网络路径**:
```
浏览器
    ↓ HTTPS (公网)
    ↓ 经过 cloudflared tunnel
    ↓ 50-200ms
auth9-core Service
    ↓
auth9-core Pod
```

## 配置验证

### 1. 验证 ConfigMap

```bash
kubectl get configmap auth9-config -n auth9 -o yaml | grep -E 'AUTH9_CORE|AUTH9_PORTAL'
```

**预期输出**:
```yaml
AUTH9_CORE_URL: "http://auth9-core:8080"
AUTH9_CORE_PUBLIC_URL: "https://api.auth9.yourdomain.com"
AUTH9_PORTAL_URL: "https://auth9.yourdomain.com"
```

### 2. 测试集群内连通性

```bash
# 从 Portal Pod 访问 Core（模拟 SSR 请求）
kubectl exec -n auth9 deployment/auth9-portal -- \
  curl -s -o /dev/null -w "%{time_total}s\n" http://auth9-core:8080/health
```

**预期**: 延迟 < 0.010s (10ms)

### 3. 测试公网访问

```bash
# 从本地访问 Core（模拟浏览器请求）
curl -s -o /dev/null -w "%{time_total}s\n" https://api.auth9.yourdomain.com/health
```

**预期**: 延迟 0.050-0.200s (50-200ms)

### 4. 测试 OAuth 登录流程

1. 访问 `https://auth9.yourdomain.com/login`
2. 打开浏览器开发者工具 → Network 标签
3. 点击登录按钮
4. 查看重定向的 URL

**预期**: 应该重定向到 `https://api.auth9.yourdomain.com/api/v1/auth/authorize?...`（使用 PUBLIC_URL）

## 常见误解

### ❌ 误解 1: "cloudflared tunnel 影响性能"

**事实**:
- 95% 的请求根本不经过 cloudflared
- 只有浏览器端的 OAuth 重定向才用公网
- 这些重定向本来就必须用公网（浏览器无法访问集群内地址）

### ❌ 误解 2: "应该把 AUTH9_CORE_URL 改成公网地址"

**事实**:
- 这样做会让 95% 的请求从集群内（< 1ms）变成公网（50-200ms）
- 性能会下降 100-200 倍
- 完全没有必要

### ❌ 误解 3: "需要优化 Portal 到 Core 的通信"

**事实**:
- 当前已经是最优架构
- 集群内通信延迟 < 1ms，无法再优化
- 应该优化的是 Core 内部逻辑（数据库查询、业务逻辑等）

## 何时需要优化

当前架构已经在网络层面做到极致，如果遇到性能问题，应该关注：

1. **数据库查询**
   - 使用 `EXPLAIN` 分析慢查询
   - 添加合适的索引
   - 避免 N+1 查询

2. **业务逻辑**
   - 减少不必要的数据库往返
   - 使用批量查询
   - 缓存频繁访问的数据

3. **前端渲染**
   - 减少 loader 中的数据量
   - 使用流式渲染
   - 合理使用客户端缓存

**何时考虑添加 Redis 缓存**:
- 监控显示数据库负载过高
- 某些查询响应时间持续 > 100ms
- 出现明显的热点数据

## 总结

| 指标 | 当前值 | 说明 |
|------|--------|------|
| 集群内延迟 | < 1ms | 95% 的 Portal → Core 请求 |
| 公网延迟 | 50-200ms | 5% 的浏览器 OAuth 重定向 |
| 架构优化程度 | ⭐⭐⭐⭐⭐ | 已经是最优架构 |
| 需要改进 | ❌ | 无需改进网络层 |

**关键要点**:
1. ✅ 保持 `AUTH9_CORE_URL` 使用集群内地址
2. ✅ 配置 `AUTH9_CORE_PUBLIC_URL` 用于浏览器重定向
3. ✅ SSR 架构天然利用集群内网络
4. ❌ 不要把所有请求都路由到公网
