# B2B 入驻与组织创建

Auth9 支持 B2B 场景下的自助入驻流程，允许企业用户注册后自主创建组织并管理成员。

## 核心概念

### B2B 入驻流程

B2B 入驻是指企业用户首次使用 Auth9 时的完整流程：

1. **用户注册** - 创建个人账号
2. **组织创建** - 创建或加入组织（租户）
3. **成员邀请** - 邀请团队成员加入组织
4. **权限配置** - 为成员分配角色和权限

### 组织 vs 租户

在 Auth9 中，**组织（Organization）** 和 **租户（Tenant）** 是同一个概念：

- **技术层面**：称为 Tenant（租户）
- **业务层面**：称为 Organization（组织）
- **用户界面**：显示为 "Organization"，更符合 B2B 场景语义

### 组织域名

每个组织可以关联一个**企业域名**（如 `acme.com`），用于：

- **域名验证** - 证明组织对该域名的所有权
- **自动关联** - 使用该域名邮箱注册的用户自动关联到组织
- **企业 SSO** - 为该域名配置企业级单点登录

## 用户注册流程

### 1. 访问注册页面

```
https://your-auth9-domain.com/register
```

### 2. 填写注册信息

- **邮箱** - 企业邮箱或个人邮箱
- **密码** - 符合密码策略要求
- **确认密码** - 再次输入密码

### 3. 邮箱验证（可选）

如果启用了邮箱验证：

1. 系统发送验证邮件到注册邮箱
2. 点击邮件中的验证链接
3. 完成邮箱验证

### 4. 自动跳转到组织创建

注册成功后，如果用户还没有加入任何组织，系统会自动引导至 **Onboard 页面**创建组织。

## 组织创建流程

### 通过管理界面创建

新用户注册后会自动进入 **Onboard** 页面：

1. **填写组织信息**：
   - **组织名称** - 组织的显示名称（如 "Acme Corporation"）
   - **组织标识** - 唯一的 URL 标识符（如 "acme"）
   - **企业域名** - 组织的企业邮箱域名（如 "acme.com"）

2. **域名建议**：
   - 如果使用企业邮箱注册（如 `admin@acme.com`），系统会自动建议域名 `acme.com`
   - 可以选择接受建议或手动输入其他域名

3. **提交创建**：
   - 点击 **Create Organization** 按钮
   - 系统创建组织并将当前用户设为组织管理员
   - 自动跳转到组织管理界面

### 组织标识（Slug）规则

组织标识用于生成组织的唯一 URL，必须满足：

- **唯一性** - 全系统内唯一，不能重复
- **格式要求** - 仅包含小写字母、数字和连字符（`-`）
- **长度限制** - 3-63 个字符
- **示例** - `acme`, `acme-corp`, `my-company-2024`

### 企业域名规则

企业域名用于标识组织的邮箱域名，要求：

- **格式** - 标准域名格式（如 `example.com`）
- **唯一性** - 一个域名只能关联一个组织
- **验证** - 可选的域名所有权验证（通过 DNS TXT 记录）
- **用途** - 用于企业 SSO、自动用户关联等

**注意**：域名设置后暂不支持修改，请谨慎填写。

## 组织管理

### 查看组织信息

1. 登录管理界面
2. 点击左侧导航栏的 **Tenants**
3. 在列表中找到您的组织
4. 点击组织名称进入详情页

### 编辑组织信息

1. 在组织列表中点击右侧的 `...` 菜单
2. 选择 **Edit**
3. 修改以下信息：
   - 组织名称
   - 组织标识（Slug）
   - Logo URL
4. 点击 **Save Changes**

**注意**：企业域名设置后暂不支持通过界面修改。

### 删除组织

**警告**：删除组织是不可逆操作，将同时删除：

- 组织下的所有用户关联
- 组织的所有服务配置
- 组织的所有角色和权限
- 组织的所有审计日志
- 组织的所有邀请记录

删除步骤：

1. 在组织列表中点击 `...` 菜单
2. 选择 **Delete**
3. 确认删除操作

## 加入已有组织

### 通过邀请加入

如果您收到组织管理员的邀请邮件：

1. 点击邮件中的 **Accept Invitation** 链接
2. 如果还没有账号，先完成注册
3. 登录后自动加入该组织

详见 [邀请系统](邀请系统.md) 文档。

### 通过域名自动加入（未来功能）

如果组织启用了**域名自动加入**功能：

- 使用该域名邮箱注册的用户会自动加入组织
- 无需管理员手动邀请
- 可以设置默认角色

**注意**：此功能正在开发中，暂未上线。

## B2B 入驻完整示例

### 场景：Acme 公司首次使用 Auth9

#### 步骤 1：管理员注册

张三是 Acme 公司的 IT 管理员：

```
邮箱：zhangsan@acme.com
密码：SecurePass123!
```

访问 `https://auth9.example.com/register` 完成注册。

#### 步骤 2：创建组织

注册成功后，张三被引导至 Onboard 页面：

```
组织名称：Acme Corporation
组织标识：acme
企业域名：acme.com  （系统自动建议）
```

点击 **Create Organization**，组织创建成功。

#### 步骤 3：配置服务

张三为公司的项目管理系统注册服务：

1. 导航到 **Services**
2. 点击 **Register Service**
3. 填写信息：
   ```
   服务名称：Acme Project Manager
   Client ID：（自动生成）
   Base URL：https://pm.acme.com
   Redirect URIs：https://pm.acme.com/callback
   ```

#### 步骤 4：创建角色

为项目管理系统创建角色：

1. 导航到 **Roles**
2. 为 "Acme Project Manager" 服务添加角色：
   - `admin` - 管理员
   - `project-manager` - 项目经理
   - `developer` - 开发者
   - `viewer` - 查看者

#### 步骤 5：邀请团队成员

邀请其他员工加入：

1. 导航到 **Tenants** > **Acme Corporation** > **Invitations**
2. 点击 **Create Invitation**
3. 输入成员邮箱：`lisi@acme.com`
4. 分配角色：`project-manager`
5. 发送邀请

李四收到邀请邮件，点击链接后注册并自动加入 Acme 组织。

## 多组织支持

### 用户可以加入多个组织

一个用户可以同时属于多个组织（租户）：

```
张三的组织：
- Acme Corporation (管理员)
- Beta Company (普通成员)
- Gamma Inc. (项目经理)
```

### 切换组织

在管理界面中：

1. 点击顶部导航栏的组织名称
2. 从下拉菜单中选择要切换的组织
3. 界面自动切换到选定的组织上下文

## 组织设置

### 通用设置

每个组织可以独立配置：

- **品牌定制** - Logo、颜色、主题
- **邮件模板** - 自定义邮件内容和样式
- **密码策略** - 密码长度、复杂度要求
- **会话策略** - 会话超时、并发控制
- **MFA 策略** - 是否强制多因素认证

详见：
- [品牌定制](品牌定制.md)
- [邮件模板](邮件模板.md)
- [密码管理](密码管理.md)
- [会话管理](会话管理.md)

### 企业 SSO 设置

组织可以配置企业级单点登录：

- **OIDC 连接器** - 对接企业现有的 OIDC 提供商
- **SAML 连接器** - 对接企业现有的 SAML 身份提供商
- **域名绑定** - 将 SSO 连接器绑定到企业域名

详见 [企业级 SSO 连接器](企业级SSO连接器.md) 文档。

## API 参考

### 创建组织

```bash
curl -X POST https://api.auth9.example.com/api/v1/tenants \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "name": "Acme Corporation",
    "slug": "acme",
    "domain": "acme.com",
    "logo_url": "https://acme.com/logo.png"
  }'
```

响应：

```json
{
  "data": {
    "id": "tenant-uuid",
    "name": "Acme Corporation",
    "slug": "acme",
    "domain": "acme.com",
    "logo_url": "https://acme.com/logo.png",
    "created_at": "2024-01-01T00:00:00Z"
  }
}
```

### 获取我的组织列表

```bash
curl https://api.auth9.example.com/api/v1/users/me/tenants \
  -H "Authorization: Bearer <token>"
```

响应：

```json
{
  "data": [
    {
      "id": "tenant-uuid",
      "name": "Acme Corporation",
      "slug": "acme",
      "domain": "acme.com",
      "role": "admin",
      "joined_at": "2024-01-01T00:00:00Z"
    }
  ]
}
```

## 常见问题

### Q1: 注册后没有自动跳转到 Onboard 页面？

**可能原因**：

1. 您已经加入了其他组织，系统会直接跳转到 Dashboard
2. 浏览器缓存问题，尝试清除缓存或使用无痕模式

### Q2: 组织标识（Slug）提示已存在？

**解决方法**：

- Slug 必须全系统唯一，请尝试其他名称
- 可以在 Slug 后加上数字或公司地区（如 `acme-cn`, `acme-2024`）

### Q3: 企业域名已被其他组织使用？

**解决方法**：

- 一个域名只能关联一个组织
- 如果是误占用，请联系系统管理员处理
- 可以使用子域名（如 `cn.acme.com`）

### Q4: 如何验证域名所有权？

**当前状态**：域名验证功能正在开发中

**未来功能**：
- 通过 DNS TXT 记录验证
- 通过 HTTP 文件验证
- 验证后可启用高级功能（域名自动加入、企业 SSO 等）

### Q5: 创建组织后可以修改域名吗？

**当前限制**：域名设置后暂不支持修改

**原因**：域名会影响企业 SSO、用户关联等功能，随意修改可能导致配置错乱

**建议**：创建组织时仔细填写域名，如需修改请联系系统管理员

### Q6: 一个用户可以创建多个组织吗？

**可以**。一个用户可以：

- 创建多个组织
- 加入多个组织
- 在不同组织中拥有不同角色

### Q7: 删除组织后可以恢复吗？

**不可以**。删除组织是不可逆操作，所有数据将永久删除。

**建议**：
- 删除前做好数据备份
- 确认所有成员已迁移到其他组织
- 仔细确认删除操作

## 相关文档

- [多租户管理](多租户管理.md) - 租户的详细管理功能
- [邀请系统](邀请系统.md) - 邀请团队成员加入组织
- [RBAC 权限系统](RBAC权限系统.md) - 角色和权限管理
- [企业级 SSO 连接器](企业级SSO连接器.md) - 配置企业单点登录
- [品牌定制](品牌定制.md) - 自定义组织品牌外观

## 最佳实践

### 1. 使用企业邮箱注册

- 使用公司官方邮箱域名（如 `@acme.com`）
- 便于域名验证和自动关联
- 提升组织的可信度

### 2. 规范的组织标识

- 使用公司简称或品牌名称
- 保持简短、易记
- 避免使用数字开头

### 3. 及时配置品牌

- 上传公司 Logo
- 设置品牌颜色
- 自定义邮件模板
- 提供一致的品牌体验

### 4. 规划角色权限

- 在邀请成员前先创建好角色
- 遵循最小权限原则
- 定期审查权限分配

### 5. 启用安全功能

- 配置密码策略
- 启用 MFA（多因素认证）
- 定期查看审计日志
- 配置安全告警

---

**最后更新**: 2026-02-17
