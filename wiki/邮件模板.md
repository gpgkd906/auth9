# 邮件模板

Auth9 提供灵活的邮件模板系统，支持自定义所有系统邮件的外观和内容，打造专业的邮件体验。

## 功能概述

- ✅ 自定义所有系统邮件模板
- ✅ 支持 HTML 和纯文本格式
- ✅ 动态变量替换
- ✅ 多语言支持
- ✅ 实时预览
- ✅ 品牌样式自动应用
- ✅ 响应式邮件设计

## 邮件类型

Auth9 支持自定义以下类型的邮件：

| 邮件类型 | 触发时机 | 主要用途 |
|---------|---------|---------|
| **Welcome Email** | 用户注册成功 | 欢迎新用户，介绍系统功能 |
| **Invitation Email** | 管理员发送邀请 | 邀请用户加入租户 |
| **Password Reset** | 用户请求重置密码 | 发送密码重置链接 |
| **Password Changed** | 密码修改成功 | 通知用户密码已更改 |
| **Email Verification** | 用户注册/更改邮箱 | 验证邮箱地址 |
| **MFA Setup** | 启用多因素认证 | MFA 配置说明 |
| **Login Alert** | 异常登录检测 | 安全警告通知 |
| **Session Revoked** | 会话被撤销 | 通知用户会话终止 |
| **Account Locked** | 账户被锁定 | 账户锁定通知和解锁说明 |
| **Webhook Failed** | Webhook 调用失败 | 通知管理员集成问题 |

## 邮件模板结构

### 基础结构

每个邮件模板包含：

```json
{
  "id": "welcome-email",
  "name": "欢迎邮件",
  "subject": "欢迎加入 {{tenant_name}}！",
  "html_body": "<html>...</html>",
  "text_body": "欢迎加入...",
  "from_name": "{{tenant_name}} 团队",
  "from_email": "noreply@auth9.yourdomain.com",
  "reply_to": "support@example.com",
  "enabled": true
}
```

### 变量系统

邮件模板支持动态变量，使用 `{{variable}}` 语法：

#### 全局变量（所有邮件可用）

| 变量 | 说明 | 示例 |
|------|------|------|
| `{{tenant_name}}` | 租户名称 | "Acme Corp" |
| `{{tenant_logo_url}}` | 租户 Logo URL | "https://..." |
| `{{portal_url}}` | Portal 访问地址 | "https://auth9.example.com" |
| `{{support_email}}` | 支持邮箱 | "support@example.com" |
| `{{current_year}}` | 当前年份 | "2024" |
| `{{primary_color}}` | 品牌主色 | "#007AFF" |

#### 用户相关变量

| 变量 | 说明 |
|------|------|
| `{{user_name}}` | 用户姓名 |
| `{{user_email}}` | 用户邮箱 |
| `{{user_first_name}}` | 名 |
| `{{user_last_name}}` | 姓 |

#### 特定邮件变量

**邀请邮件**:
```
{{invitation_url}}        # 邀请链接
{{sender_name}}          # 发送者姓名
{{role_name}}            # 分配的角色
{{expires_at}}           # 过期时间
{{custom_message}}       # 自定义消息
```

**密码重置**:
```
{{reset_url}}            # 重置链接
{{reset_token}}          # 重置令牌
{{expires_in_minutes}}   # 过期时间（分钟）
```

**登录告警**:
```
{{login_ip}}             # 登录IP
{{login_location}}       # 地理位置
{{login_device}}         # 设备信息
{{login_time}}           # 登录时间
```

## 管理邮件模板

### 通过管理界面

1. 导航到 **Settings** > **Email Templates**
2. 选择要编辑的邮件类型
3. 编辑模板内容：
   - **Subject**: 邮件主题
   - **From Name**: 发件人名称
   - **From Email**: 发件人邮箱
   - **Reply To**: 回复邮箱
   - **HTML Body**: HTML 格式邮件正文
   - **Text Body**: 纯文本格式邮件正文
4. 使用右侧预览查看效果
5. 点击 **Send Test Email** 发送测试邮件
6. 点击 **Save** 保存模板

### 通过 REST API

#### 获取邮件模板列表

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/email-templates \
  -H "Authorization: Bearer <token>"
```

#### 获取特定邮件模板

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/email-templates/{template_id} \
  -H "Authorization: Bearer <token>"
```

响应：

```json
{
  "data": {
    "id": "welcome-email",
    "name": "欢迎邮件",
    "subject": "欢迎加入 {{tenant_name}}！",
    "html_body": "<html>...</html>",
    "text_body": "欢迎...",
    "from_name": "{{tenant_name}} 团队",
    "from_email": "noreply@auth9.yourdomain.com",
    "enabled": true,
    "updated_at": "2024-01-01T00:00:00Z"
  }
}
```

#### 更新邮件模板

```bash
curl -X PUT https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/email-templates/{template_id} \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "subject": "欢迎加入 {{tenant_name}}！",
    "html_body": "<html>...</html>",
    "text_body": "欢迎加入..."
  }'
```

#### 发送测试邮件

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/email-templates/{template_id}/test \
  -H "Authorization: Bearer <token>" \
  -H "Content-Type: application/json" \
  -d '{
    "to_email": "test@example.com",
    "variables": {
      "user_name": "测试用户"
    }
  }'
```

#### 重置为默认模板

```bash
curl -X POST https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/email-templates/{template_id}/reset \
  -H "Authorization: Bearer <token>"
```

## 邮件模板示例

### 欢迎邮件

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>欢迎加入</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #f5f5f7;">
  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f5f7;">
    <tr>
      <td align="center" style="padding: 40px 0;">
        <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          
          <!-- Header -->
          <tr>
            <td align="center" style="padding: 40px 40px 20px;">
              <img src="{{tenant_logo_url}}" alt="{{tenant_name}}" style="max-width: 200px; height: auto;">
            </td>
          </tr>
          
          <!-- Title -->
          <tr>
            <td align="center" style="padding: 0 40px 20px;">
              <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #1c1c1e;">
                欢迎加入 {{tenant_name}}！
              </h1>
            </td>
          </tr>
          
          <!-- Content -->
          <tr>
            <td style="padding: 0 40px 30px; font-size: 16px; line-height: 24px; color: #3a3a3c;">
              <p>您好 {{user_first_name}}，</p>
              <p>欢迎使用 {{tenant_name}}！您的账号已成功创建。</p>
              <p>现在您可以：</p>
              <ul style="margin: 16px 0; padding-left: 24px;">
                <li>访问所有应用和服务</li>
                <li>配置您的个人资料</li>
                <li>启用多因素认证增强安全性</li>
              </ul>
            </td>
          </tr>
          
          <!-- Button -->
          <tr>
            <td align="center" style="padding: 0 40px 40px;">
              <a href="{{portal_url}}" style="display: inline-block; padding: 14px 32px; background-color: {{primary_color}}; color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 16px;">
                访问 Portal
              </a>
            </td>
          </tr>
          
          <!-- Footer -->
          <tr>
            <td style="padding: 30px 40px; border-top: 1px solid #e5e5ea; font-size: 14px; color: #8e8e93; text-align: center;">
              <p style="margin: 0 0 10px;">如有疑问，请联系 <a href="mailto:{{support_email}}" style="color: {{primary_color}}; text-decoration: none;">{{support_email}}</a></p>
              <p style="margin: 0;">© {{current_year}} {{tenant_name}}. All rights reserved.</p>
            </td>
          </tr>
          
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
```

### 密码重置邮件

```html
<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>密码重置</title>
</head>
<body style="margin: 0; padding: 0; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif; background-color: #f5f5f7;">
  <table width="100%" cellpadding="0" cellspacing="0" border="0" style="background-color: #f5f5f7;">
    <tr>
      <td align="center" style="padding: 40px 0;">
        <table width="600" cellpadding="0" cellspacing="0" border="0" style="background-color: #ffffff; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
          
          <tr>
            <td align="center" style="padding: 40px 40px 20px;">
              <img src="{{tenant_logo_url}}" alt="{{tenant_name}}" style="max-width: 200px; height: auto;">
            </td>
          </tr>
          
          <tr>
            <td align="center" style="padding: 0 40px 20px;">
              <h1 style="margin: 0; font-size: 28px; font-weight: 600; color: #1c1c1e;">
                重置您的密码
              </h1>
            </td>
          </tr>
          
          <tr>
            <td style="padding: 0 40px 30px; font-size: 16px; line-height: 24px; color: #3a3a3c;">
              <p>您好 {{user_name}}，</p>
              <p>我们收到了您的密码重置请求。点击下方按钮重置密码：</p>
            </td>
          </tr>
          
          <tr>
            <td align="center" style="padding: 0 40px 20px;">
              <a href="{{reset_url}}" style="display: inline-block; padding: 14px 32px; background-color: {{primary_color}}; color: #ffffff; text-decoration: none; border-radius: 10px; font-weight: 600; font-size: 16px;">
                重置密码
              </a>
            </td>
          </tr>
          
          <tr>
            <td style="padding: 0 40px 30px; font-size: 14px; line-height: 20px; color: #8e8e93;">
              <p>此链接将在 {{expires_in_minutes}} 分钟后过期。</p>
              <p>如果您没有请求重置密码，请忽略此邮件。</p>
              <p>如果按钮无法点击，请复制以下链接到浏览器：<br>
                <a href="{{reset_url}}" style="color: {{primary_color}}; word-break: break-all;">{{reset_url}}</a>
              </p>
            </td>
          </tr>
          
          <tr>
            <td style="padding: 30px 40px; border-top: 1px solid #e5e5ea; font-size: 14px; color: #8e8e93; text-align: center;">
              <p style="margin: 0;">© {{current_year}} {{tenant_name}}. All rights reserved.</p>
            </td>
          </tr>
          
        </table>
      </td>
    </tr>
  </table>
</body>
</html>
```

## 多语言支持

邮件模板支持多语言配置：

```json
{
  "template_id": "welcome-email",
  "translations": {
    "en": {
      "subject": "Welcome to {{tenant_name}}!",
      "html_body": "<html>...</html>"
    },
    "zh": {
      "subject": "欢迎加入 {{tenant_name}}！",
      "html_body": "<html>...</html>"
    },
    "ja": {
      "subject": "{{tenant_name}}へようこそ！",
      "html_body": "<html>...</html>"
    }
  }
}
```

系统会根据用户的语言偏好自动选择合适的模板。

## 邮件发送配置

### SMTP 配置

在租户设置中配置 SMTP 服务器：

```json
{
  "smtp_settings": {
    "host": "smtp.example.com",
    "port": 587,
    "username": "noreply@example.com",
    "password": "smtp-password",
    "use_tls": true,
    "from_email": "noreply@example.com",
    "from_name": "My Company"
  }
}
```

### 邮件发送策略

| 策略 | 说明 | 适用场景 |
|------|------|---------|
| **Immediate** | 立即发送 | 密码重置、验证码 |
| **Queued** | 队列异步发送 | 欢迎邮件、通知 |
| **Batch** | 批量定时发送 | 周报、月报 |

### 重试机制

邮件发送失败时的重试策略：

- 第 1 次重试：1 分钟后
- 第 2 次重试：5 分钟后
- 第 3 次重试：30 分钟后
- 最多重试 3 次，之后标记为失败

## 邮件测试

### 测试清单

在上线前，建议测试以下场景：

- [ ] 在多个邮件客户端测试（Gmail、Outlook、Apple Mail）
- [ ] 测试响应式设计（手机、平板、桌面）
- [ ] 测试深色模式显示
- [ ] 测试垃圾邮件过滤器
- [ ] 测试所有链接是否可点击
- [ ] 测试图片加载（包括被屏蔽的情况）
- [ ] 测试纯文本版本

### 测试工具

推荐使用以下工具测试邮件：

- [Litmus](https://litmus.com/) - 邮件测试平台
- [Email on Acid](https://www.emailonacid.com/) - 邮件兼容性测试
- [Mail Tester](https://www.mail-tester.com/) - 垃圾邮件评分

## 最佳实践

### 设计建议

1. **保持简洁**
   - 一封邮件一个主要目的
   - 使用清晰的标题和 CTA
   - 避免过多的图片和链接

2. **响应式设计**
   - 使用 table 布局确保兼容性
   - 移动端字体至少 14px
   - 按钮至少 44x44px（方便点击）

3. **品牌一致性**
   - 使用租户品牌颜色
   - 包含 Logo
   - 统一的视觉风格

4. **可访问性**
   - 提供纯文本版本
   - 使用语义化 HTML
   - 图片添加 alt 文本

### 内容建议

1. **个性化**
   - 使用用户姓名
   - 基于用户行为定制内容

2. **清晰的行动号召**
   - 明确的按钮文案
   - 突出显示主要操作

3. **设置期望**
   - 说明下一步操作
   - 提供时间线（如"24小时内"）

4. **提供支持**
   - 包含支持邮箱
   - 提供帮助文档链接

### 性能优化

1. **图片优化**
   - 使用 CDN 托管图片
   - 压缩图片大小
   - 设置合适的宽高

2. **HTML 优化**
   - 内联 CSS（避免外部样式表）
   - 移除不必要的空格和注释
   - 压缩 HTML

3. **发送优化**
   - 使用队列异步发送
   - 批量发送时控制频率
   - 监控退信率

## 邮件分析

查看邮件发送统计：

```bash
curl https://api.auth9.yourdomain.com/api/v1/tenants/{tenant_id}/email-analytics \
  -H "Authorization: Bearer <token>"
```

响应：

```json
{
  "data": {
    "total_sent": 10000,
    "delivered": 9800,
    "bounced": 150,
    "opened": 7500,
    "clicked": 4500,
    "delivery_rate": 0.98,
    "open_rate": 0.75,
    "click_rate": 0.45
  }
}
```

## 常见问题

### 邮件进入垃圾箱？

1. 配置 SPF、DKIM、DMARC 记录
2. 使用真实的发件人域名
3. 避免垃圾邮件关键词
4. 提供取消订阅链接
5. 保持低投诉率

### 邮件显示异常？

1. 使用 table 布局而非 div
2. 内联所有 CSS
3. 避免使用背景图片
4. 测试多个邮件客户端

### 如何提高打开率？

1. 优化邮件主题
2. 选择合适的发送时间
3. 个性化内容
4. A/B 测试不同版本

## 相关文档

- [品牌定制](品牌定制.md)
- [邀请系统](邀请系统.md)
- [密码管理](密码管理.md)
- [多租户管理](多租户管理.md)
- [REST API](REST-API.md#邮件模板-api)

---

**最后更新**: 2026-02-04
