# 本地开发

本文档介绍如何搭建 Auth9 的本地开发环境。

## 前置要求

### 必需工具

- **Rust** 1.70+
  ```bash
  curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh
  ```

- **Node.js** 18+
  ```bash
  # 使用 nvm
  nvm install 18
  nvm use 18
  ```

- **Docker & Docker Compose**
  - Docker 20.10+
  - Docker Compose 2.0+

- **Protocol Buffers编译器**
  ```bash
  # macOS
  brew install protobuf
  
  # Linux
  apt-get install -y protobuf-compiler
  
  # 或者从源码安装
  # https://github.com/protocolbuffers/protobuf/releases
  ```

### 可选工具

- **sqlx-cli** (数据库迁移)
  ```bash
  cargo install sqlx-cli --no-default-features --features mysql
  ```

- **grpcurl** (测试 gRPC)
  ```bash
  # macOS
  brew install grpcurl
  
  # Linux
  go install github.com/fullstorydev/grpcurl/cmd/grpcurl@latest
  ```

- **Redis CLI**
  ```bash
  # macOS
  brew install redis
  
  # Linux
  apt-get install redis-tools
  ```

## 克隆仓库

```bash
git clone https://github.com/gpgkd906/auth9.git
cd auth9
```

## 启动依赖服务

使用 Docker Compose 启动 TiDB、Redis 和 Keycloak：

```bash
docker-compose -f docker-compose.yml -f docker-compose.dev.yml up -d
```

服务端口：
- TiDB: `4000`
- Redis: `6379`
- Keycloak: `8081`

验证服务状态：

```bash
# 检查容器状态
docker-compose ps

# 测试 TiDB 连接
mysql -h 127.0.0.1 -P 4000 -u root -p -e "SELECT 1"

# 测试 Redis
redis-cli ping

# 访问 Keycloak
open http://localhost:8081
```

## 开发 auth9-core

### 1. 环境配置

```bash
cd auth9-core

# 复制环境变量模板
cp .env.example .env

# 编辑配置
vim .env
```

`.env` 示例：

```bash
# 服务配置
HOST=0.0.0.0
PORT=8080
GRPC_PORT=50051
LOG_LEVEL=debug
ENVIRONMENT=development

# 数据库
DATABASE_URL=mysql://root:@127.0.0.1:4000/auth9

# Redis
REDIS_URL=redis://127.0.0.1:6379

# JWT
JWT_SECRET=dev-secret-key-change-in-production
JWT_ISSUER=http://localhost:8080

# Keycloak
KEYCLOAK_URL=http://localhost:8081
KEYCLOAK_REALM=auth9
KEYCLOAK_CLIENT_ID=auth9-backend
KEYCLOAK_CLIENT_SECRET=dev-client-secret

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:3000
```

### 2. 数据库初始化

```bash
# 运行迁移
sqlx migrate run

# 或使用 cargo
cargo sqlx migrate run
```

### 3. 构建和运行

```bash
# 检查代码
cargo check

# 构建
cargo build

# 运行（开发模式，带热重载）
cargo watch -x run

# 或直接运行
cargo run
```

### 4. 运行测试

```bash
# 单元测试
cargo test --lib

# 集成测试
cargo test --test '*'

# 特定测试
cargo test test_create_user

# 带输出的测试
cargo test -- --nocapture

# 代码覆盖率
cargo tarpaulin --out Html
```

### 5. 代码检查

```bash
# 格式化
cargo fmt

# Lint
cargo clippy

# 检查所有
cargo fmt && cargo clippy && cargo test
```

## 开发 auth9-portal

### 1. 环境配置

```bash
cd auth9-portal

# 复制环境变量
cp .env.example .env

# 编辑配置
vim .env
```

`.env` 示例：

```bash
API_URL=http://localhost:8080
PORT=3000
NODE_ENV=development
SESSION_SECRET=dev-session-secret
```

### 2. 安装依赖

```bash
# 使用 npm
npm install

# 或使用 yarn
yarn install

# 或使用 pnpm
pnpm install
```

### 3. 运行开发服务器

```bash
# 开发模式（带热重载）
npm run dev

# 或
yarn dev
```

访问 http://localhost:3000

### 4. 运行测试

```bash
# 单元测试
npm run test

# 单元测试（监听模式）
npm run test:watch

# E2E 测试
npm run test:e2e

# 测试覆盖率
npm run test:coverage
```

### 5. 代码检查

```bash
# Lint
npm run lint

# 类型检查
npm run typecheck

# 格式化
npm run format

# 检查所有
npm run lint && npm run typecheck && npm run test
```

### 6. 构建

```bash
# 生产构建
npm run build

# 预览构建
npm run preview
```

## 开发工具配置

### VS Code

推荐安装的扩展：

```json
{
  "recommendations": [
    "rust-lang.rust-analyzer",
    "tamasfe.even-better-toml",
    "dbaeumer.vscode-eslint",
    "esbenp.prettier-vscode",
    "bradlc.vscode-tailwindcss",
    "ms-azuretools.vscode-docker"
  ]
}
```

配置 `.vscode/settings.json`：

```json
{
  "rust-analyzer.cargo.features": "all",
  "rust-analyzer.checkOnSave.command": "clippy",
  "editor.formatOnSave": true,
  "[rust]": {
    "editor.defaultFormatter": "rust-lang.rust-analyzer"
  },
  "[typescript]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  },
  "[typescriptreact]": {
    "editor.defaultFormatter": "esbenp.prettier-vscode"
  }
}
```

### IntelliJ IDEA / CLion

1. 安装 Rust 插件
2. 安装 Toml 插件
3. 启用 Cargo 工具窗口
4. 配置 Rust 工具链

### 调试配置

#### VS Code launch.json

```json
{
  "version": "0.2.0",
  "configurations": [
    {
      "type": "lldb",
      "request": "launch",
      "name": "Debug auth9-core",
      "cargo": {
        "args": [
          "build",
          "--bin=auth9-core",
          "--package=auth9-core"
        ],
        "filter": {
          "name": "auth9-core",
          "kind": "bin"
        }
      },
      "args": [],
      "cwd": "${workspaceFolder}/auth9-core"
    },
    {
      "type": "node",
      "request": "launch",
      "name": "Debug auth9-portal",
      "runtimeExecutable": "npm",
      "runtimeArgs": ["run", "dev"],
      "cwd": "${workspaceFolder}/auth9-portal",
      "console": "integratedTerminal"
    }
  ]
}
```

## API 测试

### REST API 测试

使用 HTTPie 或 curl：

```bash
# 健康检查
http localhost:8080/health

# 获取租户列表（需要认证）
http localhost:8080/api/v1/tenants \
  Authorization:"Bearer your-token"

# 创建租户
http POST localhost:8080/api/v1/tenants \
  Authorization:"Bearer your-token" \
  name="测试公司" \
  slug="test-company"
```

创建测试脚本 `test-api.sh`：

```bash
#!/bin/bash

API_URL="http://localhost:8080"
TOKEN="your-admin-token"

# 测试健康检查
echo "Testing health endpoint..."
curl -s $API_URL/health | jq .

# 测试创建租户
echo "Testing create tenant..."
curl -s -X POST $API_URL/api/v1/tenants \
  -H "Authorization: Bearer $TOKEN" \
  -H "Content-Type: application/json" \
  -d '{"name":"Test Corp","slug":"test-corp"}' | jq .

# 测试获取租户列表
echo "Testing list tenants..."
curl -s $API_URL/api/v1/tenants \
  -H "Authorization: Bearer $TOKEN" | jq .
```

### gRPC 测试

使用 grpcurl：

```bash
# 列出服务
grpcurl -plaintext localhost:50051 list

# 列出方法
grpcurl -plaintext localhost:50051 list auth9.v1.TokenExchange

# 调用方法
grpcurl -plaintext \
  -d '{
    "identity_token": "user-token",
    "tenant_id": "tenant-uuid",
    "service_client_id": "my-service"
  }' \
  localhost:50051 \
  auth9.v1.TokenExchange/ExchangeToken
```

## 数据库管理

### 查看迁移状态

```bash
sqlx migrate info
```

### 创建新迁移

```bash
sqlx migrate add create_new_table
```

### 回滚迁移

```bash
sqlx migrate revert
```

### 连接数据库

```bash
mysql -h 127.0.0.1 -P 4000 -u root -p auth9
```

常用查询：

```sql
-- 查看所有租户
SELECT * FROM tenants;

-- 查看用户
SELECT * FROM users;

-- 查看用户-租户关系
SELECT 
  u.email,
  t.name AS tenant_name,
  tu.joined_at
FROM tenant_users tu
JOIN users u ON tu.user_id = u.id
JOIN tenants t ON tu.tenant_id = t.id;

-- 查看审计日志
SELECT 
  actor_id,
  action,
  resource_type,
  created_at
FROM audit_logs
ORDER BY created_at DESC
LIMIT 10;
```

## 日志查看

### auth9-core 日志

```bash
# 实时日志
tail -f /var/log/auth9/core.log

# 或直接在终端查看
cargo run 2>&1 | tee auth9-core.log
```

### auth9-portal 日志

```bash
# npm 会输出到 stdout
npm run dev
```

### 调整日志级别

```bash
# 临时修改
LOG_LEVEL=trace cargo run

# 或通过环境变量
export LOG_LEVEL=debug
cargo run
```

## 性能分析

### Rust 性能分析

```bash
# 安装 cargo-flamegraph
cargo install flamegraph

# 生成火焰图
cargo flamegraph --bin auth9-core

# 或使用 perf
perf record -g ./target/release/auth9-core
perf report
```

### 前端性能分析

使用浏览器开发者工具：
- Performance 面板
- Network 面板
- Lighthouse 审计

## 常见开发问题

### 问题：编译错误 - sqlx 相关

```
error: no rules expected the token `SELECT`
```

**解决方案**：

```bash
# 设置离线模式
export SQLX_OFFLINE=true

# 或准备查询元数据
cargo sqlx prepare
```

### 问题：端口被占用

```
Error: Address already in use (os error 48)
```

**解决方案**：

```bash
# 查找占用端口的进程
lsof -i :8080

# 杀死进程
kill -9 <PID>

# 或修改端口
PORT=8081 cargo run
```

### 问题：数据库连接失败

```
Error: Failed to connect to database
```

**解决方案**：

```bash
# 检查 TiDB 是否运行
docker-compose ps tidb

# 重启 TiDB
docker-compose restart tidb

# 检查连接字符串
echo $DATABASE_URL
```

### 问题：Redis 连接失败

```
Error: Redis connection refused
```

**解决方案**：

```bash
# 检查 Redis 状态
redis-cli ping

# 重启 Redis
docker-compose restart redis
```

## 提交代码

### 代码规范

在提交前运行：

```bash
# auth9-core
cd auth9-core
cargo fmt
cargo clippy --fix
cargo test

# auth9-portal
cd auth9-portal
npm run lint:fix
npm run format
npm run typecheck
npm run test
```

### Commit 规范

遵循 [Conventional Commits](https://www.conventionalcommits.org/)：

```
<type>(<scope>): <subject>

<body>

<footer>
```

类型：
- `feat`: 新功能
- `fix`: 修复 bug
- `docs`: 文档更新
- `style`: 代码格式
- `refactor`: 重构
- `test`: 测试
- `chore`: 构建/工具

示例：

```
feat(api): add user deletion endpoint

Add DELETE /api/v1/users/:id endpoint with proper authorization checks.

Closes #123
```

### Pull Request

1. Fork 仓库
2. 创建功能分支：`git checkout -b feat/my-feature`
3. 提交更改：`git commit -am 'feat: add some feature'`
4. 推送分支：`git push origin feat/my-feature`
5. 创建 Pull Request

详见：[贡献指南](贡献指南.md)

## 相关文档

- [快速开始](快速开始.md)
- [架构设计](架构设计.md)
- [测试指南](测试指南.md)
- [贡献指南](贡献指南.md)
