# 配置说明

本文档详细说明 Auth9 的所有配置选项。

## 配置方式

Auth9 支持多种配置方式（按优先级从高到低）：

1. 环境变量
2. `.env` 文件
3. 配置文件 (`config.toml`)
4. 默认值

## 1. auth9-core 配置

### 1.1 服务配置

| 环境变量 | 描述 | 默认值 | 必填 |
|---------|------|--------|------|
| `HOST` | 服务监听地址 | `0.0.0.0` | 否 |
| `PORT` | HTTP 端口 | `8080` | 否 |
| `GRPC_PORT` | gRPC 端口 | `50051` | 否 |
| `LOG_LEVEL` | 日志级别 | `info` | 否 |
| `ENVIRONMENT` | 运行环境 | `development` | 否 |

示例：

```bash
HOST=0.0.0.0
PORT=8080
GRPC_PORT=50051
LOG_LEVEL=debug
ENVIRONMENT=production
```

### 1.2 数据库配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `DATABASE_URL` | 数据库连接字符串 | `mysql://user:pass@host:4000/auth9` | ✅ |
| `DB_MAX_CONNECTIONS` | 最大连接数 | `10` | 否 |
| `DB_MIN_CONNECTIONS` | 最小连接数 | `2` | 否 |
| `DB_CONNECT_TIMEOUT` | 连接超时（秒） | `30` | 否 |

示例：

```bash
DATABASE_URL=mysql://root:password@tidb:4000/auth9?charset=utf8mb4
DB_MAX_CONNECTIONS=20
DB_MIN_CONNECTIONS=5
DB_CONNECT_TIMEOUT=30
```

#### 连接字符串格式

```
mysql://[username]:[password]@[host]:[port]/[database]?[options]
```

常用选项：
- `charset=utf8mb4` - 字符集
- `sslmode=require` - SSL 模式
- `pool_max=20` - 连接池大小

### 1.3 Redis 配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `REDIS_URL` | Redis 连接字符串 | `redis://localhost:6379` | ✅ |
| `REDIS_PASSWORD` | Redis 密码 | - | 否 |
| `REDIS_DB` | 数据库索引 | `0` | 否 |
| `REDIS_POOL_SIZE` | 连接池大小 | `10` | 否 |

示例：

```bash
REDIS_URL=redis://redis:6379/0
REDIS_PASSWORD=your-redis-password
REDIS_DB=0
REDIS_POOL_SIZE=20
```

#### Redis URL 格式

```
redis://[:password@]host[:port][/database]
```

集群模式：

```
redis://host1:6379,host2:6379,host3:6379
```

### 1.4 JWT 配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `JWT_SECRET` | JWT 签名密钥 | `your-secret-key` | ✅ |
| `JWT_ISSUER` | JWT 签发者 | `https://auth9.example.com` | ✅ |
| `JWT_AUDIENCE` | JWT 受众 | `auth9` | 否 |
| `JWT_EXPIRATION` | Token 过期时间（秒） | `3600` | 否 |
| `JWT_ALGORITHM` | 签名算法 | `HS256` | 否 |

示例：

```bash
JWT_SECRET=your-strong-secret-key-at-least-32-characters
JWT_ISSUER=https://auth9.yourdomain.com
JWT_AUDIENCE=auth9
JWT_EXPIRATION=3600
JWT_ALGORITHM=HS256
```

#### 支持的算法

- `HS256` - HMAC SHA-256 (推荐)
- `HS384` - HMAC SHA-384
- `HS512` - HMAC SHA-512
- `RS256` - RSA SHA-256
- `RS384` - RSA SHA-384
- `RS512` - RSA SHA-512

### 1.5 Keycloak 配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `KEYCLOAK_URL` | Keycloak 服务器地址 | `http://keycloak:8080` | ✅ |
| `KEYCLOAK_REALM` | Realm 名称 | `auth9` | ✅ |
| `KEYCLOAK_CLIENT_ID` | 客户端 ID | `auth9-backend` | ✅ |
| `KEYCLOAK_CLIENT_SECRET` | 客户端密钥 | - | ✅ |
| `KEYCLOAK_ADMIN_USERNAME` | 管理员用户名 | `admin` | 否 |
| `KEYCLOAK_ADMIN_PASSWORD` | 管理员密码 | - | 否 |

示例：

```bash
KEYCLOAK_URL=http://keycloak:8080
KEYCLOAK_REALM=auth9
KEYCLOAK_CLIENT_ID=auth9-backend
KEYCLOAK_CLIENT_SECRET=your-client-secret
KEYCLOAK_ADMIN_USERNAME=admin
KEYCLOAK_ADMIN_PASSWORD=admin-password
```

### 1.6 CORS 配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `CORS_ALLOWED_ORIGINS` | 允许的源 | `http://localhost:3000,https://app.example.com` | 否 |
| `CORS_ALLOWED_METHODS` | 允许的方法 | `GET,POST,PUT,DELETE` | 否 |
| `CORS_ALLOWED_HEADERS` | 允许的请求头 | `Content-Type,Authorization` | 否 |
| `CORS_MAX_AGE` | 预检缓存时间（秒） | `3600` | 否 |

示例：

```bash
CORS_ALLOWED_ORIGINS=http://localhost:3000,https://portal.example.com
CORS_ALLOWED_METHODS=GET,POST,PUT,DELETE,OPTIONS
CORS_ALLOWED_HEADERS=Content-Type,Authorization,X-Tenant-ID
CORS_MAX_AGE=3600
```

### 1.7 缓存配置

| 环境变量 | 描述 | 默认值 | 必填 |
|---------|------|--------|------|
| `CACHE_TTL_USER_ROLES` | 用户角色缓存时间（秒） | `300` | 否 |
| `CACHE_TTL_SERVICE_CONFIG` | 服务配置缓存时间（秒） | `600` | 否 |
| `CACHE_TTL_JWKS` | JWKS 缓存时间（秒） | `3600` | 否 |
| `CACHE_ENABLED` | 是否启用缓存 | `true` | 否 |

示例：

```bash
CACHE_TTL_USER_ROLES=300
CACHE_TTL_SERVICE_CONFIG=600
CACHE_TTL_JWKS=3600
CACHE_ENABLED=true
```

### 1.8 安全配置

| 环境变量 | 描述 | 默认值 | 必填 |
|---------|------|--------|------|
| `ARGON2_MEMORY_SIZE` | Argon2 内存大小（KB） | `65536` | 否 |
| `ARGON2_ITERATIONS` | Argon2 迭代次数 | `3` | 否 |
| `ARGON2_PARALLELISM` | Argon2 并行度 | `4` | 否 |
| `PASSWORD_MIN_LENGTH` | 密码最小长度 | `8` | 否 |
| `PASSWORD_REQUIRE_UPPERCASE` | 需要大写字母 | `true` | 否 |
| `PASSWORD_REQUIRE_LOWERCASE` | 需要小写字母 | `true` | 否 |
| `PASSWORD_REQUIRE_NUMBER` | 需要数字 | `true` | 否 |
| `PASSWORD_REQUIRE_SPECIAL` | 需要特殊字符 | `true` | 否 |

示例：

```bash
ARGON2_MEMORY_SIZE=65536
ARGON2_ITERATIONS=3
ARGON2_PARALLELISM=4
PASSWORD_MIN_LENGTH=12
PASSWORD_REQUIRE_UPPERCASE=true
PASSWORD_REQUIRE_LOWERCASE=true
PASSWORD_REQUIRE_NUMBER=true
PASSWORD_REQUIRE_SPECIAL=true
```

## 2. auth9-portal 配置

### 2.1 基础配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `API_URL` | 后端 API 地址 | `http://localhost:8080` | ✅ |
| `PORT` | 服务端口 | `3000` | 否 |
| `NODE_ENV` | 运行环境 | `production` | 否 |
| `SESSION_SECRET` | Session 密钥 | - | ✅ |

示例：

```bash
API_URL=https://api.auth9.yourdomain.com
PORT=3000
NODE_ENV=production
SESSION_SECRET=your-session-secret-key
```

### 2.2 认证配置

| 环境变量 | 描述 | 示例 | 必填 |
|---------|------|------|------|
| `AUTH_COOKIE_NAME` | 认证 Cookie 名称 | `auth9_token` | 否 |
| `AUTH_COOKIE_DOMAIN` | Cookie 域名 | `.example.com` | 否 |
| `AUTH_COOKIE_SECURE` | 启用 Secure | `true` | 否 |
| `AUTH_COOKIE_HTTPONLY` | 启用 HttpOnly | `true` | 否 |
| `AUTH_COOKIE_SAMESITE` | SameSite 策略 | `lax` | 否 |

示例：

```bash
AUTH_COOKIE_NAME=auth9_token
AUTH_COOKIE_DOMAIN=.yourdomain.com
AUTH_COOKIE_SECURE=true
AUTH_COOKIE_HTTPONLY=true
AUTH_COOKIE_SAMESITE=lax
```

## 3. 配置文件

### 3.1 auth9-core 配置文件

创建 `config/production.toml`:

```toml
[server]
host = "0.0.0.0"
port = 8080
grpc_port = 50051

[database]
url = "mysql://root:password@tidb:4000/auth9"
max_connections = 20
min_connections = 5

[redis]
url = "redis://redis:6379/0"
pool_size = 20

[jwt]
secret = "your-secret-key"
issuer = "https://auth9.yourdomain.com"
expiration = 3600

[keycloak]
url = "http://keycloak:8080"
realm = "auth9"
client_id = "auth9-backend"
client_secret = "client-secret"

[cache]
ttl_user_roles = 300
ttl_service_config = 600
ttl_jwks = 3600

[logging]
level = "info"
format = "json"
```

### 3.2 环境特定配置

```bash
config/
├── default.toml       # 默认配置
├── development.toml   # 开发环境
├── staging.toml       # 预发布环境
└── production.toml    # 生产环境
```

通过 `ENVIRONMENT` 环境变量选择配置文件。

## 4. Docker 配置

### 4.1 docker-compose.yml 环境变量

```yaml
version: '3.8'

services:
  auth9-core:
    environment:
      DATABASE_URL: mysql://root:password@tidb:4000/auth9
      REDIS_URL: redis://redis:6379
      JWT_SECRET: ${JWT_SECRET}
      KEYCLOAK_URL: http://keycloak:8080
```

### 4.2 .env 文件

```bash
# .env
JWT_SECRET=your-jwt-secret-key
DATABASE_PASSWORD=your-db-password
REDIS_PASSWORD=your-redis-password
KEYCLOAK_ADMIN_PASSWORD=your-keycloak-password
```

## 5. Kubernetes 配置

### 5.1 ConfigMap

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: auth9-config
  namespace: auth9
data:
  LOG_LEVEL: "info"
  ENVIRONMENT: "production"
  CACHE_TTL_USER_ROLES: "300"
  CACHE_TTL_SERVICE_CONFIG: "600"
```

### 5.2 Secret

```yaml
apiVersion: v1
kind: Secret
metadata:
  name: auth9-secrets
  namespace: auth9
type: Opaque
stringData:
  DATABASE_URL: mysql://root:password@tidb:4000/auth9
  JWT_SECRET: your-jwt-secret-key
  KEYCLOAK_CLIENT_SECRET: your-client-secret
```

### 5.3 在 Deployment 中使用

```yaml
spec:
  containers:
  - name: auth9-core
    envFrom:
    - configMapRef:
        name: auth9-config
    - secretRef:
        name: auth9-secrets
```

## 6. 配置验证

### 6.1 验证配置

```bash
# 验证配置文件语法
cd auth9-core
cargo run -- --check-config

# 验证环境变量
cd auth9-core
cargo run -- --show-config
```

### 6.2 配置检查清单

- [ ] 数据库连接字符串正确
- [ ] Redis 连接正常
- [ ] JWT 密钥长度足够（建议 32+ 字符）
- [ ] Keycloak 地址可访问
- [ ] CORS 配置包含所有需要的域名
- [ ] 生产环境启用 HTTPS
- [ ] 日志级别设置为 info 或 warn
- [ ] 缓存 TTL 合理设置

## 7. 配置最佳实践

### 7.1 开发环境

- 使用 `.env` 文件
- 启用调试日志
- 允许所有 CORS
- 简单密码策略

### 7.2 生产环境

- 使用 Kubernetes Secrets
- 日志级别 info 或 warn
- 严格的 CORS 配置
- 强密码策略
- 启用 HTTPS
- 启用缓存

### 7.3 安全建议

1. **密钥管理**:
   - 使用强随机密钥
   - 定期轮转密钥
   - 不要提交密钥到代码仓库

2. **访问控制**:
   - 限制数据库访问
   - 使用网络策略
   - 最小权限原则

3. **审计**:
   - 启用审计日志
   - 监控配置变更
   - 定期审查权限

## 8. 环境变量模板

### 8.1 开发环境 (.env.development)

```bash
# Server
HOST=0.0.0.0
PORT=8080
GRPC_PORT=50051
LOG_LEVEL=debug
ENVIRONMENT=development

# Database
DATABASE_URL=mysql://root:password@localhost:4000/auth9
DB_MAX_CONNECTIONS=10

# Redis
REDIS_URL=redis://localhost:6379

# JWT
JWT_SECRET=dev-secret-key-change-in-production
JWT_ISSUER=http://localhost:8080
JWT_EXPIRATION=3600

# Keycloak
KEYCLOAK_URL=http://localhost:8081
KEYCLOAK_REALM=auth9
KEYCLOAK_CLIENT_ID=auth9-backend
KEYCLOAK_CLIENT_SECRET=dev-client-secret

# CORS
CORS_ALLOWED_ORIGINS=http://localhost:3000
```

### 8.2 生产环境 (.env.production)

```bash
# Server
HOST=0.0.0.0
PORT=8080
GRPC_PORT=50051
LOG_LEVEL=info
ENVIRONMENT=production

# Database
DATABASE_URL=mysql://auth9_user:${DB_PASSWORD}@tidb-cluster:4000/auth9?sslmode=require
DB_MAX_CONNECTIONS=20
DB_MIN_CONNECTIONS=5

# Redis
REDIS_URL=redis://:${REDIS_PASSWORD}@redis-cluster:6379
REDIS_POOL_SIZE=20

# JWT
JWT_SECRET=${JWT_SECRET}
JWT_ISSUER=https://auth9.yourdomain.com
JWT_EXPIRATION=3600
JWT_ALGORITHM=HS256

# Keycloak
KEYCLOAK_URL=http://keycloak-internal:8080
KEYCLOAK_REALM=auth9
KEYCLOAK_CLIENT_ID=auth9-backend
KEYCLOAK_CLIENT_SECRET=${KEYCLOAK_CLIENT_SECRET}

# CORS
CORS_ALLOWED_ORIGINS=https://portal.yourdomain.com,https://app.yourdomain.com

# Cache
CACHE_ENABLED=true
CACHE_TTL_USER_ROLES=300
CACHE_TTL_SERVICE_CONFIG=600

# Security
PASSWORD_MIN_LENGTH=12
PASSWORD_REQUIRE_UPPERCASE=true
PASSWORD_REQUIRE_LOWERCASE=true
PASSWORD_REQUIRE_NUMBER=true
PASSWORD_REQUIRE_SPECIAL=true
```

## 相关文档

- [快速开始](快速开始.md)
- [安装部署](安装部署.md)
- [生产部署](生产部署.md)
- [故障排查](故障排查.md)
