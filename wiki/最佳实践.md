# 最佳实践

本文档提供 Auth9 的使用建议和最佳实践。

## 架构设计最佳实践

### 1. 租户设计

#### ✅ 推荐做法

**使用清晰的租户层次结构**

```
组织 (Organization)
└── 部门 (Department) - 作为租户
    └── 团队 (Team) - 通过角色区分
        └── 成员 (Member) - 用户
```

**合理的租户粒度**
- 每个独立的业务单元一个租户
- 不要为每个项目创建租户
- 使用角色区分团队和项目

**租户命名规范**
```
名称：清晰的组织名称
Slug：组织-缩写-环境（如 acme-corp-prod）
```

#### ❌ 避免的做法

- 过度细分租户（如每个项目一个租户）
- 使用无意义的租户名称
- 频繁修改租户 slug

### 2. 用户管理

#### ✅ 推荐做法

**使用域名白名单**

```json
{
  "settings": {
    "allowed_domains": ["company.com", "company.co.jp"],
    "domain_verification_required": true
  }
}
```

**启用邮箱验证**

```json
{
  "settings": {
    "require_email_verification": true,
    "verification_email_timeout": 86400
  }
}
```

**定期清理不活跃用户**

```bash
# 每月执行
curl -X POST /api/v1/admin/cleanup-inactive-users \
  -H "Authorization: Bearer <token>" \
  -d '{"inactive_days": 90}'
```

#### ❌ 避免的做法

- 允许任意域名的用户加入
- 跳过邮箱验证
- 永久保留所有用户账号

### 3. 角色和权限

#### ✅ 推荐做法

**遵循最小权限原则**

```
管理员 (Admin)
├── 编辑者 (Editor) - 继承管理员
│   ├── 作者 (Author) - 继承编辑者
│   │   └── 查看者 (Viewer) - 继承作者
```

**使用语义化的权限名称**

```
资源:操作
- user:read      // 读取用户
- user:write     // 修改用户
- user:delete    // 删除用户
- report:export  // 导出报告
```

**权限分组**

```json
{
  "roles": [
    {
      "name": "content_manager",
      "permissions": [
        "content:read",
        "content:write",
        "content:publish"
      ]
    },
    {
      "name": "user_manager",
      "permissions": [
        "user:read",
        "user:write",
        "role:assign"
      ]
    }
  ]
}
```

#### ❌ 避免的做法

- 给所有用户管理员权限
- 使用模糊的权限名称（如 "permission1"）
- 权限过度细分（如每个按钮一个权限）

### 4. 服务注册

#### ✅ 推荐做法

**为每个应用注册独立的服务**

```bash
curl -X POST /api/v1/services \
  -H "Authorization: Bearer <token>" \
  -d '{
    "name": "主应用",
    "base_url": "https://app.example.com",
    "redirect_uris": [
      "https://app.example.com/auth/callback"
    ],
    "logout_uris": [
      "https://app.example.com/logout"
    ]
  }'
```

**使用 HTTPS Redirect URIs**
```
✅ https://app.example.com/callback
❌ http://app.example.com/callback
```

**配置多个 Redirect URIs（开发/生产）**

```json
{
  "redirect_uris": [
    "https://app.example.com/callback",
    "https://staging.example.com/callback",
    "http://localhost:3000/callback"
  ]
}
```

#### ❌ 避免的做法

- 多个应用共用一个 client_id
- 使用通配符 redirect URI（`*`）
- 将 client_secret 提交到代码仓库

## 安全最佳实践

### 1. 密码策略

#### ✅ 推荐配置

```json
{
  "settings": {
    "password_policy": "strong",
    "password_min_length": 12,
    "password_require_uppercase": true,
    "password_require_lowercase": true,
    "password_require_number": true,
    "password_require_special": true,
    "password_history": 5,
    "password_max_age_days": 90
  }
}
```

### 2. MFA 配置

#### ✅ 推荐做法

**为管理员强制启用 MFA**

```json
{
  "settings": {
    "require_mfa": true,
    "mfa_methods": ["totp", "email"],
    "mfa_grace_period_days": 7,
    "force_mfa_for_admins": true
  }
}
```

### 3. Session 管理

#### ✅ 推荐配置

```json
{
  "settings": {
    "session_timeout": 3600,           // 1 小时
    "idle_timeout": 1800,              // 30 分钟无操作
    "max_concurrent_sessions": 3,      // 最多 3 个并发会话
    "remember_me_enabled": false,      // 生产环境关闭
    "secure_cookies": true,            // 启用 Secure
    "httponly_cookies": true,          // 启用 HttpOnly
    "samesite": "lax"                  // SameSite 策略
  }
}
```

### 4. Token 管理

#### ✅ 推荐做法

**合理设置 Token 有效期**

```bash
JWT_EXPIRATION=3600              # 1 小时
REFRESH_TOKEN_EXPIRATION=2592000 # 30 天
```

**在安全位置存储 Token**

Web 应用：
```javascript
// ✅ HttpOnly Cookie
document.cookie = `auth_token=${token}; Secure; HttpOnly; SameSite=Lax`;

// ❌ LocalStorage（易受 XSS 攻击）
localStorage.setItem('auth_token', token);
```

移动应用：
```swift
// ✅ iOS Keychain
KeychainWrapper.standard.set(token, forKey: "auth_token")

// ❌ UserDefaults
UserDefaults.standard.set(token, forKey: "auth_token")
```

**Token 刷新策略**

```javascript
// 在 Token 过期前 5 分钟刷新
const refreshThreshold = 5 * 60 * 1000; // 5 分钟

if (tokenExpiry - Date.now() < refreshThreshold) {
  await refreshToken();
}
```

### 5. 审计和监控

#### ✅ 推荐做法

**记录关键操作**

```
必须记录的事件：
- 用户登录/登出
- 密码修改/重置
- 角色分配/撤销
- 权限变更
- 租户配置变更
- 服务注册/修改
- MFA 启用/禁用
```

**定期审查审计日志**

```bash
# 查询可疑登录
curl "/api/v1/audit-logs?action=login.failed&start_date=2024-01-01" \
  -H "Authorization: Bearer <token>"

# 查询权限变更
curl "/api/v1/audit-logs?action=role.assigned&start_date=2024-01-01" \
  -H "Authorization: Bearer <token>"
```

**设置告警**

```yaml
alerts:
  - name: 多次登录失败
    condition: login.failed > 5 within 5m
    action: notify_admin
  
  - name: 异常权限变更
    condition: role.assigned in non_business_hours
    action: notify_security_team
```

## 性能最佳实践

### 1. 缓存策略

#### ✅ 推荐配置

```bash
# 用户角色缓存 - 5 分钟
CACHE_TTL_USER_ROLES=300

# 服务配置缓存 - 10 分钟
CACHE_TTL_SERVICE_CONFIG=600

# JWKS 公钥缓存 - 1 小时
CACHE_TTL_JWKS=3600
```

**预热缓存**

```bash
# 启动时预热热门数据
curl -X POST /api/v1/admin/warmup-cache \
  -H "Authorization: Bearer <token>"
```

### 2. 数据库优化

#### ✅ 推荐做法

**创建必要的索引**

```sql
-- 用户查询优化
CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_created_at ON users(created_at);

-- 租户查询优化
CREATE INDEX idx_tenant_users_tenant_id ON tenant_users(tenant_id);
CREATE INDEX idx_tenant_users_user_id ON tenant_users(user_id);

-- 审计日志查询优化
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
CREATE INDEX idx_audit_logs_actor_id ON audit_logs(actor_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
```

**定期清理过期数据**

```bash
# 清理 90 天前的审计日志
DELETE FROM audit_logs WHERE created_at < NOW() - INTERVAL 90 DAY;
```

### 3. 连接池配置

#### ✅ 推荐配置

```bash
# 数据库连接池
DB_MAX_CONNECTIONS=20
DB_MIN_CONNECTIONS=5
DB_CONNECT_TIMEOUT=30

# Redis 连接池
REDIS_POOL_SIZE=20
```

### 4. 资源限制

#### ✅ Kubernetes 配置

```yaml
resources:
  requests:
    cpu: 500m
    memory: 512Mi
  limits:
    cpu: 2000m
    memory: 2Gi

# HPA 自动伸缩
---
apiVersion: autoscaling/v2
kind: HorizontalPodAutoscaler
metadata:
  name: auth9-core-hpa
spec:
  scaleTargetRef:
    apiVersion: apps/v1
    kind: Deployment
    name: auth9-core
  minReplicas: 3
  maxReplicas: 10
  metrics:
  - type: Resource
    resource:
      name: cpu
      target:
        type: Utilization
        averageUtilization: 70
  - type: Resource
    resource:
      name: memory
      target:
        type: Utilization
        averageUtilization: 80
```

## 开发最佳实践

### 1. 环境隔离

#### ✅ 推荐做法

**使用不同的配置文件**

```
config/
├── development.toml
├── staging.toml
└── production.toml
```

**使用环境变量**

```bash
# .env.development
ENVIRONMENT=development
LOG_LEVEL=debug
CORS_ALLOWED_ORIGINS=http://localhost:3000

# .env.production
ENVIRONMENT=production
LOG_LEVEL=info
CORS_ALLOWED_ORIGINS=https://portal.example.com
```

### 2. 测试

#### ✅ 推荐做法

**编写单元测试**

```rust
#[cfg(test)]
mod tests {
    use super::*;

    #[tokio::test]
    async fn test_create_tenant() {
        let tenant = create_tenant("Test Corp").await.unwrap();
        assert_eq!(tenant.name, "Test Corp");
    }
}
```

**集成测试**

```rust
#[tokio::test]
async fn test_user_login_flow() {
    // 1. 注册用户
    let user = create_user("test@example.com").await.unwrap();
    
    // 2. 登录
    let token = login("test@example.com", "password").await.unwrap();
    
    // 3. 验证 Token
    let claims = validate_token(&token).await.unwrap();
    assert_eq!(claims.sub, user.id);
}
```

### 3. 错误处理

#### ✅ 推荐做法

```rust
use thiserror::Error;

#[derive(Error, Debug)]
pub enum AuthError {
    #[error("用户不存在: {0}")]
    UserNotFound(String),
    
    #[error("认证失败")]
    Unauthorized,
    
    #[error("权限不足")]
    Forbidden,
    
    #[error("数据库错误: {0}")]
    DatabaseError(#[from] sqlx::Error),
}
```

### 4. 日志记录

#### ✅ 推荐做法

```rust
use tracing::{info, warn, error};

// ✅ 结构化日志
info!(
    user_id = %user.id,
    tenant_id = %tenant.id,
    action = "login",
    "用户登录成功"
);

// ❌ 字符串拼接
println!("User {} logged in to tenant {}", user.id, tenant.id);
```

## 部署最佳实践

### 1. 高可用部署

#### ✅ 推荐配置

```yaml
# 多副本
replicas: 3

# 反亲和性（确保 Pod 分布在不同节点）
affinity:
  podAntiAffinity:
    preferredDuringSchedulingIgnoredDuringExecution:
    - weight: 100
      podAffinityTerm:
        labelSelector:
          matchExpressions:
          - key: app
            operator: In
            values:
            - auth9-core
        topologyKey: kubernetes.io/hostname

# 滚动更新策略
strategy:
  type: RollingUpdate
  rollingUpdate:
    maxSurge: 1
    maxUnavailable: 0

# PodDisruptionBudget
---
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: auth9-core-pdb
spec:
  minAvailable: 2
  selector:
    matchLabels:
      app: auth9-core
```

### 2. 健康检查

#### ✅ 推荐配置

```yaml
livenessProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 30
  periodSeconds: 10
  timeoutSeconds: 5
  failureThreshold: 3

readinessProbe:
  httpGet:
    path: /ready
    port: 8080
  initialDelaySeconds: 10
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 3

startupProbe:
  httpGet:
    path: /health
    port: 8080
  initialDelaySeconds: 0
  periodSeconds: 5
  timeoutSeconds: 3
  failureThreshold: 30
```

### 3. 备份策略

#### ✅ 推荐做法

**定期备份**

```bash
#!/bin/bash
# 每天凌晨 2 点备份

# 数据库备份
mysqldump -h tidb -u root -p auth9 | gzip > /backup/auth9_$(date +%Y%m%d).sql.gz

# Redis 备份（可选）
redis-cli BGSAVE
cp /var/lib/redis/dump.rdb /backup/redis_$(date +%Y%m%d).rdb

# 保留最近 30 天的备份
find /backup -name "auth9_*.sql.gz" -mtime +30 -delete
find /backup -name "redis_*.rdb" -mtime +30 -delete
```

**测试恢复**

```bash
# 每月测试恢复流程
mysql -h tidb-test -u root -p auth9_test < backup_20240101.sql
```

## 监控最佳实践

### 1. 关键指标

#### ✅ 必须监控的指标

```yaml
metrics:
  # 应用指标
  - http_requests_total
  - http_request_duration_seconds
  - http_request_size_bytes
  - http_response_size_bytes
  
  # 数据库指标
  - db_connections_active
  - db_connections_idle
  - db_query_duration_seconds
  
  # 缓存指标
  - cache_hit_ratio
  - cache_operations_total
  
  # 业务指标
  - auth_logins_total
  - auth_login_failures_total
  - token_exchange_duration_seconds
  - active_users_total
```

### 2. 告警规则

#### ✅ 推荐告警

```yaml
groups:
  - name: auth9_alerts
    interval: 30s
    rules:
      # 服务可用性
      - alert: ServiceDown
        expr: up{job="auth9-core"} == 0
        for: 1m
        annotations:
          summary: "Auth9 服务不可用"
      
      # 高错误率
      - alert: HighErrorRate
        expr: rate(http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        annotations:
          summary: "错误率超过 5%"
      
      # 响应延迟
      - alert: HighLatency
        expr: http_request_duration_seconds{quantile="0.99"} > 1
        for: 5m
        annotations:
          summary: "P99 延迟超过 1 秒"
      
      # 数据库连接池耗尽
      - alert: DBPoolExhausted
        expr: db_connections_active / db_connections_max > 0.9
        for: 2m
        annotations:
          summary: "数据库连接池使用率超过 90%"
```

## 迁移最佳实践

### 从其他认证系统迁移

#### ✅ 推荐步骤

1. **评估现有系统**
   - 用户数量
   - 租户结构
   - 权限模型
   - 集成点

2. **制定迁移计划**
   - 分阶段迁移
   - 灰度发布
   - 回滚方案

3. **数据迁移**
   ```bash
   # 导出用户
   # 转换为 Auth9 格式
   # 批量导入
   ```

4. **并行运行**
   - 同时运行新旧系统
   - 逐步切换流量
   - 验证功能

5. **完全切换**
   - 停用旧系统
   - 清理旧数据

## 邮件和品牌最佳实践

### 邮件配置

#### ✅ 推荐做法

**使用专用的 SMTP 服务**

```json
{
  "provider": "smtp",
  "smtp_host": "smtp.sendgrid.net",
  "smtp_port": 587,
  "smtp_from_email": "noreply@yourdomain.com",
  "smtp_from_name": "Your Company",
  "smtp_use_tls": true
}
```

优先选择：
- SendGrid
- Amazon SES
- Mailgun
- 阿里云邮件推送

**使用真实的发件人邮箱**
- 配置 SPF、DKIM、DMARC 记录
- 使用企业域名邮箱
- 避免使用个人邮箱

**自定义邮件模板**
```bash
# 保持品牌一致性
curl -X PUT /api/v1/email-templates/invitation \
  -d '{
    "subject": "欢迎加入 {{company_name}}",
    "html_body": "<div style=\"font-family: sans-serif;\">...</div>"
  }'
```

**测试邮件发送**
```bash
# 配置完成后立即测试
curl -X POST /api/v1/system/email-settings/test \
  -d '{"to_email": "test@yourdomain.com"}'
```

#### ❌ 避免的做法

- 使用 Gmail 等免费邮箱发送大量邮件
- 不配置 DNS 记录
- 使用硬编码的邮件内容
- 不测试邮件发送功能

### 品牌定制

#### ✅ 推荐做法

**使用 CDN 托管图片资源**

```json
{
  "logo_url": "https://cdn.yourdomain.com/assets/logo.png",
  "favicon_url": "https://cdn.yourdomain.com/assets/favicon.ico"
}
```

**优化图片资源**
- Logo: SVG 格式或 PNG（透明背景）
- 大小: < 100KB
- 尺寸: Logo 推荐 200x50px

**使用企业品牌颜色**

```json
{
  "primary_color": "#0066CC",
  "secondary_color": "#003366",
  "background_color": "#F5F5F5",
  "text_color": "#333333"
}
```

**确保颜色对比度**
- 文字和背景对比度 >= 4.5:1 (WCAG AA)
- 使用工具验证: https://webaim.org/resources/contrastchecker/

**测试自定义 CSS**

```json
{
  "custom_css": "
    .login-page { 
      font-family: 'PingFang SC', 'Microsoft YaHei', sans-serif; 
    }
    .btn-primary { 
      border-radius: 8px; 
    }
  "
}
```

#### ❌ 避免的做法

- 使用本地文件路径
- 上传超大图片
- 使用过低对比度的颜色组合
- 使用过多的自定义 CSS
- 不测试不同浏览器的兼容性

### 邀请系统

#### ✅ 推荐做法

**设置合理的邀请过期时间**

```bash
# 7 天过期
curl -X POST /api/v1/tenants/{tenant_id}/invitations \
  -d '{
    "email": "newuser@example.com",
    "role_ids": ["viewer-role"],
    "expires_in_days": 7
  }'
```

**批量邀请用户**

```bash
# 创建脚本批量邀请
#!/bin/bash
for email in $(cat users.txt); do
  curl -X POST /api/v1/tenants/{tenant_id}/invitations \
    -d "{\"email\": \"$email\", \"role_ids\": [\"role-uuid\"]}"
  sleep 1
done
```

**跟踪邀请状态**

```bash
# 定期检查待处理的邀请
curl /api/v1/tenants/{tenant_id}/invitations?status=pending
```

**及时清理过期邀请**

```bash
# 每周清理
curl -X POST /api/v1/admin/cleanup-expired-invitations
```

#### ❌ 避免的做法

- 设置过长的过期时间（> 30天）
- 不验证邮箱地址格式
- 不跟踪邀请状态
- 允许重复邀请同一邮箱

## 相关文档

- [快速开始](快速开始.md)
- [架构设计](架构设计.md)
- [配置说明](配置说明.md)
- [性能优化](性能优化.md)
- [故障排查](故障排查.md)
