#!/usr/bin/env node
import { Auth9Client } from '@auth9/core';

const SERVICE_ID = "5eadeb71-039e-45b1-9184-657a365b5794";
const TENANT_ID = "3427371a-b594-4d47-9c67-d876cab0522b";

const serviceToken = process.env.SERVICE_TOKEN || "";
const apiKey = process.env.AUTH9_API_KEY || serviceToken;

if (!apiKey) {
  console.error("Please set SERVICE_TOKEN or AUTH9_API_KEY environment variable");
  process.exit(1);
}

const client = new Auth9Client({
  baseUrl: 'http://localhost:8080',
  apiKey: apiKey,
  serviceId: SERVICE_ID,
  tenantId: TENANT_ID,
});

console.log("=== Scenario 6: SDK - Log Query ===\n");

try {
  const action = await client.actions.create({
    name: 'Logging Test',
    trigger_id: 'post-login',
    script: 'context;',
  });
  console.log("Created action:", action.id);

  await client.actions.test(action.id, {
    user: { id: '1', email: 'test@example.com', mfa_enabled: false },
    tenant: { id: TENANT_ID, slug: 'demo', name: 'Demo' },
    request: { timestamp: new Date().toISOString() },
  });

  const logs = await client.actions.logs({
    action_id: action.id,
    limit: 10,
  });

  console.log("Total logs:", logs.length);
  if (logs.length > 0) {
    console.log("Latest log:", JSON.stringify(logs[0], null, 2));
  }
  console.log("✅ Scenario 6 PASS\n");
} catch (error) {
  console.error("❌ Scenario 6 FAIL:", error.message);
  console.log("");
}

console.log("=== Scenario 7: SDK - Stats Query ===\n");

try {
  const action = await client.actions.create({
    name: 'Stats Test',
    trigger_id: 'post-login',
    script: 'context;',
  });

  for (let i = 0; i < 10; i++) {
    await client.actions.test(action.id, {
      user: { id: '1', email: 'test@example.com', mfa_enabled: false },
      tenant: { id: TENANT_ID, slug: 'demo', name: 'Demo' },
      request: { timestamp: new Date().toISOString() },
    });
  }

  const stats = await client.actions.stats(action.id);
  console.log("Execution count:", stats.execution_count);
  console.log("Success rate:", stats.success_rate);
  console.log("Avg duration:", stats.avg_duration_ms);
  console.log("Last 24h:", stats.last_24h_count);
  console.log("✅ Scenario 7 PASS\n");
} catch (error) {
  console.error("❌ Scenario 7 FAIL:", error.message);
  console.log("");
}

console.log("=== Scenario 8: Error Handling - SDK ===\n");

try {
  const invalidClient = new Auth9Client({
    baseUrl: 'http://localhost:8080',
    apiKey: 'invalid-token', // pragma: allowlist secret
    serviceId: SERVICE_ID,
  });

  try {
    await invalidClient.actions.list();
  } catch (error) {
    console.log("Authentication error caught:", error.message);
  }
  console.log("✅ Scenario 8 PASS\n");
} catch (error) {
  console.error("❌ Scenario 8 FAIL:", error.message);
  console.log("");
}

console.log("=== Scenario 9: Concurrent Requests ===\n");

try {
  const start = Date.now();
  const promises = Array.from({ length: 20 }, (_, i) =>
    client.actions.create({
      name: `Concurrent Action ${i}`,
      trigger_id: 'post-login',
      script: 'context;',
    })
  );

  const results = await Promise.all(promises);
  const duration = Date.now() - start;

  console.log("Created:", results.length);
  console.log("Total time:", duration, "ms");
  console.log("Avg time per request:", (duration / results.length).toFixed(2), "ms");
  
  if (duration < 2000) {
    console.log("✅ Scenario 9 PASS\n");
  } else {
    console.log("❌ Scenario 9 FAIL: Duration exceeds 2000ms\n");
  }
} catch (error) {
  console.error("❌ Scenario 9 FAIL:", error.message);
  console.log("");
}

console.log("=== Scenario 10: AI Agent Integration ===\n");

try {
  const serviceName = 'service-x';

  const existingActions = await client.actions.list('post-login');
  const existingRule = existingActions.find(a => a.name === `${serviceName}-access-control`);

  if (existingRule) {
    console.log("Rule already exists, updating...");
    await client.actions.update(existingRule.id, {
      script: generateAccessControlScript(serviceName),
    });
  } else {
    console.log("Creating new rule...");
    await client.actions.create({
      name: `${serviceName}-access-control`,
      description: `Auto-generated by AI Agent for ${serviceName}`,
      trigger_id: 'post-login',
      script: generateAccessControlScript(serviceName),
      enabled: true,
    });
  }

  const action = (await client.actions.list('post-login')).find(
    a => a.name === `${serviceName}-access-control`
  );

  if (!action) {
    throw new Error("Action not found after creation");
  }

  const testResult = await client.actions.test(action.id, {
    user: {
      id: 'test-user',
      email: 'admin@company.com',
      mfa_enabled: false,
    },
    tenant: {
      id: TENANT_ID,
      slug: 'demo',
      name: 'Demo',
    },
    request: {
      timestamp: new Date().toISOString(),
    },
    claims: {
      roles: ['developer'],
    },
  });

  console.log("Test result:", testResult.success);
  console.log("Service access granted:", testResult.modified_context?.claims?.service_access);
  console.log("✅ Scenario 10 PASS\n");
} catch (error) {
  console.error("❌ Scenario 10 FAIL:", error.message);
  console.log("");
}

function generateAccessControlScript(serviceName) {
  return `
const allowedRoles = ["admin", "developer"];
const userRoles = (context.claims?.roles) || [];

const hasAccess = allowedRoles.some(role => userRoles.includes(role));

if (!hasAccess) {
  throw new Error("Insufficient permissions for ${serviceName}");
}

context.claims = context.claims || {};
context.claims.service_access = context.claims.service_access || [];
context.claims.service_access.push("${serviceName}");

context;
  `.trim();
}
